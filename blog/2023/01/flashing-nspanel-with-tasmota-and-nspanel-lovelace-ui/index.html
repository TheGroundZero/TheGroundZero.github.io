<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="DezeStijn"><meta name=description content="We&rsquo;re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta name=keywords content="Sequr,blog,writeup,CTF,challenge,machine,infosec,IT security,hacking,pentesting,cybersecurity,Home Automation,Home Assistant,NSPanel,Tasmota,Lovelace,Sonoff"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/><title>Flashing NSPanel with Tasmota and NSPanel Lovelace UI :: Sequr
</title><link rel=stylesheet href=https://sequr.be/main.min.244183cde1a38e0b08f82c11791181288f9aac1cc9618cd6f4e9e7710c5768ba.css integrity="sha256-JEGDzeGjjgsI+CwReRGBKI+arBzJYYzW9OnncQxXaLo=" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://sequr.be/css/table.css><link rel=stylesheet type=text/css href=https://sequr.be/css/menu.css><link rel=stylesheet type=text/css href=https://sequr.be/css/background.css><link rel=apple-touch-icon sizes=180x180 href=https://sequr.be/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sequr.be/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sequr.be/favicon-16x16.png><link rel=manifest href=https://sequr.be/site.webmanifest><link rel=mask-icon href=https://sequr.be/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://sequr.be/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta itemprop=description content="We’re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta itemprop=datePublished content="2023-01-14T00:00:00+00:00"><meta itemprop=dateModified content="2023-01-14T00:00:00+00:00"><meta itemprop=wordCount content="2416"><meta itemprop=image content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,NSPanel,Tasmota,Lovelace,Sonoff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/cover.png"><meta name=twitter:title content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta name=twitter:description content="We’re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta property="article:section" content="Home Automation"><meta property="article:published_time" content="2023-01-14 00:00:00 +0000 UTC"><link rel=webmention href=https://webmention.io/sequr.be/webmention></head><body><div class=container><header class=header><span class=header__inner><a href=https://sequr.be/ style=text-decoration:none><div class=logo><span class=logo__mark>$</span>
<span class=logo__text>lynx sequr.be</span>
<span class=logo__cursor style=background-color:#e68101></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sequr.be/about/>About</a></li><li><a href=https://sequr.be/blog/>Blog</a></li><li><a href=https://sequr.be/privacy/>Privacy</a></li><li><a href=https://sequr.be/shoppinglist/>Shopping</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class="post h-entry"><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
12 minutes</p></div><article><h1 class="post-title p-name"><a href=https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/ class=u-url>Flashing NSPanel with Tasmota and NSPanel Lovelace UI</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#preparations>Preparations</a><ul><li><a href=#get-home-assistant-long-lived-access-token>Get Home Assistant Long-Lived Access Token</a></li><li><a href=#create-mqtt-users>Create MQTT user(s)</a></li></ul></li><li><a href=#appdaemon-installation-and-configuration>AppDaemon installation and configuration</a><ul><li><a href=#podman-configuration>Podman configuration</a></li><li><a href=#install-babel-dependency>Install Babel dependency</a></li><li><a href=#appdaemon-app-configuration>AppDaemon app configuration</a></li><li><a href=#start-the-container>Start the container</a></li><li><a href=#minimal-nspanel-config>Minimal NSPanel config</a></li></ul></li><li><a href=#install-lovelace-appdaemon-backend>Install Lovelace AppDaemon Backend</a><ul><li><a href=#enable-appdeamon-automations-in-hacs>Enable AppDeamon automations in HACS</a></li></ul></li><li><a href=#flash-tasmota-on-nspanel>Flash Tasmota on NSPanel</a><ul><li><a href=#serial-connection-to-the-nspanel>Serial connection to the NSPanel</a></li><li><a href=#flash-tasmota>Flash Tasmota</a></li><li><a href=#connect-nspanel-to-your-wifi>Connect NSPanel to your WiFi</a></li></ul></li><li><a href=#configure-tasmota-for-nspanel>Configure Tasmota for NSPanel</a><ul><li><a href=#nspanel-template>NSPanel template</a></li><li><a href=#berry-driver>Berry Driver</a><ul><li><a href=#console>Console</a></li><li><a href=#manually>Manually</a></li></ul></li><li><a href=#flash-the-firmware>Flash the firmware</a></li><li><a href=#set-up-mqtt-in-tasmota>Set up MQTT in Tasmota</a></li></ul></li><li><a href=#configure-views-in-nspanel-lovelace-ui>Configure views in NSPanel Lovelace UI</a></li><li><a href=#mount-the-nspanel>Mount the NSPanel</a></li><li><a href=#upgrading-nspanel>Upgrading NSPanel</a></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#tft-not-downloading>TFT not downloading</a></li><li><a href=#date-on-screensaver-doesnt-match-my-config>Date on screensaver doesn&rsquo;t match my config</a></li></ul></li></ul></nav></aside><hr><div class="post-content e-content"><h2 id=intro>Intro <a href=#intro>¶</a></h2><p>The <a href=https://sonoff.tech/product/central-control-panel/nspanel/ title="Sonoff NSPanel" target=_blank rel=noopener>Sonoff NSPanel</a> is a fancy little combination of a dual-gang switch and a control panel.
Out of the box it allows for a lot of customisation via the eWeLink App, giving you control of more than just the 2 devices you connect to its relays.</p><p>However, since we &ndash; as Home Assistant enthusiasts &ndash; prefer to manage our own device and not be dependant on a 3rd party app, we&rsquo;re going to flash the NSPanel with Tasmota :)
Note that ESPHome is also an option, since the NSPanel is equiped with an ESP32. I might do a blog post about that as well some day.</p><p>Luckily, Blakadder has done a terrific job of <a href=https://blakadder.com/nspanel-teardown/ title="Blakadder NSPanel Teardown" target=_blank rel=noopener>tearing down</a> the insides of the NSPanel and identifying the ESP32 chip and pins needed to flash the device.
He has also laid the foundation for flashing Tasmota on the NSPanel, which projects like <a href=https://github.com/joBr99/nspanel-lovelace-ui title="NSPanel Lovelace UI" target=_blank rel=noopener>NSPanel Lovelace UI</a> have built further upon.</p><p>In this blog post, I&rsquo;ll discuss my experiences with installing NSPanel Lovelace UI on my NSPanel.
This will also include installing AppDaemon in Docker using docker-compose since I&rsquo;m running <a href=https://sequr.be/categories/ha-container/ title="HA Container series">HA Container</a>.</p><p>Since I switched to using Podman in <a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ title="Home Assistant Container Part 12: Migrating to Podman">Part 12 of the Home Assistant Container series</a>, I&rsquo;ll be sharing my Podman config instead of the Docker-compose config you can find in the NSPanel Lovelace docs.</p><h2 id=preparations>Preparations <a href=#preparations>¶</a></h2><h3 id=get-home-assistant-long-lived-access-token>Get Home Assistant Long-Lived Access Token <a href=#get-home-assistant-long-lived-access-token>¶</a></h3><p>The AppDaemon container will connect to our Home Assistant instance.
To authenticate, it will need a <a href=https://www.home-assistant.io/docs/authentication/ title="Authentication on Home Assistant docs" target=_blank rel=noopener>Long-Lived Access Tokens</a>.</p><ul><li>Login on Home Assistant as the user AppDaemon will authenticate as</li><li>Click on your username at the bottom-left</li><li>Scroll to the bottom, where you&rsquo;ll find the &ldquo;Long-Lived Access Tokens&rdquo; section</li><li>Create a new token, give it a name, and copy the generated token (it will only be displayed once!)</li></ul><figure class=center><img src=ha-llat.png alt="Long-Lived Access Tokens in Home Assistant"><figcaption class=center>Long-Lived Access Token</figcaption></figure><p>Keep this token in a txt file or in your password manager, you&rsquo;ll need it later!</p><h3 id=create-mqtt-users>Create MQTT user(s) <a href=#create-mqtt-users>¶</a></h3><p>In <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/ title="Home Assistant Container Part 4: Mosquitto Docker Container">part 4</a> of our HA Container series we set up the Mosquitto MQTT broker and created and account for Home Assistant.</p><p>We&rsquo;ll add 2 more accounts: 1 for AppDaemon and 1 for Tasmota devices.
Make sure you write down the passwords somewhere.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser appdaemon_mqtt
</span></span><span style=display:flex><span><span style=color:#75715e># Enter password</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Repeat password</span>
</span></span><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser tasmota_mqtt
</span></span><span style=display:flex><span><span style=color:#75715e># Enter password</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Repeat password</span>
</span></span></code></pre></div><p>Swap <code>podman</code> for <code>docker</code> in the commands above if necessary.</p><p><strong>!</strong> If you&rsquo;re copying the command from the Mosquitto blog post, make sure you drop the <code>-c</code> parameter as that will wipe out any existing accounts.</p><h2 id=appdaemon-installation-and-configuration>AppDaemon installation and configuration <a href=#appdaemon-installation-and-configuration>¶</a></h2><p>This could be an additional post in the <a href=https://sequr.be/categories/ha-container/ title="HA Container series">HA Container series</a> as this point, as it&rsquo;s sort of a repetition of what we&rsquo;ve done multiple times before.</p><h3 id=podman-configuration>Podman configuration <a href=#podman-configuration>¶</a></h3><p>Have a look at <a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ title="Home Assistant Container Part 12: Migrating to Podman">HA Container Series pt12</a> if you want to learn more about the config below.</p><p>It&rsquo;s of the utmost importance you mount the AppDeamon <code>config</code> folder <strong>inside the HA config folder</strong>!
This does mean the HA config volume needs to be labeled with a lowercase <code>:z</code> (in the HA container and the AppDaemon config) to indicate this volume is shared.</p><p><code>~/.config/systemd/user/container-appdaemon.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>AppDaemon</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>appdaemon-secrets</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>appdaemon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#e6db74>&#34;Europe/Brussels&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>HA_URL</span>=<span style=color:#e6db74>&#34;!secret ha_url&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>TOKEN</span>=<span style=color:#e6db74>&#34;!secret ha_token&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>DASH_URL</span>=<span style=color:#e6db74>&#34;!secret dash_url&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>appdaemon-secrets</span>,<span style=color:#a6e22e>target</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secrets</span>.<span style=color:#a6e22e>yaml</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>5050</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>5050</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>acockburn</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>appdaemon-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p><code>/srv/hass/secret/appdaemon-secrets</code></p><pre tabindex=0><code>ha_url: http://10.0.2.2:8123
ha_token: &#34;&lt;Long-Lived Access Token&gt;&#34;
mqtt_host: 10.0.2.2
mqtt_user: appdaemon_mqtt
mqtt_pass: &lt;appdaemon_mqtt password&gt;
dash_url: http://&lt;ip.of.our.box&gt;:5050
</code></pre><p>Don&rsquo;t forget to create the directory for the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/hass/appdaemon
</span></span></code></pre></div><p>Don&rsquo;t start the container just yet, we want to make a few more changes to the AppDaemon config first.</p><h3 id=install-babel-dependency>Install Babel dependency <a href=#install-babel-dependency>¶</a></h3><p><a href=https://babel.pocoo.org/en/latest/ title="Babel documentation" target=_blank rel=noopener>Babel</a> is used by AppDaemon for localization (e.g. date formats).</p><p>We can add this as a Python dependency by adding it to our <code>requirements.txt</code>.
This file most likely doesn&rsquo;t exist yet and must be created inside the container&rsquo;s <code>/conf</code> folder.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Babel&#34;</span> &gt;&gt; /srv/hass/hass/appdaemon/requirements.txt
</span></span></code></pre></div><p>If you had already started the container, a restart of the container will ensure the dependency is discovered and installed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user restart container-appdaemon.service
</span></span></code></pre></div><h3 id=appdaemon-app-configuration>AppDaemon app configuration <a href=#appdaemon-app-configuration>¶</a></h3><p>The main configuration for AppDaemon is located at <code>/srv/hass/hass/appdaemon/appdaemon.yaml</code> or the appdeamon folder inside the HA container.</p><p>Copy/paste this config there to ensure MQTT is set up and our secrets from earlier are being used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>secrets</span>: <span style=color:#ae81ff>/conf/secrets.yaml </span> <span style=color:#75715e># IMPORTANT! Otherwise !secret won&#39;t work</span>
</span></span><span style=display:flex><span><span style=color:#f92672>appdaemon</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>latitude</span>: <span style=color:#75715e>##.##########</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>longitude</span>: <span style=color:#75715e>##.##########</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>elevation</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>time_zone</span>: !<span style=color:#ae81ff>env_var TZ</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>HASS</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>hass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ha_url</span>: !<span style=color:#ae81ff>secret ha_url</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>token</span>: !<span style=color:#ae81ff>secret ha_token</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>MQTT</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>mqtt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>mqtt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;appdaemon&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_host</span>: !<span style=color:#ae81ff>secret mqtt_host</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_port</span>: <span style=color:#ae81ff>1883</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_user</span>: !<span style=color:#ae81ff>secret mqtt_user</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_password</span>: !<span style=color:#ae81ff>secret mqtt_pass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_topics</span>: <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: !<span style=color:#ae81ff>secret dash_url</span>
</span></span><span style=display:flex><span><span style=color:#f92672>admin</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>hadashboard</span>:
</span></span></code></pre></div><h3 id=start-the-container>Start the container <a href=#start-the-container>¶</a></h3><p>Enable the service to start the container at boot, and start it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-appdaemon.service
</span></span></code></pre></div><p>After running the command, the container image will be pulled and the container will be started.
The AppDaemon dashboard will be available at <code>http://&lt;ip.of.our.box>:5050</code>.
Some default configurations will be added to the <code>/conf</code> folder inside the container as well.</p><h3 id=minimal-nspanel-config>Minimal NSPanel config <a href=#minimal-nspanel-config>¶</a></h3><p>The configuration for the NSPanel is stored in an AppDeamon app.</p><p>Below is a minimal config to get started.
Store this config in <code>/srv/hass/hass/appdaemon/apps/apps.yaml</code>. Delete the hello-world app if it&rsquo;s present.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-1</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>nspanel-lovelace-ui</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>class</span>: <span style=color:#ae81ff>NsPanelLovelaceUIManager</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelRecvTopic</span>: <span style=color:#e6db74>&#34;tele/tasmota_&lt;your_mqtt_topic&gt;/RESULT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelSendTopic</span>: <span style=color:#e6db74>&#34;cmnd/tasmota_&lt;your_mqtt_topic&gt;/CustomSend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>model</span>: <span style=color:#ae81ff>eu</span>
</span></span></code></pre></div><p>Modify <code>&lt;your_mqtt_topic></code> to something specific for your NSPanel and keep note as we&rsquo;ll need it later.</p><p>You can add multiple configs for multiple NSPanels.
Make sure you use unique MQTT topics for each.</p><h2 id=install-lovelace-appdaemon-backend>Install Lovelace AppDaemon Backend <a href=#install-lovelace-appdaemon-backend>¶</a></h2><h3 id=enable-appdeamon-automations-in-hacs>Enable AppDeamon automations in HACS <a href=#enable-appdeamon-automations-in-hacs>¶</a></h3><p>Next, we&rsquo;ll install the Lovelace AppDaemon Backend application in Home Assistant.
We&rsquo;ll install this from <a href=https://hacs.xyz/ title="HACS - Home Assistant Community Store" target=_blank rel=noopener>HACS</a>.</p><p>We&rsquo;ll assume you already have HACS installed.
This blog post won&rsquo;t go into details on how to install HACS.</p><ol><li>Go to <code>Settings</code> > <code>Devices & Services</code> in Home Assistant.</li><li>Press the <code>Configure</code> button under the HACS integration.</li><li>Ensure <code>Enable AppDaemon apps discovery & tracking</code> is selected.</li></ol><figure class=center><img src=hacs-automations.png alt="Enable 'Enable AppDaemon apps discovery & tracking&#39; in HACS config"><figcaption class=center>Enable AppDaemon apps discovery & tracking</figcaption></figure><ol><li>Open the <code>HACS</code> store.</li><li>Go to the <code>Automations</code> section.</li><li>Click <code>Explore & download repositories</code>.</li><li>Search for <code>NSPanel Lovelace UI Backend</code>.</li><li>Download the repository.</li></ol><figure class=center><img src=hacs-nspanel.png alt="Download the 'NSPanel Lovelace UI Backend' repository"><figcaption class=center>NSPanel Lovelace UI Backend</figcaption></figure><h2 id=flash-tasmota-on-nspanel>Flash Tasmota on NSPanel <a href=#flash-tasmota-on-nspanel>¶</a></h2><p>Finally we&rsquo;ll flash Tasmota on the NSPanel.</p><p>You&rsquo;ll need to disassemble the NSPanel using a flathead screwdriver or a prying tool and a small Philips head screwdriver.
The <a href=https://s.click.aliexpress.com/e/_Dd6aqNt title="Wowstick Mini Precision Electric Screwdriver" target=_blank rel=noopener>Wowstick</a> comes in handy here.</p><p>You can check how to open the Touch Plate and what the pinout of the PCB is in <a href=https://blakadder.com/nspanel-teardown/ title="Blakadder NSPanel Teardown" target=_blank rel=noopener>Blakadder&rsquo;s teardown</a>.</p><figure class=center><img src=nspanel-pinout.jpg alt="NSPanel pinout"><figcaption class=center>Pinout of the NSPanel</figcaption></figure><h3 id=serial-connection-to-the-nspanel>Serial connection to the NSPanel <a href=#serial-connection-to-the-nspanel>¶</a></h3><ol><li>Set your <a href=https://www.aliexpress.com/item/32650148276.html title="FT232RL FTDI USB 3.3V 5.5V to TTL Serial Adapter Module" target=_blank rel=noopener>serial adapter</a> to 3.3V</li><li>Connect it to the GND, ESP_RX, ESP_TX, and 3V3 pins on the PCB (marked yellow in the picture above).<br>Make sure you cross RX-TX between the NSPanel and the FTDI.</li><li>Grab a <a href=https://s.click.aliexpress.com/e/_A9gQql title="Dupont wires - male-male, male-female, female-female - 10cm" target=_blank rel=noopener>Dupont wire</a> and connect it between the IO0 and one of the GND pins at the right (next to the 5V pins) to force the NSPanel to boot in flash mode.</li><li>While putting some pressure on the Dupont wires to ensure a good connection, connect the FTDI to your computer.</li></ol><figure class=center><img src=nspanel-ftdi.png alt="Picture of FTDI connected to the NSPanel"><figcaption class=center>Connect FTDI to NSPanel</figcaption></figure><h3 id=flash-tasmota>Flash Tasmota <a href=#flash-tasmota>¶</a></h3><ol><li>Open the <a href=https://tasmota.github.io/install/ title="Tasmota Web Installer" target=_blank rel=noopener>Tasmota Web Installer</a> in Chrome or Edge as the browser needs to be able to connect to your serial device.</li><li>Select <code>Tasmota32 Sonoff-NSPanel (english)</code>.</li><li>Press <code>Connect</code>.</li><li>In the pop-up, select your serial device.</li><li>Flash Tasmota.</li></ol><figure class=center><img src=tasmota-installer.png alt="Tasmota Web Installer"><figcaption class=center>Tasmota Web Installer</figcaption></figure><h3 id=connect-nspanel-to-your-wifi>Connect NSPanel to your WiFi <a href=#connect-nspanel-to-your-wifi>¶</a></h3><p>You can connect the NSPanel with your WiFi via the captive portal that is now active on the NSPanel or via the Web Installer.</p><ol><li>Disconnect the FTDI from the NSPanel</li><li>Set the FTDI to 5V</li><li>Connect GND and VCC on the FTDI to 5V and GND on the NSPanel (marked red in the pinout above)</li><li>Connect RX and TX on the FTDI to ESP_TX and ESP_TX on the NSPanel (marked yellow)</li><li>Do NOT connected GPIO0 to GND!</li><li>In the Tasmota Web Installer, reconnect to your device</li><li>Select the option to connect to WiFi</li><li>Pick the correct SSID and enter the password</li></ol><h2 id=configure-tasmota-for-nspanel>Configure Tasmota for NSPanel <a href=#configure-tasmota-for-nspanel>¶</a></h2><p>The final configuration of the NSPanel is done via the Tasmota Web UI.
Check in your router&rsquo;s DHCP table which IP the NSPanel has.</p><p>You can also assemble the NSPanel again and power it from mains as we won&rsquo;t need access to the PCB anymore.</p><h3 id=nspanel-template>NSPanel template <a href=#nspanel-template>¶</a></h3><ol><li>Go to <code>Configuration</code></li><li>Pick <code>Configure Other</code></li><li>Paste the following template in the input field:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;NAME&#34;</span>:<span style=color:#e6db74>&#34;NSPanel&#34;</span>,<span style=color:#f92672>&#34;GPIO&#34;</span>:[<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>3872</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>32</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>225</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>480</span>,<span style=color:#ae81ff>224</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>33</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>4736</span>,<span style=color:#ae81ff>0</span>],<span style=color:#f92672>&#34;FLAG&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;BASE&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;CMND&#34;</span>:<span style=color:#e6db74>&#34;ADCParam1 2,11200,10000,3950 | Sleep 0 | BuzzerPWM 1&#34;</span>}
</span></span></code></pre></div></li><li>Tick the <code>Activate</code> checkbox</li><li>Save</li></ol><p>The NSPanel will now reboot and the main screen will display 2 toggles for the relays and the read-out of the temperature sensor.</p><h3 id=berry-driver>Berry Driver <a href=#berry-driver>¶</a></h3><h4 id=console>Console <a href=#console>¶</a></h4><p>Execute the following command in the Tasmota Console to download the Berry Driver and reboot the device:</p><pre tabindex=0><code>Backlog UrlFetch https://raw.githubusercontent.com/joBr99/nspanel-lovelace-ui/main/tasmota/autoexec.be; Restart 1
</code></pre><h4 id=manually>Manually <a href=#manually>¶</a></h4><ol><li>Download the <a href=https://raw.githubusercontent.com/joBr99/nspanel-lovelace-ui/main/tasmota/autoexec.be title="Berry Driver autoexec.be" target=_blank rel=noopener>Berry Driver</a> from the NSPanel Lovelace UI repository and save as <code>autoexec.be</code>.</li><li>On the Tasmota Web UI go to <code>Consoles</code> > <code>Manage File System</code>.</li><li>Upload the <code>autoexec.be</code> you just downloaded.</li><li>Reboot the NSPanel</li></ol><h3 id=flash-the-firmware>Flash the firmware <a href=#flash-the-firmware>¶</a></h3><ol><li>Go to <code>Consoles</code> > <code>Console</code>.</li><li>Paste the following command in the input field and press Return to run it:<pre tabindex=0><code>FlashNextion http://nspanel.pky.eu/lui-release.tft
</code></pre></li></ol><p>The NSPanel should now display a loadscreen showing it&rsquo;s downloading and flashing the TFT.
This will also be reflected in the Logs.</p><pre tabindex=0><code>22:34:43.031 CMD: FlashNextion http://nspanel.pky.eu/lui-release.tft
22:34:43.042 RSL: RESULT = {&#34;FlashNextion&#34;:&#34;Done&#34;}
22:34:43.082 FLH: host: nspanel.pky.eu, port: 80, get: /lui-release.tft
22:34:44.467 FLH: Something has gone wrong flashing display firmware [bytes(&#39;1AFFFFFF&#39;)]
22:34:44.569 FLH: Send (High Speed) flash start
22:34:44.974 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 0, &#34;time_elapsed&#34;: 0}}
22:34:48.522 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 1, &#34;time_elapsed&#34;: 3}}
22:34:51.460 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 2, &#34;time_elapsed&#34;: 6}}
22:34:54.398 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 3, &#34;time_elapsed&#34;: 9}}
22:34:57.341 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 4, &#34;time_elapsed&#34;: 12}}
22:35:00.594 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 5, &#34;time_elapsed&#34;: 16}}
22:35:03.532 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 6, &#34;time_elapsed&#34;: 18}}
22:35:06.460 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 7, &#34;time_elapsed&#34;: 21}}
22:35:09.393 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 8, &#34;time_elapsed&#34;: 24}}
22:35:12.364 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 9, &#34;time_elapsed&#34;: 27}}
22:35:15.593 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 10, &#34;time_elapsed&#34;: 31}}
</code></pre><p>If your NSPanel doesn&rsquo;t have a (reliable) connection to the internet,
you can download the <code>lui-release.tft</code> locally and use your own webserver, like the one from Home Assistant.</p><ol><li>Download <a href=http://nspanel.pky.eu/lui-release.tft target=_blank rel=noopener>http://nspanel.pky.eu/lui-release.tft</a></li><li>Copy this file to <code>/srv/hass/hass/www/</code> (the <code>www</code> folder in Home Assistant)</li><li>Run the same command, but referring to Home Assitant:<br><code>FlashNextion http://&lt;ip.of.you.ha>:8123/local/lui-release.tft</code></li></ol><h3 id=set-up-mqtt-in-tasmota>Set up MQTT in Tasmota <a href=#set-up-mqtt-in-tasmota>¶</a></h3><p>Via the Tasmota Web UI, set up MQTT:</p><ol><li>Go to <code>Configuration</code></li><li>Go to <code>Configure MQTT</code></li><li>Enter your MQTT information, such as the host, client and password, and topic<br>Do NOT modify the Full Topic (<code>%prefix%/%topic%/</code>)</li></ol><figure class=center><img src=tasmota-mqtt.png alt="Tasmota MQTT config"><figcaption class=center>Tasmota MQTT config</figcaption></figure><h2 id=configure-views-in-nspanel-lovelace-ui>Configure views in NSPanel Lovelace UI <a href=#configure-views-in-nspanel-lovelace-ui>¶</a></h2><p>Now we can start setting up our Lovelace dashboards for the NSPanel.</p><p>To modify the views, make changes to the <code>apps.yaml</code> file.
Each <code>card</code> is a view/page/dashboard between which you can scroll.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-bureau</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>nspanel-lovelace-ui</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>class</span>: <span style=color:#ae81ff>NsPanelLovelaceUIManager</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelRecvTopic</span>: <span style=color:#e6db74>&#34;tele/tasmota_&lt;your_mqtt_topic&gt;/RESULT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelSendTopic</span>: <span style=color:#e6db74>&#34;cmnd/tasmota_&lt;your_mqtt_topic&gt;/CustomSend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>updateMode</span>: <span style=color:#e6db74>&#34;auto-notify&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>model</span>: <span style=color:#ae81ff>eu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>screenBrightness</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sleepBrightness</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>time</span>: <span style=color:#e6db74>&#34;8:45:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>time</span>: <span style=color:#e6db74>&#34;18:15:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sleepOverride</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.desk</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>brightness</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>screensaver</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>weather.forecast_home</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>theme</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>autoWeather</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cards</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardThermo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>climate.trv_office</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardThermo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Living Room</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>climate.resideo_thermostat</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardEntities</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entities</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.office</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.desk</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>input_boolean.in_call</span>
</span></span></code></pre></div><p>Check the <a href=https://docs.nspanel.pky.eu/config-overview/ title="NSPanel Lovelace UI documentation" target=_blank rel=noopener>documentation</a> for more info.</p><h2 id=mount-the-nspanel>Mount the NSPanel <a href=#mount-the-nspanel>¶</a></h2><p>When you&rsquo;re certain your desk setup is working, it&rsquo;s time to mount the NSPanel to its final location.
In my case, I decided to swap the light switch of my office for the NSPanel.</p><p>First, I had to remove the old wall-box as it was too small and didn&rsquo;t support screw-installation faceplates.
Once that was done, I could wire up the NSPanel, which was really easy to do.</p><p>Connect the Live wire that used to go to the switch, to the L terminal.
Neutral goes to N.
The switched Live from the light went to the S2 terminal in my case, as that matches the right-side button which made most sense in my setup.</p><p>I didn&rsquo;t have a 2nd light to connect to the other relais output, but I&rsquo;m planning to use that button as a trigger for an automation.</p><figure class=center><img src=cover.png alt="NSPanel installed on the wall, showing the weather screensaver"><figcaption class=center>NSPanel installed on the wall</figcaption></figure><p>Yes, the protective cover is still on the screen (:</p><h2 id=upgrading-nspanel>Upgrading NSPanel <a href=#upgrading-nspanel>¶</a></h2><p>Every now and then an update for NSPanel Lovelace UI becomes available through HACS.</p><p>After installing that update, you&rsquo;ll need to restart the AppDeamon container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user restart container-appdaemon.service
</span></span></code></pre></div><p>Your NSPanel will shortly after that restart notify you an update is available for it and will ask you whether you want to install it.
Of course you should click <em>Yes</em> there!</p><p>Clicking <em>Yes</em> will download and flash the latest TFT onto the NSPanel.</p><p>IF your NSPanel can&rsquo;t access the internet, or the flashing doesn&rsquo;t seem to work for some reason,
have a look at <a href=#flash-the-firmware title="Flash the firmware">Flash the firmware</a> on how to do it from a local webserver.</p><h2 id=troubleshooting>Troubleshooting <a href=#troubleshooting>¶</a></h2><p>Here are some issues I encountered while flashing my NSPanel so I thought it&rsquo;d be a good idea to share this info with you.</p><h3 id=tft-not-downloading>TFT not downloading <a href=#tft-not-downloading>¶</a></h3><p>If you don&rsquo;t see the TFT being downloaded when running the <code>FlashNextion</code> command, it can help to reflash Tasmota.</p><ol><li>Go to <code>Firmware Upgrade</code> in the Tasmota web portal.</li><li>Enter the following OTA URL: <code>http://ota.tasmota.com/tasmota32/release/tasmota32-nspanel.bin</code>.</li><li>Press <code>Start Upgrade</code>.</li><li>Wait about 5 minutes until the firmware reinstall is finished.</li></ol><p>Once the reinstall is finished, repeat the steps from the <a href=#configure-tasmota-for-nspanel title="Configure Tasmota for NSPanel">Configure Tasmota for NSPanel</a> section.</p><h3 id=date-on-screensaver-doesnt-match-my-config>Date on screensaver doesn&rsquo;t match my config <a href=#date-on-screensaver-doesnt-match-my-config>¶</a></h3><p>If you&rsquo;re using <code>dateFormatBabel</code> and/or <code>locale</code> in your <code>apps.yaml</code> to configure the datetime format on your screensaver, you need to confirm Babel is installed on your system.
If not, the screensaver will display the date using the default datetime format.</p><p>See <a href=#install-babel-dependency title="Install Babel dependency">Install Babel dependency</a>.</p><p>The AppDaemon logs should womething like:</p><pre tabindex=0><code>Collecting Babel
  Downloading Babel-2.11.0-py3-none-any.whl (9.5 MB)
Requirement already satisfied: pytz&gt;=2015.7 in /usr/local/lib/python3.9/site-packages (from Babel-&gt;-r /conf/requirements.txt (line 1)) (2021.3)
Installing collected packages: Babel
Successfully installed Babel-2.11.0
</code></pre><p>Alternatively, you can configure the date using <code>dateFormat</code> and the <a href=https://www.w3schools.com/python/gloss_python_date_format_codes.asp title="Python Date Format Codes" target=_blank rel=noopener>Python Date Format Codes</a>.
However, the displayed date will not be localised.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-1</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Fri 18 November</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormatBabel</span>: <span style=color:#e6db74>&#34;EE d MMMM&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># vrijdag 18 november 2022</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># vr 18 november</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormatBabel</span>: <span style=color:#e6db74>&#34;EE d MMMM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Friday 18 November 2022</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormat</span>: <span style=color:#e6db74>&#34;%A %d %B %Y&#34;</span>
</span></span></code></pre></div></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-automation/>Home Automation</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-assistant/>Home Assistant</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/nspanel/>NSPanel</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/tasmota/>Tasmota</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/lovelace/>Lovelace</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/sonoff/>Sonoff</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a class=p-category href=https://sequr.be/categories/home-automation/>Home Automation</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
2416 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<time class=dt-published datetime=2023-01-14T01:00:00+01:00>2023-01-14</time></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
<span rel=author class="p-author h-card">DezeStijn</span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
<span rel=bookmark class=u-url><a href=https://sequr.be/3399475936>https://sequr.be/3399475936</a></span></p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href=https://ko-fi.com/s4squatch target=_blank rel=noopener aria-label title="Buy me a coffee"><div class="resp-sharing-button resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsequr.be%2fblog%2f2023%2f01%2fflashing-nspanel-with-tasmota-and-nspanel-lovelace-ui%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsequr.be%2fblog%2f2023%2f01%2fflashing-nspanel-with-tasmota-and-nspanel-lovelace-ui%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsequr.be%2fblog%2f2023%2f01%2fflashing-nspanel-with-tasmota-and-nspanel-lovelace-ui%2f&amp;resubmit=true&amp;title=Flashing%20NSPanel%20with%20Tasmota%20and%20NSPanel%20Lovelace%20UI" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Flashing%20NSPanel%20with%20Tasmota%20and%20NSPanel%20Lovelace%20UI&amp;body=https%3a%2f%2fsequr.be%2fblog%2f2023%2f01%2fflashing-nspanel-with-tasmota-and-nspanel-lovelace-ui%2f" target=_self rel=noopener aria-label title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div></div></a></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://sequr.be/blog/2023/02/manage-mercedes-ev-battery-charge-target-from-home-assistant/><span class=button__icon>←</span>
<span class=button__text>Manage Mercedes EV battery charge target from Home Assistant</span>
</a></span><span class="button next"><a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/><span class=button__text>Home Assistant Container Part 12: Migrating to Podman</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class="footer h-card"><div class=footer__inner><div class=footer__content><span>&copy; 2019</span>
<span><a class="p-name u-url" rel=me href=https://sequr.be/>DezeStijn</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></span>
<span><a href=https://sequr.be/blog/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div></footer></div><script type=text/javascript src=https://sequr.be/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>