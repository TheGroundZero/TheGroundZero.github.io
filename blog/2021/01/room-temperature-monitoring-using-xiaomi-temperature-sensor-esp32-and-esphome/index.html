<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="DezeStijn"><meta name=description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta name=keywords content="Sequr,blog,writeup,CTF,challenge,machine,infosec,IT security,hacking,pentesting,cybersecurity,Home Automation,Home Assistant,Xiaomi,temperature,humidity,sensor,ESP32,ESPHome,bluetooth"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/><title>Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome :: Sequr
</title><link rel=stylesheet href=https://sequr.be/main.min.244183cde1a38e0b08f82c11791181288f9aac1cc9618cd6f4e9e7710c5768ba.css integrity="sha256-JEGDzeGjjgsI+CwReRGBKI+arBzJYYzW9OnncQxXaLo=" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://sequr.be/css/table.css><link rel=stylesheet type=text/css href=https://sequr.be/css/menu.css><link rel=stylesheet type=text/css href=https://sequr.be/css/background.css><link rel=apple-touch-icon sizes=180x180 href=https://sequr.be/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sequr.be/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sequr.be/favicon-16x16.png><link rel=manifest href=https://sequr.be/site.webmanifest><link rel=mask-icon href=https://sequr.be/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://sequr.be/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta itemprop=description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta itemprop=datePublished content="2021-01-12T19:00:00+01:00"><meta itemprop=dateModified content="2021-05-18T01:00:00+01:00"><meta itemprop=wordCount content="2997"><meta itemprop=image content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Xiaomi,Temperature,Humidity,Sensor,ESP32,ESPHome,Bluetooth"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/cover.png"><meta name=twitter:title content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta name=twitter:description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta property="article:section" content="Home Automation"><meta property="article:published_time" content="2021-01-12 19:00:00 +0100 CET"><link rel=webmention href=https://webmention.io/sequr.be/webmention></head><body><div class=container><header class=header><span class=header__inner><a href=https://sequr.be/ style=text-decoration:none><div class=logo><span class=logo__mark>$</span>
<span class=logo__text>lynx sequr.be</span>
<span class=logo__cursor style=background-color:#e68101></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sequr.be/about/>About</a></li><li><a href=https://sequr.be/blog/>Blog</a></li><li><a href=https://sequr.be/privacy/>Privacy</a></li><li><a href=https://sequr.be/shoppinglist/>Shopping</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class="post h-entry"><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
15 minutes</p></div><article><h1 class="post-title p-name"><a href=https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/ class=u-url>Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#parts-needed-shopping-list>Parts needed (shopping list)</a></li><li><a href=#flashing-the-esp32>Flashing the ESP32</a><ul><li><a href=#esphome>ESPHome</a></li><li><a href=#flashing-bluetooth-discovery-firmware>Flashing bluetooth discovery firmware</a></li><li><a href=#flashing-sensor-firmware>Flashing sensor firmware</a></li><li><a href=#storing-wifi-creds-and-otaapi-passwords-in-secret-file>Storing WiFi creds and OTA/API passwords in secret file</a></li></ul></li><li><a href=#adding-the-sensors-in-home-assistant>Adding the sensors in Home Assistant</a></li><li><a href=#device-specific-configurations>Device specific configurations</a><ul><li><a href=#getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware>Getting the bindkey of the LYWSD03MMC and flashing custom firmware</a></li><li><a href=#getting-the-bindkey-of-the-cgg1>Getting the bindkey of the CGG1</a><ul><li><a href=#mihome-mod-app>MiHome Mod app</a></li><li><a href=#esphome-1>ESPHome</a></li><li><a href=#update-esp32><del>Update ESP32</del></a></li></ul></li><li><a href=#setting-the-clock-on-the-lywsd02>Setting the clock on the LYWSD02</a></li></ul></li><li><a href=#full-esp32-configuration>Full ESP32 configuration</a></li><li><a href=#changelog>Changelog</a></li></ul></nav></aside><hr><div class="post-content e-content"><p>At home I have a few <a href=https://shelly.cloud/products/shelly-humidity-temperature-smart-home-automation-sensor/ title="Shelly Humidity & Temperature sensor" target=_blank rel=noopener>Shelly H&amp;T</a> sensors.
These sensors provide me with a regular update on the temperature and humidity in a room.
They look pretty nice and are tiny, so they can be placed just about anywhere without drawing too much attention.
They currently sell in a white/blue and a black/orange variant for about €24, with an optional USB-powered base replacing the CR123A battery sold for €5.<br>I have one of these on each floor for general temperature monitoring.</p><p>Recently, I came accross a video by Intermit.Tech (<a href=https://blog.quindorian.org/2020/10/4-xiaomi-temperature-sensor-for-home-assistant.html/ title="4$ Xiaomi Temperature Sensor for Home Assistant" target=_blank rel=noopener>Quindor</a>) on setting up temperature and humidity monitoring using cheap $4 Xiaomi sensors.
These sensors are also pretty tiny, but come with a LCD-screen displaying the sensor data.
Their sensor is also pre-calibrated and the devices are optimized for running on battery power.<br>Because of their small size, and more importantly their small price, they&rsquo;re ideal for per-room temperature monitoring.</p><figure class=center><img src=xiaomi_sensor_LYWSD03MMC.png alt="Xiaomi LYWSD03MMC temperature and humidity sensor"><figcaption class=center>Xiaomi LYWSD03MMC sensor</figcaption></figure><p>Since they send their data over Bluetooth Low-Energy (BLE) you&rsquo;re supposed to use the companion app to get the readings.</p><p>In this blogpost I&rsquo;ll explain how to add the Xiaomi thermometers to Home Assistant using an ESP32 board to capture the bluetooth data and ESPHome to import the data in Home Assistant.
I&rsquo;ll discuss flashing the Xiaomi LYWSD03MMC sensors with custom firmware, integrating the Xiaomi LYWSDCGQ, getting the bindkey for the Xiaomi CGG1 running the newer firmware, and setting the clock on the Xiaomi LYWSD02 without using the MiHome app.</p><h2 id=parts-needed-shopping-list>Parts needed (shopping list) <a href=#parts-needed-shopping-list>¶</a></h2><p>For this tutorial, you&rsquo;ll need:</p><ul><li>One or more Xiaomi sensors.
They come in different shapes and sizes.<ul><li>Small square with LCD <a href=https://s.click.aliexpress.com/e/_Ac9pCh title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSD03MMC" target=_blank rel=noopener>LYWSD03MMC</a><br><strong>Note:</strong> These can (optionally) be flashed, <a href=#getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware title="Getting the bindkey of the LYWSD03MMC and flashing custom firmware">see below</a>.</li><li>Round with LCD <a href=https://s.click.aliexpress.com/e/_A9CVgh title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSDCGQ" target=_blank rel=noopener>LYWSDCGQ</a><br><strong>Note:</strong> I did not test these yet</li><li>Round with E-ink <a href=https://s.click.aliexpress.com/e/_APk8YN title="Xiaomi Bluetooth Temperature Humidity Sensor CGG1" target=_blank rel=noopener>CGG1</a><br><strong>Note:</strong> You&rsquo;ll need to obtain the bindkey via a modded app, <a href=#getting-the-bindkey-of-the-cgg1 title="Getting the bindkey of the CGG1">see below</a>.</li><li>Rectangular with E-ink <a href=https://s.click.aliexpress.com/e/_AKn1BJ title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSD02" target=_blank rel=noopener>LYWSD02</a><br><strong>Note:</strong> These work out-of-the-box but you&rsquo;ll need to <a href=#setting-the-clock-on-the-lywsd02 title="Setting the clock on the LYWSD02">set the clock</a>.</li></ul></li><li>An ESP-board with BLE chip<ul><li><a href=https://s.click.aliexpress.com/e/_97FTTR title="MH-ET LIVE ESP32 Development Board WiFi+Bluetooth" target=_blank rel=noopener>MH-ET LIVE ESP32</a></li></ul></li><li>A USB power supply for the ESP32<ul><li><a href=https://s.click.aliexpress.com/e/_AcyKgH title="CHOETECH Quick Charge 3.0 18W USB Wall Charger" target=_blank rel=noopener>CHOETECH Quick Charge 3.0 18W</a></li></ul></li><li>A micro-USB cable to to flash and power the ESP32<ul><li><a href=https://s.click.aliexpress.com/e/_APUlNb title="Baseus Micro USB Cable" target=_blank rel=noopener>Baseus Reversible Micro USB Cable</a></li></ul></li></ul><h2 id=flashing-the-esp32>Flashing the ESP32 <a href=#flashing-the-esp32>¶</a></h2><p>If you got a brand new ESP32 board, you&rsquo;ll need to flash it once over USB to get it setup to work with ESPHome.
Once this flashing is done, you&rsquo;ll be able to push any future updates Over-The-Air (OTA).</p><h3 id=esphome>ESPHome <a href=#esphome>¶</a></h3><p>We&rsquo;ll be writing our code for the ESP32 in <a href=https://esphome.io title=ESPHome target=_blank rel=noopener>ESPHome</a>.
So make sure you&rsquo;ve installed the ESPHome Add-on in Home Assistant.<br>The ESPHome website has a <a href=https://esphome.io/guides/getting_started_hassio.html title="ESPHome - Getting Started with ESPHome and Home Assistant" target=_blank rel=noopener>tutorial</a> on installing this add-on in Home Assistant.</p><h3 id=flashing-bluetooth-discovery-firmware>Flashing bluetooth discovery firmware <a href=#flashing-bluetooth-discovery-firmware>¶</a></h3><ol><li><p>In ESPHome, create a new device by clicking the big <code>+</code> button.<br>The details you enter here don&rsquo;t matter too much. Just make sure you give it a reasonable name (this will also be used to name the config file).
E.g., <code>livingroom_esp32</code></p></li><li><p>Now edit the device and overwrite the config with the following code.
Change the back to what you originally named the device.<br>You can enter the WiFi credentials directly in the config, or make use of the secrets file (see below).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>substitutions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>esphome_name</span>: <span style=color:#ae81ff>livingroom_esp32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${esphome_name}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>ESP32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>board</span>: <span style=color:#ae81ff>mhetesp32devkit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssid</span>: !<span style=color:#ae81ff>secret wifi_ssid</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret wifi_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>reboot_timeout</span>: <span style=color:#ae81ff>60min</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_api_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sync time with HA</span>
</span></span><span style=display:flex><span><span style=color:#f92672>time</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#web_server:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    port: 80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ota</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_ota_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logger</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enable Bluetooth scanning for this ESP32</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esp32_ble_tracker</span>:
</span></span></code></pre></div><p>Save and Close the editor.</p></li><li><p>Now click the 3 dots in the upper right corner of your device and click <code>Compile</code>.<br>This will compile the code into a firmware binary that we can download to our computer.</p></li><li><p>While the code is compiling, download and install the <a href=https://github.com/esphome/esphome-flasher/releases title=ESPHome-Flasher target=_blank rel=noopener>ESPHome-Flasher</a> for your system.
This software will be used for the initial flashing over USB. Future updates will be done Over-The-Air (OTA).</p></li><li><p>We&rsquo;ll now flash the compiled firmware to the ESP32.</p><ol><li>Connect the ESP32 using a micro-USB cable to your computer</li><li>Open ESPHome-Flasher</li><li>Click the refresh button at the top-right</li><li>Select the COM port your ESP32 is connected to</li><li>Browse to the firmware we&rsquo;ve just compiled and download to our computer</li><li>Click <code>Flash ESP</code></li></ol><p>If the flashing software is unable to put the ESP32 in <em>flash mode</em>, hold down the <em>Boot</em> button on the ESP32 while it&rsquo;s trying to flash.<br>Once the flashing has started, you can let go of the <em>Boot</em> button.</p></li><li><p>Once it&rsquo;s done flashing, the ESP32 will connect to your WiFi network and you&rsquo;ll be able to control the ESP32 Over-The-Air using ESPHome.</p></li></ol><h3 id=flashing-sensor-firmware>Flashing sensor firmware <a href=#flashing-sensor-firmware>¶</a></h3><p>You can now disconnect the ESP32 and install it where it will be able to receive the bluetooth data of your sensors.
Power it using a phone charger, like the one in the Shopping List above.</p><ol><li>Back in the ESPHome dashboard, you can now click the <code>LOGS</code> button to view the output of the ESP32 board.<br>In the past you&rsquo;d see broadcast messages containing temperature and humidity information, including the device&rsquo;s MAC address.
Nowadays you&rsquo;ll need to look for lines <code>Found device XX:XX:XX:XX:XX:XX (...) Name: 'xxxxxxxxxx'</code>.
You&rsquo;ll want to note down the MAC address of the ATC device (if flashed) or with the original name (e.g., LYWSD03MMC).<br><figure class=center><img src=esphome_bletracker.png alt="BLE_tracker showing discovered devices"><figcaption class=center>BLE_tracker output</figcaption></figure><br><strong>Note:</strong> To make identifying the correct Xiaomi device easier, make sure the others are out of bluetooth range or are turned off.
You may also want to label each sensor after you&rsquo;ve identified it.</li><li>We&rsquo;ll now edit the device&rsquo;s code again and add the sensor entities for the Xiaomi sensor(s) we&rsquo;ll be monitoring.<br>Open the config editor and paste the following code below the code we already had:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Add this to the substitions block:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># substitutions:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd03</span>: <span style=color:#ae81ff>Living room</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd02</span>: <span style=color:#ae81ff>Kitchen</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_cgg1</span>: <span style=color:#ae81ff>Master Bedroom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsdcgq</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>gpio</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Onboard LED&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>pin</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>inverted</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>restart</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Restart&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>restart_switch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>sensor</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># General</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Uptime Sensor&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>wifi_signal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - WiFi Signal&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>update_interval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Mi Like</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd03mmc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, use a dummy value when flashed with custom firmware</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Custom</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>atc_mithermometer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Level&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_voltage</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Voltage&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD02</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd02</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CGG1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_cgg1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, requires different ESPHome_version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSDCGQ</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsdcgq</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove or add extra sensors by deleting/copying any of the blocks above.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Change MAC address, bindkey and sensor names</span>
</span></span></code></pre></div></li><li>Press the <code>Upload</code> bottom at the bottom right of the editor.<br>This will save, compile and upload the new firmware to the ESP32 (OTA).</li></ol><h3 id=storing-wifi-creds-and-otaapi-passwords-in-secret-file>Storing WiFi creds and OTA/API passwords in secret file <a href=#storing-wifi-creds-and-otaapi-passwords-in-secret-file>¶</a></h3><p>Just like with Home Assistant, ESPHome has a <code>secrets.yaml</code> in which you can store stuff like WiFi credentials.<br>This allows you to keep secret data away from your config files and also adds consistency accross your devices.</p><p>To make things even easier, you can reference your Home Assistant <code>secrets.yaml</code> from the ESPHome&rsquo;s one, allowing you to keep everything in one central location.</p><p>Create a file <code>/config/esphome/secrets.yaml</code> with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>&lt;&lt;</span>: !<span style=color:#ae81ff>include ../secrets.yaml</span>
</span></span></code></pre></div><p>Now in <code>/config/secrets.yaml</code> you can add your WiFi credentials etc.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>wifi_ssid</span>: <span style=color:#e6db74>&#34;MyVerySecretWiFiNetwork&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi_pass</span>: <span style=color:#e6db74>&#34;MyverySecretWiFiPassword&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_ota_pass</span>: <span style=color:#e6db74>&#34;SecretEsphomeOtaPass&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_api_pass</span>: <span style=color:#e6db74>&#34;SecretEsphomeApiPass&#34;</span>
</span></span></code></pre></div><p>You can now reference these secrets from your config using e.g. <code>ssid: !secret wifi_ssid</code>.</p><h2 id=adding-the-sensors-in-home-assistant>Adding the sensors in Home Assistant <a href=#adding-the-sensors-in-home-assistant>¶</a></h2><p>Adding the sensors to Home Assistant is really easy.
If the sensor for some reason doesn&rsquo;t show up yet in the guide below, give Home Assistant a reboot and wait a few minutes.</p><ol><li>In Home Assistant, go to Configuration > Integrations.</li><li>If the ESP32 isn&rsquo;t automatically discovered yet by Home Assistant, click the big <code>+</code> button to add a new integration.<br>Choose ESPHome from the list.</li><li>Enter the IP address or hostname of your ESP32 board, keep the port in its default value.</li><li>Enter your API and/or OTA password.</li><li>Add the device to a room if you wish to do so.</li></ol><p>Within the Configuration page you should now see an entry for your device (livingroom_esp32) under ESPHome.<br>Clicking this device will show you the different sensors for the temperature, humidity and battery level.
You should also have a switch to turn on the onboard LED (useful to identify the device) and to reboot it.
You may also have a sensor for the WiFi signal strength and device uptime.</p><p>It may take a while before sensor data will appear for the device.<br>Since the sensors are battery powered, it may take until a certain temperature change (or the next update interval).</p><p><figure class=center><img src=xiaomi_ha_esphome.png alt="ESPHome entities in Home Assistant"><figcaption class=center>ESPHome entities in Home Assistant</figcaption></figure><figure class=center><img src=xiaomi_ha_esphome_temp.png alt="Temperature readings"><figcaption class=center>Temperature readings</figcaption></figure></p><h2 id=device-specific-configurations>Device specific configurations <a href=#device-specific-configurations>¶</a></h2><h3 id=getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware>Getting the bindkey of the LYWSD03MMC and flashing custom firmware <a href=#getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware>¶</a></h3><p>Sadly enough, more recent models of the Xiaomi (LYWSD03MMC) sensors come with a new firmware that encrypts the data send over bluetooth.
Luckily Aaron Christophel came up with a nice way of <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" target=_blank rel=noopener>hacking</a> the firmware on these sensors.
Not only does his <em>hack</em> provide a method of retrieving the bluetooth encryption key (allowing us to decrypt the data) but he even wrote his own firmware.
Using Aaron&rsquo;s <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" target=_blank rel=noopener>ATC_MiThermometer</a> firmware, you can also control the update interval, allowing you to choose sensor update frequency over battery life.</p><p><strong>Update 2021-05-18</strong>: There&rsquo;s <a href=https://github.com/pvvx/ATC_MiThermometer title="pvvx/ATC_MiThermometer on GitHub" target=_blank rel=noopener>a fork</a> of Aaron&rsquo;s firmware which appears to offer more functions including non-volatile storage and a better low power management.
To use this version, follow the same steps as below but grab the binary from Victor&rsquo;s repository.</p><figure class=center><img src=ATC_MiThermometer.png alt="ATC MiThermometer by Aaron Christophel"><figcaption class=center>ATC MiThermometer</figcaption></figure><p><strong>Note:</strong> Flashing the custom firmware isn&rsquo;t strictly necessary to get the sensor data imported into Home Assistant.<br>If you don&rsquo;t feel like flashing the sensor, follow the guide below until step 5 and skip the rest of the flashing.</p><p>The flashing will be done from the browser a phone or tablet, since you need to connect to the sensor over bluetooth.<br>Use the default browser of the device or the Chrome browser.
If it doesn&rsquo;t work with one device, try it again on another.<br>I had issues trying this on a OnePlus and Firefox. It succeeded using a Samsung Galaxy Tab and its default browser.</p><ol><li><p>Get the <code>ATC_MiThermometer.bin</code> binary from <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" target=_blank rel=noopener>Aaron&rsquo;s GitHub</a> and save it to your phone/tablet.</p></li><li><p>Still on the GitHub page, at the top of the Readme documentation, you&rsquo;ll find a link to the Web Flasher tool also written by Aaron.
Open this link in the default/Chrome browser of your phone/tablet.</p></li><li><p>On the Web Flasher page, check the <code>Hide unsupported</code> checkbox and click <code>Connect</code>.</p></li><li><p>From the popup that should now have appeared, select the sensor you want to flash.
The name should match the device ID from the shopping list above (e.g., <code>LYWSD03MMC</code>).<br>Once connected, the &ldquo;Temp/Humi&rdquo; field &ndash; located about halfway the webpage &ndash; should be displaying sensor readings.
At the bottom of the page, the logs should also show the device having connected.</p></li><li><p>Press the <code>Do activation</code> button.<br>A Mi Token and Mi Bind Key should appear a bit below the &ldquo;Temp/Humi&rdquo; field of the previous step.<br>Note these down (or copy them into an email, Google Keep note, &mldr;) in a way that you can easily get to them from your computer/laptop.<br>This token and key are what you need to import the Xiaomi sensor into Home Assistant without flashing the custom firmware.</p><p><strong>If you don&rsquo;t want to flash the Xiaomi sensor with the custom firmware, stop here and continue with the next part.</strong></p></li><li><p>Below the &ldquo;Do activation&rdquo; button, there&rsquo;s a <code>Choose File</code> button.<br>Press this button and select the <code>ATC_MiThermometer.bin</code> you downloaded earlier.<br>Make sure to select the correct file here, or you may/will brick the sensor!</p></li><li><p>Press the <code>Start Flashing</code> button.<br>You&rsquo;ll see that status of the flashing appearing below the button.
Don&rsquo;t use the phone for now, it&rsquo;ll only take a minute or so.</p></li><li><p>Once the update is succesful, press the <code>Connect</code> button again and look for the flashed sensor.<br>The device should now appear as <code>ATC_xxxxxx</code>.
The logs at the bottom of the page should show you that you&rsquo;ve connected to the device.</p></li><li><p>Using the newly acquired features, we can now change some settings on the device.<br>Note that the changes don&rsquo;t always go through to the device, so press each button like 5 times to make sure it was set succesfully.</p><ol><li>set the <code>Advertising Type</code> to <code>Mi Like</code><br><strong>Note</strong>: Since ESPHome <a href=https://github.com/esphome/esphome/pull/1291 title="ESPHome on GitHub - Add support for ATC_MiThermometer #1291" target=_blank rel=noopener>v1.16.0</a> <code>Advertising Type: Custom</code> is supported.</li><li>set the <code>Advertising Interval</code> to your liking. Shorter interval means shorter battery life but less detailed measurements.</li></ol></li></ol><h3 id=getting-the-bindkey-of-the-cgg1>Getting the bindkey of the CGG1 <a href=#getting-the-bindkey-of-the-cgg1>¶</a></h3><figure class=center><img src=xiaomi_sensor_CGG1.png alt="Xiaomi CGG1"><figcaption class=center>Xiaomi CGG1</figcaption></figure><h4 id=mihome-mod-app>MiHome Mod app <a href=#mihome-mod-app>¶</a></h4><p><strong>Note:</strong> These steps must be followed with an Android device</p><ol><li>Download the <a href=https://www.kapiba.ru/2017/11/mi-home.html title="MiHome Mod" target=_blank rel=noopener>MiHome mod</a> apk.<br>The site is in Russian, so use Google Translate to translate if needed.</li><li>Configure your device to allow installation of untrusted sources.</li><li>While installing the app, grant permission to the local device storage</li><li>Once you open the app, a new folder will be created: <code>/devicestorage/vevs</code>.</li><li>Close the app and create a new folder within this folder: <code>/devicestorage/vevs/logs</code></li><li>Open the app again and login with your Mi account.</li><li>Add the CGG1 in the app.</li><li>The bindkey is now stored on your device.<br>Transfer <code>/devicestorage/vevs/logs/misc/pairings.txt</code> to your computer (over USB/bluetooth).</li><li>Extract the bindkey from the file you just transfered.</li></ol><p>The <code>pairings.txt</code> will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>Did:		blt.4.xxxxxxxxxxxxx
</span></span><span style=display:flex><span>Token:		xxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span style=display:flex><span>Bindkey:		xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span style=display:flex><span>Mac:		xx:xx:xx:xx:xx:xx
</span></span></code></pre></div><h4 id=esphome-1>ESPHome <a href=#esphome-1>¶</a></h4><p><del>To use this bindkey in your configuration, you&rsquo;ll need to load an adapted version of ESPHome.</del></p><p><strong>Update 2021-05-18</strong>: Flameeyes&rsquo; code has been imported into the main ESPHome code base since <a href=https://esphome.io/changelog/v1.17.0.html#release-1-17-1-may-5 title="ESPHome - Changelog release 1.17.1" target=_blank rel=noopener>ESPHome v1.17.1</a>.
It&rsquo;s no longer necessary to move to Flameeyes&rsquo; codebase to configure the <code>bindkey</code> in your ESPHome config.</p><ol><li>Open the Supervisor Dashboard in Home Assistnat</li><li>Click the ESPHome add-on and go to the Configuration tab</li><li>Under &ldquo;esphome_version&rdquo; enter <code>Flameeyes:cgg1-enc</code><br><figure class=center><img src=esphome_version.png alt="ESPHome_version: Flameeyes:cgg1-enc"><figcaption class=center>Change esphome_version</figcaption></figure><br>In the YAML this would look like:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ssl</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>certfile</span>: <span style=color:#ae81ff>fullchain.pem</span>
</span></span><span style=display:flex><span><span style=color:#f92672>keyfile</span>: <span style=color:#ae81ff>privkey.pem</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_version</span>: <span style=color:#e6db74>&#39;Flameeyes:cgg1-enc&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>relative_url</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span></code></pre></div></li><li>Save and restart the add-on</li></ol><p>You can now add a <code>bindkey</code> to the config/firmware.</p><h4 id=update-esp32><del>Update ESP32</del> <a href=#update-esp32>¶</a></h4><p>If you already had your ESP32 configured, you&rsquo;ll need to update it to the custom ESPHome_version.</p><ol><li>Open the ESPHome dashboard.</li><li>You&rsquo;ll see the Update symbol at the top-right of the device&rsquo;s entry.</li><li>To update, click the 3 dots at the top-right of your screen and click &ldquo;Update All&rdquo;.<br><figure class=center><img src=esphome_update.png alt="ESPHome - Update all"><figcaption class=center>Update All</figcaption></figure></li></ol><h3 id=setting-the-clock-on-the-lywsd02>Setting the clock on the LYWSD02 <a href=#setting-the-clock-on-the-lywsd02>¶</a></h3><figure class=center><img src=xiaomi_sensor_LYWSD02.png alt="Xiaomi LYWSD02"><figcaption class=center>Xiaomi LYWSD02</figcaption></figure><p>The LYWSD02 also displays the current time.</p><p>Normally you need to install the MiHome app to sync the time.
But installing a Chinese app just to sync the time on your sensors, might seem a bit useless.
Luckily, another fantastic Github user, saso5, created a simple web app that allows you to set the time on your LYWSD02.</p><ul><li>Visit <a href=https://saso5.github.io/LYWSD02-clock-sync/ target=_blank rel=noopener>https://saso5.github.io/LYWSD02-clock-sync/</a> with the same device you used to flash your LYWSD03.</li><li>Pick your timezone (between UTC/GMT-12 and UTC/GMT+14)</li><li>Click the <code>Update time</code> button</li><li>Select the LYWSD02 in the popup that appears and click <code>Connect</code></li></ul><p>The time on your LYWSD02 should now be correct.</p><p>Make sure you close the browser tab and disconnect your device from the Xiaomi.<br>Otherwise your device will &ldquo;claim&rdquo; the Bluetooth connection and the ESP32 won&rsquo;t be able to connect.</p><p>There&rsquo;s a <a href=https://github.com/esphome/feature-requests/issues/643 title="Set clock on Xiaomi LYWSD02 #643 on GitHub" target=_blank rel=noopener>feature request</a> on the ESPHome GitHub to have the LYWSD02 sync with an SNTP server.</p><h2 id=full-esp32-configuration>Full ESP32 configuration <a href=#full-esp32-configuration>¶</a></h2><p>The complete configuration file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>substitutions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>esphome_name</span>: <span style=color:#ae81ff>livingroom_esp32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd03</span>: <span style=color:#ae81ff>Living room</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd02</span>: <span style=color:#ae81ff>Kitchen</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_cgg1</span>: <span style=color:#ae81ff>Master Bedroom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsdcgq</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${esphome_name}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>ESP32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>board</span>: <span style=color:#ae81ff>mhetesp32devkit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssid</span>: !<span style=color:#ae81ff>secret wifi_ssid</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret wifi_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>reboot_timeout</span>: <span style=color:#ae81ff>60min</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_api_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ota</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_ota_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sync time with HA</span>
</span></span><span style=display:flex><span><span style=color:#f92672>time</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#web_server:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    port: 80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logger</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enable Bluetooth scanning for this ESP32</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esp32_ble_tracker</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>gpio</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Onboard LED&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>pin</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>inverted</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>restart</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Restart&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>restart_switch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>sensor</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># General</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Uptime Sensor&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>wifi_signal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - WiFi Signal&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>update_interval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Mi Like</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd03mmc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, use a dummy value when flashed with custom firmware</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Custom</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>atc_mithermometer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Level&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_voltage</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Voltage&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD02</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd02</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Battery Level&#34;</span>
</span></span><span style=display:flex><span>    	
</span></span><span style=display:flex><span>    <span style=color:#75715e># CGG1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_cgg1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, requires different ESPHome_version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Battery Level&#34;</span>
</span></span><span style=display:flex><span>    	
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSDCGQ</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsdcgq</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Battery Level&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove or add extra sensors by deleting/copying any of the blocks above.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Change MAC address, bindkey and sensor names</span>
</span></span></code></pre></div><h2 id=changelog>Changelog <a href=#changelog>¶</a></h2><ul><li>2020-02-09 - Newer versions of CGG1 have encrypted Bluetooth messages. Flameeyes:cgg1-enc firmware adds support for bindkey.</li><li>2021-02-14 - ESPHome v1.16.0 adds support for ATC_MiThermometer using Advertising Type: Custom</li><li>2021-05-18 - Flameeyes:cgg1-enc merged into main ESPHome codebase to support CGG1 with bindkey. ATC_MiThermometer fork adds extra features.</li></ul></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-automation/>Home Automation</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-assistant/>Home Assistant</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/xiaomi/>Xiaomi</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/temperature/>temperature</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/humidity/>humidity</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/sensor/>sensor</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/esp32/>ESP32</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/esphome/>ESPHome</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/bluetooth/>bluetooth</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a class=p-category href=https://sequr.be/categories/home-automation/>Home Automation</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
2997 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<time class=dt-published datetime=2021-01-12T19:00:00+01:00>2021-01-12
</time>(Last updated: <time class=dt-updated datetime=2021-05-18T02:00:00+02:00>2021-05-18</time>)</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
<span rel=author class="p-author h-card">DezeStijn</span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
<span rel=bookmark class=u-url><a href=https://sequr.be/2095637590>https://sequr.be/2095637590</a></span></p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href=https://ko-fi.com/s4squatch target=_blank rel=noopener aria-label title="Buy me a coffee"><div class="resp-sharing-button resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsequr.be%2fblog%2f2021%2f01%2froom-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsequr.be%2fblog%2f2021%2f01%2froom-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsequr.be%2fblog%2f2021%2f01%2froom-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome%2f&amp;resubmit=true&amp;title=Room%20temperature%20monitoring%20using%20Xiaomi%20temperature%20sensor%2c%20ESP32%20and%20ESPHome" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Room%20temperature%20monitoring%20using%20Xiaomi%20temperature%20sensor%2c%20ESP32%20and%20ESPHome&amp;body=https%3a%2f%2fsequr.be%2fblog%2f2021%2f01%2froom-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome%2f" target=_self rel=noopener aria-label title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div></div></a></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://sequr.be/blog/2021/01/circadian-lighting-with-ikea-tradfri-lightbulbs-and-home-assistant/><span class=button__icon>←</span>
<span class=button__text>Circadian lighting with IKEA TRADFRI lightbulbs and Home Assistant</span>
</a></span><span class="button next"><a href=https://sequr.be/blog/2020/11/force-update/downgrade-shelly-firmware/><span class=button__text>Force update/downgrade Shelly firmware</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class="footer h-card"><div class=footer__inner><div class=footer__content><span>&copy; 2019</span>
<span><a class="p-name u-url" rel=me href=https://sequr.be/>DezeStijn</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></span>
<span><a href=https://sequr.be/blog/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div></footer></div><script type=text/javascript src=https://sequr.be/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>