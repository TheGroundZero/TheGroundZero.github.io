<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="DezeStijn"><meta name=description content="In this third part of the Home Assistant Container series we&amp;rsquo;ll add MariaDB and InfluxDB to store our recorder and history data."><meta name=keywords content="Sequr,blog,writeup,CTF,challenge,machine,infosec,IT security,hacking,pentesting,cybersecurity,Home Automation,Home Assistant,Container,Docker,docker-compose,MariaDB,recorder,InfluxDB,history"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/><title>Home Assistant Container Part 3: MariaDB and InfluxDB :: Sequr</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sequr.be/main.031a8efc33f94f55a4071bf4e91596478a5809fc8c148fab113801189cfd2152.css><link rel=stylesheet type=text/css href=https://sequr.be/css/table.css><link rel=stylesheet type=text/css href=https://sequr.be/css/menu.css><link rel=apple-touch-icon sizes=180x180 href=https://sequr.be/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sequr.be/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sequr.be/favicon-16x16.png><link rel=manifest href=https://sequr.be/site.webmanifest><link rel=mask-icon href=https://sequr.be/safari-pinned-tab.svg color=#e68101><link rel="shortcut icon" href=https://sequr.be/favicon.ico><meta name=msapplication-TileColor content="#e68101"><meta name=theme-color content="#e68101"><meta itemprop=name content="Home Assistant Container Part 3: MariaDB and InfluxDB"><meta itemprop=description content="In this third part of the Home Assistant Container series we&rsquo;ll add MariaDB and InfluxDB to store our recorder and history data."><meta itemprop=datePublished content="2022-09-03T00:00:00+00:00"><meta itemprop=dateModified content="2022-09-03T00:00:00+00:00"><meta itemprop=wordCount content="1155"><meta itemprop=image content="https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Container,Docker,docker-compose,MariaDB,recorder,InfluxDB,history,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/cover.png"><meta name=twitter:title content="Home Assistant Container Part 3: MariaDB and InfluxDB"><meta name=twitter:description content="In this third part of the Home Assistant Container series we&rsquo;ll add MariaDB and InfluxDB to store our recorder and history data."><meta property="article:section" content="Home Automation"><meta property="article:published_time" content="2022-09-03 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sequr.be/ style=text-decoration:none><div class=logo><span class=logo__mark>$</span>
<span class=logo__text>nc sequr.be 1337</span>
<span class=logo__cursor style=background-color:#e68101></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sequr.be/blog/>Blog</a></li><li><a href=https://sequr.be/about/>About</a></li><li><a href=https://sequr.be/shoppinglist/>Shopping</a></li><li><a href=https://sequr.be/privacy/>Privacy</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>6 minutes</p></div><article><h1 class=post-title><a href=https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/>Home Assistant Container Part 3: MariaDB and InfluxDB</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#install-mariadb-and-influxdb-containers>Install MariaDB and InfluxDB containers</a><ul><li><a href=#environment-variables>Environment variables</a></li><li><a href=#dependencies>Dependencies</a></li><li><a href=#initial-run>Initial run</a></li><li><a href=#influxdb-token>InfluxDB Token</a></li></ul></li><li><a href=#home-assistant-configuration>Home Assistant configuration</a><ul><li><a href=#more-secrets>More secrets</a></li><li><a href=#restart>Restart</a></li></ul></li><li><a href=#manage-portainer-from-within-home-assistant>Manage Portainer from within Home Assistant</a></li></ul></nav></aside><hr><div class=post-content><h2 id=intro>Intro <a href=#intro>¶</a></h2><p>We&rsquo;re continuing where we left off after <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-2-home-assistant-container/ title="Part 2: Home Assistant Container">Part 2: Home Assistant Container</a>.</p><p>In this Part 3, we&rsquo;ll set up the MariaDB and InfluxDB containers which we&rsquo;ll use to store the data from the Home Assistant recorder and history.</p><h2 id=install-mariadb-and-influxdb-containers>Install MariaDB and InfluxDB containers <a href=#install-mariadb-and-influxdb-containers>¶</a></h2><p>Continuing in the same trend as the <a href=https://sequr.be/blog/2022/08/home-assistant-container-part-1-install-debian-docker-and-portainer/ title="Part 1: Install Debian, Docker and Portainer">previous</a> <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-2-home-assistant-container/ title="Part 2: Home Assistant Container">two</a> posts, we start of with the <code>docker-compose.yaml</code> config for our new containers.</p><p>The configuration for these containers looks as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>homeassistant</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mariadb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mariadb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mariadb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=Europe/Brussels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_DATABASE=${MYSQL_HA_DATABASE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_USER=${MYSQL_HA_USER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_PASSWORD=${MYSQL_HA_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/opt/mariadb/data:/var/lib/mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/opt/mariadb/config/:/etc/mysql/conf.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>influxdb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>influxdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>influxdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8086:8086/tcp&#34;</span><span class=w>   </span><span class=c># So we can access the WebUI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=Europe/Brussels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOCKER_INFLUXDB_INIT_MODE=setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USER}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/opt/influxdb/data:/var/lib/influxdb2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/opt/influxdb/config/:/etc/influxdb2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ulimits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nofile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>soft</span><span class=p>:</span><span class=w> </span><span class=m>32768</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hard</span><span class=p>:</span><span class=w> </span><span class=m>32768</span><span class=w>
</span></span></span></code></pre></div><h3 id=environment-variables>Environment variables <a href=#environment-variables>¶</a></h3><p>You&rsquo;ll notice we added some environment variables in the configuration, such as <code>${MYSQL_ROOT_PASSWORD}</code>.</p><p>These placeholders ensure we don&rsquo;t put sensitive data in our <code>docker-compose.yaml</code>.
This is especially useful for when we want to back-up and/or distribute our Docker config in a Version Control System (VCS) like GitHub.</p><p>To provide a value for these environment variable, create a <code>.env</code> file in the same directory as the <code>docker-compose.yaml</code> file, i.e. <code>/opt</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano .env
</span></span><span class=line><span class=cl><span class=c1># Add secrets, see below</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Also grant our non-admin account to this file</span>
</span></span><span class=line><span class=cl><span class=c1>#  so we don&#39;t need sudo to edit in the future</span>
</span></span><span class=line><span class=cl>sudo chown root:docker .env
</span></span><span class=line><span class=cl>sudo chmod g+w .env
</span></span></code></pre></div><p>The <code>.env</code> file would look like this.
Make any modifications (like passwords!) here.</p><pre tabindex=0><code>MYSQL_ROOT_PASSWORD=mariadbrootpassword
MYSQL_HA_DATABASE=ha_db
MYSQL_HA_USER=homeassistant
MYSQL_HA_PASSWORD=mariadbhapassword

INFLUXDB_USER=homeassistant
INFLUXDB_PASSWORD=influxhapassword
INFLUXDB_ORG=sequr
INFLUXDB_BUCKET=homeassistant
</code></pre><p>If you run the config check before creating the <code>.env</code> file, you&rsquo;ll also be warned about this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f docker-compose.yaml config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;MYSQL_HA_DATABASE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;MYSQL_HA_USER&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;MYSQL_HA_PASSWORD&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;INFLUXDB_USER&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;INFLUXDB_PASSWORD&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;INFLUXDB_ORG&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> The <span class=s2>&#34;INFLUXDB_BUCKET&#34;</span> variable is not set. Defaulting to a blank string.
</span></span></code></pre></div><h3 id=dependencies>Dependencies <a href=#dependencies>¶</a></h3><p>In case we reboot our Docker system, we also want the Home Assistant container to wait for the MariaDB and InfluxDB container to be online before starting.
This is to ensure the connection from HA to these systems doesn&rsquo;t fail and no data is lost.</p><p>So add the following to the config entry to the <code>homeassistant</code> container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>homeassistant</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mariadb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>influxdb</span><span class=w>
</span></span></span></code></pre></div><h3 id=initial-run>Initial run <a href=#initial-run>¶</a></h3><p>You can now run <code>docker-compose up -d</code> to install the MariaDB and InfluxDB containers.</p><p>You&rsquo;ll also notice the Home Assistant container is recreated as its config has changed.</p><figure class=center><img src=containers.png alt="Screenshot of Portainer showing our running containers"><figcaption class=center>4 containers so far</figcaption></figure><h3 id=influxdb-token>InfluxDB Token <a href=#influxdb-token>¶</a></h3><p>Now that our InfluxDB container is running we&rsquo;ll open the WebUI to <a href=https://docs.influxdata.com/influxdb/cloud/security/tokens/create-token/#create-a-token-in-the-influxdb-ui title="Create a token in the InfluxDB UI" target=_blank rel=noopener>grab a token</a>.
We&rsquo;ll need this token later to grant Home Assistant access to our newly created bucket.</p><p>Open a browser and go to <code>http://&lt;ip.of.our.box>:8086</code> and login using the credentials you use in the <code>.env</code> file.</p><figure class=center><img src=influxdb_login.png alt="InfluxDB login screen"><figcaption class=center>Login to InfluxDB</figcaption></figure><p>Go to the API Tokens menu and generate a new read/write token specifically for our Home Assistant bucket.</p><figure class=center><img src=influxdb_token.png alt="InfluxDB Generate Read/Write API Token"><figcaption class=center>Creating a RW token for our homeassistant bucket</figcaption></figure><p>Click on the name of the token and a window will appear showing you the token.
We&rsquo;ll need this token in a later stage.</p><h2 id=home-assistant-configuration>Home Assistant configuration <a href=#home-assistant-configuration>¶</a></h2><p>With the containers up and running the first half of the job is done.
We still need to tell Home Assistant about these new database.</p><p>For this, we will be adding our first Home Assistant configurations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /opt/homeassistant/config/
</span></span><span class=line><span class=cl>sudo nano configuration.yaml
</span></span></code></pre></div><p>You&rsquo;ll see some config is already present.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Loads default set of integrations. Do not remove.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>default_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Text to speech</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>google_translate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>automation</span><span class=p>:</span><span class=w> </span>!<span class=l>include automations.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w> </span>!<span class=l>include scripts.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scene</span><span class=p>:</span><span class=w> </span>!<span class=l>include scenes.yaml</span><span class=w>
</span></span></span></code></pre></div><p>Add the following config below it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>recorder</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db_url</span><span class=p>:</span><span class=w> </span>!<span class=l>secret mariadb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>purge_keep_days</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>   </span><span class=c># default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>history</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>influxdb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>api_version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ssl</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span>!<span class=l>secret influxdb_host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8086</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token</span><span class=p>:</span><span class=w> </span>!<span class=l>secret influxdb_token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>organization</span><span class=p>:</span><span class=w> </span>!<span class=l>secret influx_org</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bucket</span><span class=p>:</span><span class=w> </span><span class=l>homeassistant</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>HomeAssistant</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags_attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>friendly_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default_measurement</span><span class=p>:</span><span class=w> </span><span class=l>units</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ignore_attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>icon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>exclude</span><span class=p>:</span><span class=w>    </span><span class=c># Customise to fit your needs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entities</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>zone.home</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>persistent_notification</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>person</span><span class=w>
</span></span></span></code></pre></div><h3 id=more-secrets>More secrets <a href=#more-secrets>¶</a></h3><p>You&rsquo;ll have noticed I made some <em>secret</em> references in the config above, like <code>!secret mariadb</code>.</p><p>Home Assistant also allows you to hide <a href=https://www.home-assistant.io/docs/configuration/secrets/ title="Storing secrets - Home Assistant" target=_blank rel=noopener>secrets</a> from the <code>configuration.yaml</code> file so you can safely share it.
Just like with the environment variables we used in our <code>docker-compose.yaml</code>, these are references to a value stored elsewhere.
In this case, these are key-value pairs in a file named <code>secrets.yaml</code> located in the same folder as the <code>configuration.yaml</code>.</p><p>So let&rsquo;s create this file and add our secrets to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /opt/homeassistant/config
</span></span><span class=line><span class=cl>sudo nano secrets.yaml
</span></span></code></pre></div><p>Notice this file already exists and contains an example entry:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Use this file to store secrets like usernames and passwords.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Learn more at https://www.home-assistant.io/docs/configuration/secrets/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>some_password</span><span class=p>:</span><span class=w> </span><span class=l>welcome</span><span class=w>
</span></span></span></code></pre></div><p>Remove this example, and add your own secrets.
Make sure you match the configuration of the <code>.env</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>mariadb</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mysql://homeassistant:mariadbhapassword@172.18.0.4:3306/ha_db?charset=utf8mb4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>influxdb_host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;172.18.0.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>influxdb_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;influxdbtoken&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>influx_org</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sequr&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=restart>Restart <a href=#restart>¶</a></h3><p>After saving the files, open the Home Assistant web interface and go to Developer Tools > YAML.
Click <code>Check Configuration</code> to make sure you didn&rsquo;t make any typos are made a mistake in spacing.</p><figure class=center><img src=config_valid.png alt="Configuration validation reports a valid configuration"><figcaption class=center>Our config is validated</figcaption></figure><p>If you get a green &ldquo;Configuration valid!&rdquo; you&rsquo;re good and you can press the <code>Restart</code> button on the right to restart Home Assistant, which will apply all changes we made to the <code>configuration.yaml</code> file.</p><h2 id=manage-portainer-from-within-home-assistant>Manage Portainer from within Home Assistant <a href=#manage-portainer-from-within-home-assistant>¶</a></h2><p>One thing we&rsquo;ll want to do fairly often once we start adding add-ons is having an option to quickly have a look at them without needing to open extra browser windows.</p><p>For this, we&rsquo;ll make use of [iframe Panel][iframe]&rsquo;s.
This integration will add additional panels to the Home Assistant sidebar, which will open an application of our choosing within the HA dashboard.</p><p>To add an iframe for Portainer, add the following code to the <code>configuration.yaml</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>panel_iframe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>portainer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>Portainer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://192.168.10.106:9000/#!/2/docker/containers&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>mdi:docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>require_admin</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Check your configuration again and restart Home Assistant.
Once Home Assistant is back online, you&rsquo;ll find the Docker logo in the sidebar and clicking it will open Portainer in the dashboard view.</p><figure class=center><img src=cover.png alt="Portainer from within Home Assistant"><figcaption class=center>Portainer-ception</figcaption></figure><p>And that wraps it up for part 3 of the Home Assistant Container series.</p><p>Next we&rsquo;ll add some useful add-ons to Home Assistant, like the Mosquitto MQTT broker and NodeRED.</p><p>PS: the eagle-eyed may have noticed an additional container in my last screenshot.
I also added <code>adminer</code> to my toolkit.
Adminer, formerly known as phpMyAdmin, can be used to connect to and manage the MariaDB database.</p><p>If you want to copy my config, add the following service to <code>docker-compose.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>adminer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>adminer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>adminer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8080:8080/tcp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mariadb</span><span class=w>
</span></span></span></code></pre></div><p>[iframe]: <a href=https://www.home-assistant.io/integrations/panel_iframe/ target=_blank rel=noopener>https://www.home-assistant.io/integrations/panel_iframe/</a> &ldquo;iframe Panel integration</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sequr.be/tags/home-automation/>Home Automation</a></span>
<span class=tag><a href=https://sequr.be/tags/home-assistant/>Home Assistant</a></span>
<span class=tag><a href=https://sequr.be/tags/container/>Container</a></span>
<span class=tag><a href=https://sequr.be/tags/docker/>Docker</a></span>
<span class=tag><a href=https://sequr.be/tags/docker-compose/>docker-compose</a></span>
<span class=tag><a href=https://sequr.be/tags/mariadb/>MariaDB</a></span>
<span class=tag><a href=https://sequr.be/tags/recorder/>recorder</a></span>
<span class=tag><a href=https://sequr.be/tags/influxdb/>InfluxDB</a></span>
<span class=tag><a href=https://sequr.be/tags/history/>history</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://sequr.be/categories/home-automation/>Home Automation</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1155 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-09-03</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsequr.be%2fblog%2f2022%2f09%2fhome-assistant-container-part-3-mariadb-and-influxdb%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f09%2fhome-assistant-container-part-3-mariadb-and-influxdb%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f09%2fhome-assistant-container-part-3-mariadb-and-influxdb%2f&resubmit=true&title=Home%20Assistant%20Container%20Part%203%3a%20MariaDB%20and%20InfluxDB" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Home%20Assistant%20Container%20Part%203%3a%20MariaDB%20and%20InfluxDB%20https%3a%2f%2fsequr.be%2fblog%2f2022%2f09%2fhome-assistant-container-part-3-mariadb-and-influxdb%2f" target=_blank rel=noopener aria-label title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"/></svg></div></div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://sequr.be/blog/2022/09/home-assistant-container-part-2-home-assistant-container/><span class=button__text>Home Assistant Container Part 2: Home Assistant Container</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2019-2022</span>
<span><a href=https://sequr.be>DezeStijn</a></span>
<span><a href=https://sequr.be/blog/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><small><span>Powered by <a href='\"http://gohugo.io\"'>Hugo</a>.</span>
<span>Made with &#10084; by <a href='\"https://github.com/rhazdon\"'>Djordje Atlialp</a></span><br><span>Deployed using <a href=https://github.com/TheGroundZero/TheGroundZero.github.io/ title=TheGroundZero/TheGroundZero.github.io>GitHub Pages</a></span></small></div></div></footer></div><script type=text/javascript src=https://sequr.be/bundle.min.cf7fb2a9e24608a783e05e4472da2fdf008293289de1ad88d1cba5c143e7e414496dd33b6a228e92f8461ce0c8cbad3c9f9847e73e46dfbce0463393ddd1733a.js integrity="sha512-z3+yqeJGCKeD4F5Ectov3wCCkyid4a2I0culwUPn5BRJbdM7aiKOkvhGHODIy608n5hH5z5G37zgRjOT3dFzOg=="></script></body></html>