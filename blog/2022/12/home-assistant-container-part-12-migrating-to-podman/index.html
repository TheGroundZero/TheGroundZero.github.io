<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="DezeStijn"><meta name=description content="We&amp;rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta name=keywords content="Sequr,blog,writeup,CTF,challenge,machine,infosec,IT security,hacking,pentesting,cybersecurity,Home Automation,Home Assistant,Container,Docker,Podman,Fedora"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/><title>Home Assistant Container Part 12: Migrating to Podman :: Sequr</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sequr.be/main.031a8efc33f94f55a4071bf4e91596478a5809fc8c148fab113801189cfd2152.css><link rel=stylesheet type=text/css href=https://sequr.be/css/table.css><link rel=stylesheet type=text/css href=https://sequr.be/css/menu.css><link rel=apple-touch-icon sizes=180x180 href=https://sequr.be/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sequr.be/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sequr.be/favicon-16x16.png><link rel=manifest href=https://sequr.be/site.webmanifest><link rel=mask-icon href=https://sequr.be/safari-pinned-tab.svg color=#e68101><link rel="shortcut icon" href=https://sequr.be/favicon.ico><meta name=msapplication-TileColor content="#e68101"><meta name=theme-color content="#e68101"><meta itemprop=name content="Home Assistant Container Part 12: Migrating to Podman"><meta itemprop=description content="We&rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta itemprop=datePublished content="2022-12-02T00:00:00+00:00"><meta itemprop=dateModified content="2022-12-03T00:00:00+00:00"><meta itemprop=wordCount content="5309"><meta itemprop=image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Container,Docker,Podman,Fedora,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta name=twitter:title content="Home Assistant Container Part 12: Migrating to Podman"><meta name=twitter:description content="We&rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta property="article:section" content="Home Automation"><meta property="article:section" content="HA Container"><meta property="article:published_time" content="2022-12-02 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sequr.be/ style=text-decoration:none><div class=logo><span class=logo__mark>$</span>
<span class=logo__text>nc sequr.be 1337</span>
<span class=logo__cursor style=background-color:#e68101></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sequr.be/blog/>Blog</a></li><li><a href=https://sequr.be/about/>About</a></li><li><a href=https://sequr.be/shoppinglist/>Shopping</a></li><li><a href=https://sequr.be/privacy/>Privacy</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>25 minutes</p></div><article><h1 class=post-title><a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/>Home Assistant Container Part 12: Migrating to Podman</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#fedora-core-os>Fedora Core OS</a><ul><li><a href=#preparing-live-usb>Preparing Live USB</a></li><li><a href=#preparing-ignition-configuration>Preparing Ignition configuration</a></li><li><a href=#installing-fedora-coreos>Installing Fedora CoreOS</a></li><li><a href=#finishing-touches>Finishing touches</a><ul><li><a href=#linger>Linger</a></li><li><a href=#directory-structure>Directory structure</a></li></ul></li></ul></li><li><a href=#podman-setup>Podman setup</a><ul><li><a href=#podman-autoupdate>Podman Autoupdate</a></li></ul></li><li><a href=#podman-containers>Podman containers</a><ul><li><a href=#certbot-and-letsencrypt>Certbot and LetsEncrypt</a></li><li><a href=#nginx-reverse-proxy>Nginx reverse proxy</a><ul><li><a href=#firewall-config>Firewall config</a></li></ul></li><li><a href=#home-assistant>Home Assistant</a></li><li><a href=#mosquitto-mqtt-broker>Mosquitto MQTT Broker</a></li><li><a href=#zigbee2mqtt>Zigbee2MQTT</a><ul><li><a href=#container-permissions-and-selinux>Container permissions and SELinux</a></li><li><a href=#config>Config</a></li></ul></li><li><a href=#zwave2mqtt>ZWave2MQTT</a></li><li><a href=#esphome>ESPHome</a></li><li><a href=#hass-configurator>HASS Configurator</a></li></ul></li><li><a href=#sidebar>Sidebar</a></li><li><a href=#backups>Backups</a><ul><li><a href=#backup-to-nas-over-nfs>Backup to NAS over NFS</a><ul><li><a href=#mount-backup-folder>Mount backup folder</a></li><li><a href=#backup-script>Backup script</a></li><li><a href=#crontab>Crontab</a></li></ul></li></ul></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service.</a></li><li><a href=#i-cant-modify-container-files>I can&rsquo;t modify container files</a></li><li><a href=#error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY</a></li><li><a href=#checkmodule-command-not-found>checkmodule: command not found</a></li><li><a href=#selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts</a></li></ul></li><li><a href=#changelog>Changelog</a></li></ul></nav></aside><hr><div class=post-content><h2 id=intro>Intro <a href=#intro>¶</a></h2><p>From the <a href=https://docs.podman.io/en/latest/ title="Podman documentation" target=_blank rel=noopener>Podman documentation</a>:</p><blockquote><p>Podman is a daemonless, open source, Linux native tool designed to make it easy to find, run, build, share and deploy applications using Open Containers Initiative (OCI) Containers and Container Images.
Podman provides a command line interface (CLI) familiar to anyone who has used the Docker Container Engine. Most users can simply alias Docker to Podman <em>(alias docker=podman)</em> without any problems.
Similar to other common Container Engines (Docker, CRI-O, containerd), Podman relies on an OCI compliant Container Runtime (runc, crun, runv, etc) to interface with the operating system and create the running containers.
This makes the running containers created by Podman nearly indistinguishable from those created by any other common container engine.</p></blockquote><p>In a timespan of 2 or 3 days my no-brand M.2 SSD crapped itself, destroying my HA Container setup with it, and we had a discussion at work re. Docker licenses and open-source alternatives, Podman being one of them.
These events made me decide to start over with a new Podman-based setup of Home Assistant Container as soon as my newly ordered Crucial SATA SSD had arrived.
Sadly I didn&rsquo;t have the chance to document my the changes I did to my Docker setup using macvlan&rsquo;s. I would have loved to share that as well.</p><p>This blog post will be kind of a logbook of the steps I&rsquo;ve taken to set everything up.
Most &ndash; if not all &ndash; will be based on a topic in the HA forums: <a href=https://community.home-assistant.io/t/work-in-progress-configuration-for-running-a-home-assistant-in-containers-with-systemd-and-podman-on-fedora-iot title="Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT" target=_blank rel=noopener>Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT</a>.</p><p>Note that this does not negate anything we did so far in the <a href=https://sequr.be/categories/ha-container/ title="HA Container series">Home Assistant Container series</a> so far and you&rsquo;re still free to use Docker Compose to do your setup.</p><h2 id=fedora-core-os>Fedora Core OS <a href=#fedora-core-os>¶</a></h2><figure class=center><img src=fedora-coreos-logo.png alt="Fedora CoreOS logo"><figcaption class=center>Fedora CoreOS</figcaption></figure><p>I&rsquo;m no linux/unix expert and so far I&rsquo;ve been running mainly Debian and Ubuntu VMs.
But as I&rsquo;m already making things complicated for myself by starting from scratch and learning to work with a new container manager as I go, I decided to make it extra hard on myself and learn how to work with <a href=https://getfedora.org/en/coreos title="Fedora CoreOS" target=_blank rel=noopener>Fedora CoreOS</a> as well.</p><blockquote><p>Fedora CoreOS is an automatically-updating, minimal operating system for running containerized workloads securely and at scale.
It is currently available on multiple platforms, with more coming soon.</p></blockquote><p>Fedora CoreOS also comes with Docker and Podman installed by default.</p><p>I installed Fedora CoreOS bare-metal on my <a href=https://s.click.aliexpress.com/e/_DkZ6gPh title="Beelink Mini S with Intel 11th Gen N5095 CPU" target=_blank rel=noopener>Beelink</a> (after installing a new SSD) using the Live USB image.</p><h3 id=preparing-live-usb>Preparing Live USB <a href=#preparing-live-usb>¶</a></h3><ol><li><a href="https://getfedora.org/en/coreos/download?tab=metal_virtualized&stream=stable&arch=x86_64" title="Download Fedora CoreOS" target=_blank rel=noopener>Download</a> the Fedora Core OS Bare Metal ISO.<br>I recommend getting it from the Stable stream.</li><li>Follow the steps to verify your download.<br>Download the checksum file and signature, import Fedora&rsquo;s GPG key, verify the validity of the signature, and verify the checksum matches.<br>This way, you&rsquo;re certain your downloaded ISO isn&rsquo;t corrupted or altered along the way.</li><li>If you&rsquo;re on Linux or Mac, write the ISO image to your USB drive using <code>dd</code>.<br>Make sure you fully understand what you&rsquo;re doing here!<br><code>sudo dd bs=4M if=fedora-coreos-36.20221030.3.0-live.x86_64.iso of=/dev/sdb conv=fdatasync status=progress</code>
If you&rsquo;re on Windows, use a tool like balenaEtcher.</li></ol><p>Once the writing process is done, you can (safely) eject your USB drive from your computer and plug it in your target system.</p><h3 id=preparing-ignition-configuration>Preparing Ignition configuration <a href=#preparing-ignition-configuration>¶</a></h3><p>Fedora doesn&rsquo;t come with default credentials.
So later, when we install Fedora CoreOS on our system, we won&rsquo;t be able to login on the console or over SSH.</p><p>To solve this, we&rsquo;ll create an Ignition configuration which will be read by the setup process and which we&rsquo;ll use to setup our account.</p><blockquote><p>Ignition is a provisioning utility that reads a configuration file (in JSON format) and provisions a Fedora CoreOS system based on that configuration.</p></blockquote><p>We start of by creating a Butane configuration file.
In this configuration file, we create 2 accounts <code>core</code> and <code>hass</code> with <a href=https://sequr.be/blog/2020/09/upgrade-your-ssh-keys-to-ed25519/#upgrade-to-ed25519-keys title="Generate ED25 SSH keys">SSH keys</a>.
The <code>core</code> user is added to the <code>wheel</code> group so it gets sudo rights and the <code>hass</code> user is added to the <code>dialout</code> group.</p><p>We also add a systemd config that will download and launch <code>etcd</code> at boot.</p><blockquote><p><a href=https://etcd.io/ title="A distributed, reliable key-value store for the most critical data of a distributed system" target=_blank rel=noopener>etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.
It gracefully handles leader elections during network partitions and can tolerate machine failure, even in the leader node.</p></blockquote><p>And we also setup auto-updates to not be too eager on updating and to only allow reboots in a specific timeslot.</p><p><code>fedoracore.be</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variant</span><span class=p>:</span><span class=w> </span><span class=l>fcos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.4.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>passwd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ssh_authorized_keys</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>ssh-ed25519 AA...</span><span class=w> </span><span class=c># UPDATE THIS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>wheel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ssh_authorized_keys</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>ssh-ed25519 AA...</span><span class=w> </span><span class=c># UPDATE THIS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>dialout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>contents</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>inline: fedoracore  # Optional</span><span class=p>:</span><span class=w> </span><span class=l>change this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># OPTIONAL - Wariness to updates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://docs.fedoraproject.org/en-US/fedora-coreos/auto-updates/#_wariness_to_updates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/zincati/config.d/51-rollout-wariness.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>contents</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>inline</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          [identity]
</span></span></span><span class=line><span class=cl><span class=sd>          rollout_wariness = 0.75</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># OPTIONAL - Update Strategy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://coreos.github.io/zincati/usage/updates-strategy/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/zincati/config.d/55-updates-strategy.toml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>contents</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>inline</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          [updates]
</span></span></span><span class=line><span class=cl><span class=sd>          strategy = &#34;periodic&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          [[updates.periodic.window]]
</span></span></span><span class=line><span class=cl><span class=sd>          days = [ &#34;Sat&#34;, &#34;Sun&#34; ]
</span></span></span><span class=line><span class=cl><span class=sd>          start_time = &#34;22:45&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          length_minutes = 60</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>systemd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>units</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etcd-member.service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>contents</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        [Unit]
</span></span></span><span class=line><span class=cl><span class=sd>        Description=Run a single node etcd
</span></span></span><span class=line><span class=cl><span class=sd>        After=network-online.target
</span></span></span><span class=line><span class=cl><span class=sd>        Wants=network-online.target
</span></span></span><span class=line><span class=cl><span class=sd>        [Service]
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStartPre=mkdir -p /var/lib/etcd
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStartPre=-/bin/podman kill etcd
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStartPre=-/bin/podman rm etcd
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStartPre=-/bin/podman pull quay.io/coreos/etcd
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStart=/bin/podman run --name etcd --net=host \
</span></span></span><span class=line><span class=cl><span class=sd>                    --volume /var/lib/etcd:/etcd-data:z  \
</span></span></span><span class=line><span class=cl><span class=sd>                    quay.io/coreos/etcd:latest /usr/local/bin/etcd              \
</span></span></span><span class=line><span class=cl><span class=sd>                            --data-dir /etcd-data --name node1                  \
</span></span></span><span class=line><span class=cl><span class=sd>                            --initial-advertise-peer-urls http://127.0.0.1:2380 \
</span></span></span><span class=line><span class=cl><span class=sd>                            --listen-peer-urls http://127.0.0.1:2380            \
</span></span></span><span class=line><span class=cl><span class=sd>                            --advertise-client-urls http://127.0.0.1:2379       \
</span></span></span><span class=line><span class=cl><span class=sd>                            --listen-client-urls http://127.0.0.1:2379          \
</span></span></span><span class=line><span class=cl><span class=sd>                            --initial-cluster node1=http://127.0.0.1:2380
</span></span></span><span class=line><span class=cl><span class=sd>        ExecStop=/bin/podman stop etcd
</span></span></span><span class=line><span class=cl><span class=sd>        [Install]
</span></span></span><span class=line><span class=cl><span class=sd>        WantedBy=multi-user.target</span><span class=w>        
</span></span></span></code></pre></div><p>To convert this Butane configuration file into an Ignition config, we need the Butane tool.
There are multiple methods to get Butane, like using a Podman <a href=https://quay.io/repository/coreos/butane title=coreos/butane target=_blank rel=noopener>container</a> or by using a distribution-provided package, but I opted for the <a href=https://github.com/coreos/butane/releases title="Butane releases" target=_blank rel=noopener>standalone</a> executable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://getfedora.org/static/fedora.gpg <span class=p>|</span> gpg --import
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check latest version at https://github.com/coreos/butane/releases</span>
</span></span><span class=line><span class=cl>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu
</span></span><span class=line><span class=cl>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu.asc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gpg --verify butane-x86_64-unknown-linux-gnu.asc
</span></span></code></pre></div><p>Finally to convert the configuration file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod u+x butane-x86_64-unknown-linux-gnu
</span></span><span class=line><span class=cl>./butane-x86_64-unknown-linux-gnu --pretty --strict fedoracore.be <span class=p>|</span> tee fedoracore.ign
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ignition&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;version&#34;</span>: <span class=s2>&#34;3.3.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;passwd&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;users&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;groups&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;wheel&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;core&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sshAuthorizedKeys&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;groups&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dialout&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;hass&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sshAuthorizedKeys&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;storage&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;files&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;path&#34;</span>: <span class=s2>&#34;/etc/hostname&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;contents&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;compression&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;source&#34;</span>: <span class=s2>&#34;data:,fedoracore&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;mode&#34;</span>: <span class=m>420</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;systemd&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;units&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;contents&#34;</span>: <span class=s2>&#34;[Unit]\nDescription=Run a single node etcd\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStartPre=mkdir -p /var/lib/etcd\nExecStartPre=-/bin/podman kill etcd\nExecStartPre=-/bin/podman rm etcd\nExecStartPre=-/bin/podman pull quay.io/coreos/etcd\nExecStart=/bin/podman run --name etcd --net=host \\\n            --volume /var/lib/etcd:/etcd-data:z  \\\n            quay.io/coreos/etcd:latest /usr/local/bin/etcd              \\\n                    --data-dir /etcd-data --name node1                  \\\n                    --initial-advertise-peer-urls http://127.0.0.1:2380 \\\n                    --listen-peer-urls http://127.0.0.1:2380            \\\n                    --advertise-client-urls http://127.0.0.1:2379       \\\n                    --listen-client-urls http://127.0.0.1:2379          \\\n                    --initial-cluster node1=http://127.0.0.1:2380\nExecStop=/bin/podman stop etcd\n\n[Install]\nWantedBy=multi-user.target\n&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;enabled&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;etcd-member.service&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We will need to make this configuration file available to our system over the network.
Either by hosting it locally on a (temporary) webserver or by hosting it online.</p><p>I opted to use a temporary file host service named tmpfiles.org.
This is not an endorsement of this service.
Always be cautious when sharing/uploading configurations with potentially sensitive information (like SSH pubkeys) with an unknown 3rd party!</p><h3 id=installing-fedora-coreos>Installing Fedora CoreOS <a href=#installing-fedora-coreos>¶</a></h3><p>Now we&rsquo;re ready to install Fedora on our system via the Live USB.</p><ol><li>Plug the USB in the target system.</li><li>Power up the system and spam the <code>ESC</code> button on your keyboard.</li><li>Make sure you boot from USB.</li><li>Confirm the path of the system&rsquo;s hard drive (probably <code>/dev/sda</code>).<br><code>sudo fdisk -l</code></li><li>Run the following command in the terminal to launch the installer.<br>Don&rsquo;t forget to modify the url to your Ignition config.<br><code>sudo coreos-installer install /dev/sda --ignition-url https://example.com/example.ign</code></li><li>Once the installer has finished, reboot the system and unplug the USB.<br><code>sudo reboot</code></li></ol><h3 id=finishing-touches>Finishing touches <a href=#finishing-touches>¶</a></h3><p>Now you can SSH into Fedora system from your own computer.</p><p><code>ssh -i ~/.ssh/id_fc_core core@IP.OF.YOUR.BOX</code></p><h4 id=linger>Linger <a href=#linger>¶</a></h4><p>We&rsquo;ll be setting up our containers using systemd.
To keep systemd from stopping all of your containers when you log out, we enable <em>linger</em> on the <code>hass</code> account.</p><p><code>sudo loginctl enable-linger hass</code></p><h4 id=directory-structure>Directory structure <a href=#directory-structure>¶</a></h4><p>Local config will be stored in <code>/srv/hass/</code>.
Grouping everything in one folder makes backing up also a lot easier.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir /srv/hass
</span></span><span class=line><span class=cl>sudo chown -R hass:hass /srv/hass
</span></span></code></pre></div><h2 id=podman-setup>Podman setup <a href=#podman-setup>¶</a></h2><figure class=center><img src=podman-logo.svg alt="Podman logo"><figcaption class=center>Podman</figcaption></figure><p>All Podman config will be done as the <code>hass</code> user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -i ~/.ssh/id_ed25519_fc_hass hass@&lt;ip.of.your.systen&gt;
</span></span></code></pre></div><p>Still following the guide from the HA Forum, we&rsquo;ll be setting up multiple containers.</p><p>This includes a Certbot and Nginx reverse proxy container to provide external access to your Home Assistance instance.
If you prefer to setup remote access via the Nabu Casa cloud, you won&rsquo;t need these.</p><h3 id=podman-autoupdate>Podman Autoupdate <a href=#podman-autoupdate>¶</a></h3><p>Podman has an auto-update feature which is triggered via a timer.
We&rsquo;ll enable this in our user session as that&rsquo;s where we&rsquo;ll be running our rootless containers in.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now podman-auto-update.timer
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/podman-auto-update.timer → /usr/lib/systemd/user/podman-auto-update.timer.
</span></span></code></pre></div><h2 id=podman-containers>Podman containers <a href=#podman-containers>¶</a></h2><h3 id=certbot-and-letsencrypt>Certbot and LetsEncrypt <a href=#certbot-and-letsencrypt>¶</a></h3><p>If you want valid SSL certificates (also required for the Companion app), you&rsquo;ll need your own domain name.
I advise using a registrar that supports the DNS challenge type for the certbot.
That way you don&rsquo;t need to expose any systems to request certificates.
You can even get a wildcard <code>*.yourdomain.tld</code> certificate so you don&rsquo;t even need to setup public domain names for your systems.
Another advantage is that you don&rsquo;t run into issues with a changing public IP for doing the web challenge, which requires setting up Dynamic DNS as a fix.</p><p>We&rsquo;ll create a file to store our secrets (keys for the challenge) and a directory for the certbot container to store its files.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /srv/hass/certbot
</span></span><span class=line><span class=cl>mkdir -p /srv/hass/secret
</span></span></code></pre></div><p><code>/srv/hass/secret/certbot-creds</code></p><pre tabindex=0><code>dns_ovh_endpoint = ovh-eu
dns_ovh_application_key = MDAwMDAwMDAwMDAw
dns_ovh_application_secret = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
dns_ovh_consumer_key = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
</code></pre><p>The exact config for Certbot will depend on your registrar and your own domain name.<br>In my case, I&rsquo;m using OVH.
I might add a blog post on how to get the necessary keys and tokens for the OVH DNS challenge.</p><p><code>~/.config/systemd/user/container-certbot.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>CertBot</span> <span class=nx>container</span> <span class=nx>to</span> <span class=nx>renew</span> <span class=nx>Let</span><span class=err>&#39;</span><span class=nx>s</span> <span class=nx>Encrypt</span> <span class=nx>certificates</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-abnormal</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>3600</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>60</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStartSec</span><span class=p>=</span><span class=mi>10800</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=nx>-</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>create</span> <span class=nx>certbot-creds</span> <span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>secret</span><span class=err>/</span><span class=nx>certbot-creds</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-a</span> <span class=nx>stdout</span> <span class=nx>-a</span> <span class=nx>stderr</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span> <span class=nx>certbot</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>certbot</span><span class=err>:/</span><span class=nx>etc</span><span class=err>/</span><span class=nx>letsencrypt</span><span class=err>:</span><span class=nx>z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--secret</span><span class=p>=</span><span class=nx>certbot-creds</span><span class=p>,</span><span class=nx>mode</span><span class=p>=</span><span class=mi>0400</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>certbot</span><span class=err>/</span><span class=nx>dns-ovh</span> <span class=nx>-n</span> <span class=nx>renew</span> <span class=nx>--dns-ovh</span> <span class=nx>--dns-ovh-credentials</span> <span class=err>/</span><span class=nx>run</span><span class=err>/</span><span class=nx>secrets</span><span class=err>/</span><span class=nx>certbot-creds</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=nx>-</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>rm</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>cert</span> 
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>create</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>cert</span> <span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>certbot</span><span class=err>/</span><span class=nx>live</span><span class=err>/</span><span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=err>/</span><span class=nx>fullchain</span><span class=p>.</span><span class=nx>pem</span> 
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=nx>-</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>rm</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>key</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>create</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>key</span> <span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>certbot</span><span class=err>/</span><span class=nx>live</span><span class=err>/</span><span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=err>/</span><span class=nx>privkey</span><span class=p>.</span><span class=nx>pem</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>oneshot</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Notice how this service config uses <code>podman secret create</code> to pass our certbot credentials to the container.
It also removes this secret when the service is stopped.</p><p>Because the order of actions, specifically the pre and post, matters <code>Type=oneshot</code> is used here.</p><p><code>~/.config/systemd/user/container-certbot.timer</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>Renews</span> <span class=nx>any</span> <span class=nx>certificates</span> <span class=nx>that</span> <span class=nx>need</span> <span class=nx>them</span> <span class=nx>renewed</span>
</span></span><span class=line><span class=cl><span class=nx>Requires</span><span class=p>=</span><span class=nx>container-certbot</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Timer</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Unit</span><span class=p>=</span><span class=nx>container-certbot</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>OnCalendar</span><span class=p>=</span><span class=nx>weekly</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>timers</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Then enable the timer service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-certbot.timer
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/container-certbot.timer → /var/home/hass/.config/systemd/user/container-certbot.timer.
</span></span></code></pre></div><p>We do need to manually run the certbot tool once to get our certificates, which the renew service will keep up-to-date.
We&rsquo;ll also accept the Terms of Service of LetsEncrypt and we give them an email address to remind us of expiring certs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/usr/bin/podman secret create certbot-creds /srv/hass/secret/certbot-creds
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/usr/bin/podman run <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cgroups<span class=o>=</span>no-conmon <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--sdnotify<span class=o>=</span>conmon <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-a stdout -a stderr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--name certbot <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--volume<span class=o>=</span>/srv/hass/certbot:/etc/letsencrypt:z <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--secret<span class=o>=</span>certbot-creds,mode<span class=o>=</span><span class=m>0400</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	docker.io/certbot/dns-ovh certonly <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		-n --agree-tos --email certbot@example.org <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--dns-ovh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--dns-ovh-credentials /run/secrets/certbot-creds <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		-d *.example.org
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Saving debug log to /var/log/letsencrypt/letsencrypt.log
</span></span><span class=line><span class=cl>Account registered.
</span></span><span class=line><span class=cl>Requesting a certificate <span class=k>for</span> *.example.org
</span></span><span class=line><span class=cl>Waiting <span class=m>120</span> seconds <span class=k>for</span> DNS changes to propagate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Successfully received certificate.
</span></span><span class=line><span class=cl>Certificate is saved at: /etc/letsencrypt/live/example.org/fullchain.pem
</span></span><span class=line><span class=cl>Key is saved at:         /etc/letsencrypt/live/example.org/privkey.pem
</span></span><span class=line><span class=cl>This certificate expires on 2023-02-23.
</span></span><span class=line><span class=cl>These files will be updated when the certificate renews.
</span></span><span class=line><span class=cl>NEXT STEPS:
</span></span><span class=line><span class=cl>- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to <span class=nb>enable</span> that functionality. See https://certbot.org/renewal-setup <span class=k>for</span> instructions.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span class=line><span class=cl>If you like Certbot, please consider supporting our work by:
</span></span><span class=line><span class=cl> * Donating to ISRG / Let<span class=err>&#39;</span>s Encrypt:   https://letsencrypt.org/donate
</span></span><span class=line><span class=cl> * Donating to EFF:                    https://eff.org/donate-le
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span></code></pre></div><p>Running the renew service once after this, will also ensure our certs are stored as Podman secrets.
These secrets will hold the SSL cert and private key and will be shared with the Nginx reverse proxy container.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user start container-certbot.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>podman secret ls
</span></span><span class=line><span class=cl>ID                         NAME              DRIVER      CREATED         UPDATED
</span></span><span class=line><span class=cl>219a7a4790c900f313e0fd44f  example.org.key   file        <span class=m>15</span> minutes ago  <span class=m>15</span> minutes ago
</span></span><span class=line><span class=cl>62ff3f2b637f31917f4fc0234  certbot-creds     file        <span class=m>45</span> minutes ago  <span class=m>45</span> minutes ago
</span></span><span class=line><span class=cl>f8a3cafb519fc30df6e24b8b9  example.org.cert  file        <span class=m>15</span> minutes ago  <span class=m>15</span> minutes ago
</span></span></code></pre></div><h3 id=nginx-reverse-proxy>Nginx reverse proxy <a href=#nginx-reverse-proxy>¶</a></h3><p>The Nginx reverse proxy will be the bridge between the internet and Home Assistant.</p><p>The <em>exposed</em> port of the Nginx container is deliberately set to a so-called non-privileged port (>1024) so we can keep our container rootless.
Using port forwarding on our router, we can open ports 80/tcp (HTTP) and 443/tcp (HTTPS) on the router while referring to ports 9080/tcp and 9443/tcp respectively on the container.
The proxy will then, based on the hostname, forward the connection to our Home Assistant instance using the IP of our podman&rsquo;s virtual network gateway <code>10.0.2.2</code> (see <code>proxy_pass</code>).</p><p>Let&rsquo;s start of with the config for the proxy.
Don&rsquo;t forget to update the following:</p><ul><li>Name of the SSL certificate and private key.</li><li><code>server_name</code> to match your Home Assistant hostname.<br>A <code>server_name</code> of <code>_</code> will match any domain name. We use this to forward HTTP to HTTPS but I&rsquo;d advise NOT to redirect any random hostname to your Home Assistant instance.</li></ul><p><code>/srv/hass/nginx/nginx.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>worker_processes</span> <span class=err>auto;</span>
</span></span><span class=line><span class=cl><span class=err>error_log</span> <span class=err>/dev/stdout</span> <span class=err>info;</span>
</span></span><span class=line><span class=cl><span class=err>pid</span> <span class=err>/run/nginx.pid;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>include</span> <span class=err>/usr/share/nginx/modules/mod-stream.conf;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>events</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>worker_connections</span> <span class=err>1024;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>map</span> <span class=err>$http_upgrade</span> <span class=err>$connection_upgrade</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>        <span class=err>default</span> <span class=err>upgrade;</span>
</span></span><span class=line><span class=cl>        <span class=err>&#39;&#39;</span> <span class=err>close;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>ssl_certificate</span> <span class=s2>&#34;/run/secrets/example.org.cert&#34;</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=err>ssl_certificate_key</span> <span class=s2>&#34;/run/secrets/example.org.key&#34;</span><span class=err>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>listen</span> <span class=err>9080;</span>
</span></span><span class=line><span class=cl>        <span class=err>listen</span> <span class=err>[::]:9080;</span>
</span></span><span class=line><span class=cl>        <span class=err>server_name</span>  <span class=err>_;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>return</span> <span class=err>301</span> <span class=err>https:</span><span class=c1>//$host$request_uri;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>listen</span> <span class=err>9443</span> <span class=err>ssl</span> <span class=err>http2;</span>
</span></span><span class=line><span class=cl>        <span class=err>listen</span> <span class=err>[::]:9443</span> <span class=err>ssl</span> <span class=err>http2;</span>
</span></span><span class=line><span class=cl>        <span class=err>server_name</span>  <span class=err>homeassistant.example.org;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>ssl_session_cache</span> <span class=err>shared:SSL:1m;</span>
</span></span><span class=line><span class=cl>        <span class=err>ssl_session_timeout</span>  <span class=err>10m;</span>
</span></span><span class=line><span class=cl>        <span class=err>ssl_ciphers</span> <span class=err>PROFILE=SYSTEM;</span>
</span></span><span class=line><span class=cl>        <span class=err>ssl_prefer_server_ciphers</span> <span class=err>on;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>proxy_buffering</span> <span class=err>off;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>location</span> <span class=err>/</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=err>proxy_pass</span> <span class=err>http:</span><span class=c1>//10.0.2.2:8123;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host;</span>
</span></span><span class=line><span class=cl>            <span class=err>proxy_http_version</span> <span class=err>1.1;</span>
</span></span><span class=line><span class=cl>            <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-For</span> <span class=err>$proxy_add_x_forwarded_for;</span>
</span></span><span class=line><span class=cl>            <span class=err>proxy_set_header</span> <span class=err>Upgrade</span> <span class=err>$http_upgrade;</span>
</span></span><span class=line><span class=cl>            <span class=err>proxy_set_header</span> <span class=err>Connection</span> <span class=err>$connection_upgrade;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span></code></pre></div><p>Next is the config for the Nginx container.</p><p>Don&rsquo;t forget to modify the name of the secrets to match your config.</p><p><code>~/.config/systemd/user/container-nginx.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>Nginx</span> <span class=nx>Reverse</span> <span class=nx>Proxy</span> <span class=nx>in</span> <span class=nx>a</span> <span class=nx>container</span>
</span></span><span class=line><span class=cl><span class=nx>Documentation</span><span class=p>=</span><span class=nx>man</span><span class=err>:</span><span class=nx>podman-generate-systemd</span><span class=err>(</span><span class=mi>1</span><span class=err>)</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>container-certbot</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>container-certbot</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span> <span class=nx>nginx</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--net</span> <span class=nx>slirp4netns</span><span class=err>:</span><span class=nx>allow_host_loopback</span><span class=p>=</span><span class=kc>true</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>9080</span><span class=err>:</span><span class=mi>9080</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>9443</span><span class=err>:</span><span class=mi>9443</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>nginx</span><span class=err>/</span><span class=nx>nginx</span><span class=p>.</span><span class=nx>conf</span><span class=err>:/</span><span class=nx>etc</span><span class=err>/</span><span class=nx>nginx</span><span class=err>/</span><span class=nx>nginx</span><span class=p>.</span><span class=nx>conf</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--secret</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>cert</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--secret</span> <span class=nx>example</span><span class=p>.</span><span class=nx>org</span><span class=p>.</span><span class=nx>key</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>registry</span><span class=p>.</span><span class=nx>access</span><span class=p>.</span><span class=nx>redhat</span><span class=p>.</span><span class=nx>com</span><span class=err>/</span><span class=nx>ubi8</span><span class=err>/</span><span class=nx>nginx-120</span><span class=err>:</span><span class=nx>latest</span> <span class=nx>nginx</span> <span class=nx>-g</span> <span class=s2>&#34;daemon off;&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>We can now launch the container, even though the redirect won&rsquo;t function yet.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-nginx.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-nginx.service → /var/home/hass/.config/systemd/user/container-nginx.service.
</span></span></code></pre></div><h4 id=firewall-config>Firewall config <a href=#firewall-config>¶</a></h4><p>Now set up your firewall/router to port forward ports 80/tcp and 443/tcp on your WAN (internet) side to ports 9080/tcp and 9443/tcp on your Fedora system respectively.</p><h3 id=home-assistant>Home Assistant <a href=#home-assistant>¶</a></h3><p>This Home Assistant container has got a few <em>features</em>.</p><p>First of all, it <em>wants</em> (but doesn&rsquo;t <em>require</em>) the Z-Wave and Zigbee containers to be alive but won&rsquo;t shutdown if they&rsquo;re not.
You can comment these lines out if you won&rsquo;t have these running anyway.
I&rsquo;ll comment out the Z-Wave lines as I don&rsquo;t use it in my Home Assistant setup.</p><p>Secondly, there&rsquo;s a custom <a href=https://github.com/brianegge/home-assistant-sdnotify title=brianegge/home-assistant-sdnotify target=_blank rel=noopener>watchdog</a> service that will ensure the container restarts if Home Assistant ends up in a error state without exiting.
Since we first need to setup HA before we can install the watchdog, we&rsquo;ll comment out the its config for now.
I&rsquo;m keeping it in the config below for future reference.</p><p>Also, like with the Certbot container setup, we need to make sure the folder for the HA config exists.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /srv/hass/hass
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-homeassistant.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>Home</span> <span class=nx>Assistant</span> <span class=nx>Container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl><span class=c># Wants=container-zwave.service</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>container-zigbee</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=c># After=container-zwave.service</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>container-zigbee</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span> <span class=nx>WATCHDOG_USEC</span><span class=p>=</span><span class=mi>5000000</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=c># Note: this is using https://github.com/brianegge/home-assistant-sdnotify.</span>
</span></span><span class=line><span class=cl><span class=c># Once installed, uncomment the `WatchdogSec` line below</span>
</span></span><span class=line><span class=cl><span class=c># and change `--sdnotify=conmon` to `--sdnotify=container`.</span>
</span></span><span class=line><span class=cl><span class=c># WatchdogSec=60</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span><span class=p>=</span><span class=nx>homeassistant</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>hass</span><span class=err>:/</span><span class=nx>config</span><span class=err>:</span><span class=nx>z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--network</span><span class=p>=</span><span class=nx>host</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>ghcr</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>home-assistant</span><span class=err>/</span><span class=nx>home-assistant</span><span class=err>:</span><span class=nx>stable</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Now, again, we start the container.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-homeassistant.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-homeassistant.service → /var/home/hass/.config/systemd/user/container-homeassistant.service.
</span></span></code></pre></div><p>Give it some time and you should finally be able to see a glimpse of Home Assistant appearing at <code>http://ip.of.your.system:8123</code>.</p><figure class=center><img src=home_assistant-welcome.png alt="Home Assistant first setup screen"><figcaption class=center>It&rsquo;s alive!</figcaption></figure><h3 id=mosquitto-mqtt-broker>Mosquitto MQTT Broker <a href=#mosquitto-mqtt-broker>¶</a></h3><p>We will need the Mosquitto MQTT broker when we&rsquo;re setting up the Zigbee2MQTT container.
But a lot of devices and applications can make use of MQTT as message protocol, so I always recomment installing Mosquitto.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /srv/hass/mosquitto/config
</span></span><span class=line><span class=cl>mkdir /srv/hass/mosquitto/data
</span></span><span class=line><span class=cl>mkdir /srv/hass/mosquitto/log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>touch /srv/hass/mosquitto/config/mqttuser
</span></span></code></pre></div><p>The Mosquitto config needs to be present before we start the container.
We can copy our config for Mosquitto from <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/ title="Part 4: Mosquitto Docker Container">our Docker setup</a>.</p><p><code>/srv/hass/mosquitto/config/mosquitto.conf</code></p><pre tabindex=0><code># Listen on port 1883
listener 1883
socket_domain ipv4
# save the in-memory database to disk
persistence true
persistence_location /mosquitto/data/
# Log to stderr and logfile
log_dest stderr
log_dest file /mosquitto/log/mosquitto.log
# Require authentication
allow_anonymous false
password_file /mosquitto/config/mqttuser
</code></pre><p>And yet another service file to autostart out container.</p><p><code>~/.config/systemd/user/container-mosquitto.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>Mosquitto</span> <span class=nx>MQTT</span> <span class=nx>in</span> <span class=nx>a</span> <span class=nx>container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span> <span class=nx>mosquitto</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>1883</span><span class=err>:</span><span class=mi>1883</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>config</span><span class=err>:/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>config</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>data</span><span class=err>:/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>data</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>log</span><span class=err>:/</span><span class=nx>mosquitto</span><span class=err>/</span><span class=nx>log</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>eclipse-mosquitto</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>And start the container.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-mosquitto.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-mosquitto.service → /var/home/hass/.config/systemd/user/container-mosquitto.service.
</span></span></code></pre></div><p>We can now create accounts for the services we&rsquo;ll be using later.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman <span class=nb>exec</span> -it mosquitto mosquitto_passwd -c /mosquitto/config/mqttuser mqtt_ha
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl>Reenter password:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Drop the -c this time or it will wipe out the previous account!</span>
</span></span><span class=line><span class=cl>podman <span class=nb>exec</span> -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser mqtt_z2m
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl>Reenter password:
</span></span></code></pre></div><p>You can see these being added:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /srv/hass/mosquitto/config/mqttuser
</span></span><span class=line><span class=cl>mqtt_ha:<span class=nv>$7$101$Dh</span>*****rM<span class=nv>$3</span>Y********************<span class=o>==</span>
</span></span><span class=line><span class=cl>mqtt_z2m:<span class=nv>$7$101$3</span>t*****L7<span class=nv>$Ir</span>********************<span class=o>==</span>
</span></span></code></pre></div><h3 id=zigbee2mqtt>Zigbee2MQTT <a href=#zigbee2mqtt>¶</a></h3><p>You only need this container if you&rsquo;re using Z2M as Zigbee coordinator.
There&rsquo;s also Zigbee Home Automation (ZHA) that&rsquo;s built-in in Home Assistant and deCONZ by dresden elektronik.</p><h4 id=container-permissions-and-selinux>Container permissions and SELinux <a href=#container-permissions-and-selinux>¶</a></h4><p>Since we&rsquo;re using a Zigbee controller connected over USB, we need to provide permissions to the container to do so,
otherwise SELinux will block the container from doing so.</p><p>Here&rsquo;re I&rsquo;ll also follow the setup by Matthew as I don&rsquo;t have experience with SELinux.
Their setup involves using a custom SELinux module that allows containers to access USB serial devices.</p><p>We&rsquo;ll need sudo rights, so you may need to switch back to our sudo user <code>core</code> for these next steps.</p><p><code>~/container-usbtty.te</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>module</span> <span class=err>container-usbtty</span> <span class=mf>1.0</span><span class=err>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>require</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=err>type</span> <span class=err>container_t;</span>
</span></span><span class=line><span class=cl>	<span class=err>type</span> <span class=err>usbtty_device_t;</span>
</span></span><span class=line><span class=cl>	<span class=err>class</span> <span class=err>chr_file</span> <span class=err>{</span> <span class=err>getattr</span> <span class=err>ioctl</span> <span class=err>lock</span> <span class=err>open</span> <span class=err>read</span> <span class=err>write</span> <span class=p>}</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#=============</span> <span class=err>container_t</span> <span class=err>==============</span>
</span></span><span class=line><span class=cl><span class=err>allow</span> <span class=err>container_t</span> <span class=err>usbtty_device_t:chr_file</span> <span class=p>{</span> <span class=err>getattr</span> <span class=err>ioctl</span> <span class=err>lock</span> <span class=err>open</span> <span class=err>read</span> <span class=err>write</span> <span class=p>}</span><span class=err>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>checkmodule -M -m -o container-usbtty.mod container-usbtty.te
</span></span><span class=line><span class=cl>semodule_package -o container-usbtty.pp -m container-usbtty.mod
</span></span><span class=line><span class=cl>sudo semodule -i  container-usbtty.mod
</span></span></code></pre></div><p>Running into issues with permissions? Check the <a href=#troubleshooting title=Troubleshooting>Troubleshooting</a> section.</p><h4 id=config>Config <a href=#config>¶</a></h4><p>As with the Mosquitto container, we need to provide a config for the Zigbee2MQTT application before starting it up.
And again we can have a look at our <a href=https://sequr.be/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">Docker setup</a> for this.</p><p>Since Nginx is using port 8080, which is the default port for the Zigbee2MQTT dashboard, we tell Z2M to use a different port.</p><p><code>/srv/hass/zigbee/configuration.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Adapter settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serial</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>/dev/zigbee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># MQTT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mqtt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>base_topic</span><span class=p>:</span><span class=w> </span><span class=l>zigbee2mqtt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;!secret server&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;!secret user&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;!secret password&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>client_id</span><span class=p>:</span><span class=w> </span><span class=l>zigbee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Zigbee network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>permit_join</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># Do not allow random devices to connect automatically</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Webserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>frontend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://10.0.2.2:8081&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Devices and groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Extract config to separate files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>devices</span><span class=p>:</span><span class=w> </span><span class=l>devices.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>groups.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Home Assistant integration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>homeassistant</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>advanced</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Zigbee network - auto-generate new keys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pan_id</span><span class=p>:</span><span class=w> </span><span class=l>GENERATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>network_key</span><span class=p>:</span><span class=w> </span><span class=l>GENERATE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Zigbee network - set channel to avoid interference with 2.4GHz WiFi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>channel</span><span class=p>:</span><span class=w> </span><span class=m>24</span><span class=w>
</span></span></span></code></pre></div><p>I haven&rsquo;t found a method to store the secrets mentioned in the config above as a Podman secret.
The issue is that secrets are mounted at <code>/run/secrets/secretname</code> and Z2M expects the file to be named <code>secret.yaml</code> and be stored in the same folder as <code>configuration.yaml</code>.
So for the moment, I store the secrets file next to the configuration file in the config folder.</p><p>I hope a change to <a href=https://github.com/Koenkk/zigbee2mqtt/issues/15226 title="Github issue @ Z2M - [Feature request]: Allow defining location of secret.yaml #15226" target=_blank rel=noopener>Zigbee2MQTT</a> or <a href=https://github.com/containers/podman/issues/16649 title="Github issue @ podman - [FEATURE REQUEST] Mount secret at different location #16649" target=_blank rel=noopener>Podman</a> can help fix this.</p><p><code>/srv/hass/zigbee/secret.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;mqtt://10.0.2.2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;mqtt_z2m&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;MySuperSecretPa$$w0rd&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Don&rsquo;t forget to change the <code>device</code> path in the config below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls -l /dev/serial/by-id/
</span></span><span class=line><span class=cl>usb-ITead_Sonoff_Zigbee_3.0_USB_Dongle_Plus_eexxx52-if00-port0 -&gt; ../../ttyUSB0
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zigbee.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>Zigbee2MQTT</span> <span class=nx>Container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>Requires</span><span class=p>=</span><span class=nx>container-mosquitto</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>container-mosquitto</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=nx>-</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>create</span> <span class=nx>z2m-creds</span> <span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>secret</span><span class=err>/</span><span class=nx>z2m-secrets</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span><span class=p>=</span><span class=nx>zigbee</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--group-add</span> <span class=nx>keep-groups</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--network</span><span class=p>=</span><span class=nx>slirp4netns</span><span class=err>:</span><span class=nx>allow_host_loopback</span><span class=p>=</span><span class=kc>true</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--device</span><span class=p>=</span><span class=err>/</span><span class=nx>dev</span><span class=err>/</span><span class=nx>serial</span><span class=err>/</span><span class=nx>by-id</span><span class=err>/</span><span class=nx>usb-ITead_Sonoff_Zigbee_3</span><span class=p>.</span><span class=mi>0</span><span class=nx>_USB_Dongle_Plus_ee6789cf0260ec11ba5a345f25bfaa52-if00-port0</span><span class=err>:/</span><span class=nx>dev</span><span class=err>/</span><span class=nx>zigbee</span><span class=err>:</span><span class=nx>rw</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>zigbee</span><span class=err>:/</span><span class=nx>app</span><span class=err>/</span><span class=nx>data</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--secret</span><span class=p>=</span><span class=nx>z2m-creds</span><span class=p>,</span><span class=nx>target</span><span class=p>=</span><span class=err>/</span><span class=nx>app</span><span class=err>/</span><span class=nx>data</span><span class=err>/</span><span class=nx>secret</span><span class=p>.</span><span class=nx>yaml</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>8081</span><span class=err>:</span><span class=mi>8081</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>koenkk</span><span class=err>/</span><span class=nx>zigbee2mqtt</span><span class=err>:</span><span class=nx>latest</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=nx>-</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>secret</span> <span class=nx>rm</span> <span class=nx>z2m-creds</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>oneshot</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>We pass our credentials via the <code>--secret</code> and give it a path, and tell the service it needs to wait for the Mosquitto service to have started.</p><p>Then again, start the service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-zigbee.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-zigbee.service → /var/home/hass/.config/systemd/user/container-zigbee.service.
</span></span></code></pre></div><p>Don&rsquo;t forget to check out the <a href=https://sequr.be/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">previous blog post on Zigbee2MQTT</a> for the automations and dashboard config to make the most out of Z2M.</p><h3 id=zwave2mqtt>ZWave2MQTT <a href=#zwave2mqtt>¶</a></h3><p>I&rsquo;m copying this from Matthew&rsquo;s forum post as I don&rsquo;t use Z-Wave myself.</p><p>See also the notes on <em>Container permissions and SELinux</em> in the Zigbee2MQTT section.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /srv/hass/zwave
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zwave.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>ZWave2MQTT</span> <span class=nx>Container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span><span class=p>=</span><span class=nx>zwave</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--group-add</span> <span class=nx>keep-groups</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--device</span><span class=p>=</span><span class=err>/</span><span class=nx>dev</span><span class=err>/</span><span class=nx>serial</span><span class=err>/</span><span class=nx>by-id</span><span class=err>/</span><span class=nx>usb-Silicon_Labs_Zooz_ZST10</span><span class=err>\</span><span class=nx>u00A0700_Z-Wave_Stick_0001-if00-port0</span><span class=err>:/</span><span class=nx>dev</span><span class=err>/</span><span class=nx>zwave</span><span class=err>:</span><span class=nx>rw</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>zwave</span><span class=err>:/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>src</span><span class=err>/</span><span class=nx>app</span><span class=err>/</span><span class=nx>store</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>8091</span><span class=err>:</span><span class=mi>8091</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>3000</span><span class=err>:</span><span class=mi>3000</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>zwavejs</span><span class=err>/</span><span class=nx>zwavejs2mqtt</span><span class=err>:</span><span class=nx>latest</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Start the service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-zigbee.service
</span></span></code></pre></div><h3 id=esphome>ESPHome <a href=#esphome>¶</a></h3><p>Here&rsquo;re we&rsquo;re leaving Matthew&rsquo;s forum post as he didn&rsquo;t discuss setting up ESPHome.
Luckily, we already did the heavy lifting <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-9-esphome/ title="Part 9: ESPHome">before</a>.</p><p><code>~/.config/systemd/user/container-esphome.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>ESPHome</span> <span class=nx>Container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span><span class=p>=</span><span class=nx>esphome</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--group-add</span> <span class=nx>keep-groups</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>esphome</span><span class=err>:/</span><span class=nx>config</span><span class=err>:</span><span class=nx>z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--network</span><span class=p>=</span><span class=nx>host</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>esphome</span><span class=err>/</span><span class=nx>esphome</span><span class=err>:</span><span class=nx>latest</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Create the directory for the esphome config and enable the service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /srv/hass/esphome
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-esphome.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-esphome.service → /var/home/hass/.config/systemd/user/container-esphome.service.
</span></span></code></pre></div><p>Now you can access the ESPHome Dashboard at <code>http://&lt;ip.of.your.system>:6052</code>.</p><p>In my case, it even discovered (and allowed me to adopt) a bluetooth proxy I still had on my network from before my system crash.</p><figure class=center><img src=esphome_dashboard.png alt="ESPHome Dashboard"><figcaption class=center>ESPHome Dashboard</figcaption></figure><h3 id=hass-configurator>HASS Configurator <a href=#hass-configurator>¶</a></h3><p>Editing configuration files from within the browser is a lot more user friendly than having to SSH into our system each time, so lets set up <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-6-editing-configuration.yaml-from-within-home-assistant/ title="Part 6: Editing configuration.yaml from within Home Assistant">HASS Configurator</a> again.</p><p><code>~/.config/systemd/user/container-hassconf.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>HASSConfigurator</span> <span class=nx>Container</span>
</span></span><span class=line><span class=cl><span class=nx>Wants</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network-online</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl><span class=nx>Requires</span><span class=p>=</span><span class=nx>container-homeassistant</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>container-homeassistant</span><span class=p>.</span><span class=nx>service</span>
</span></span><span class=line><span class=cl><span class=nx>RequiresMountsFor</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/</span><span class=nx>containers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Service</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Environment</span><span class=p>=</span><span class=nx>PODMAN_SYSTEMD_UNIT</span><span class=p>=</span><span class=err>%</span><span class=nx>n</span> <span class=nx>TZ</span><span class=p>=</span><span class=nx>Europe</span><span class=err>/</span><span class=nx>Brussels</span>
</span></span><span class=line><span class=cl><span class=nx>Restart</span><span class=p>=</span><span class=nx>on-failure</span>
</span></span><span class=line><span class=cl><span class=nx>RestartSec</span><span class=p>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=nx>TimeoutStopSec</span><span class=p>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStartPre</span><span class=p>=</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>rm</span> <span class=nx>-f</span> <span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStart</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>run</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--cgroups</span><span class=p>=</span><span class=nx>no-conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--rm</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--sdnotify</span><span class=p>=</span><span class=nx>conmon</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--replace</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--detach</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--label</span> <span class=s2>&#34;io.containers.autoupdate=registry&#34;</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--name</span><span class=p>=</span><span class=nx>hassconf</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--group-add</span> <span class=nx>keep-groups</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>hassconf</span><span class=err>:/</span><span class=nx>config</span><span class=err>:</span><span class=nx>Z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>hass</span><span class=err>:/</span><span class=nx>hass-config</span><span class=err>:</span><span class=nx>z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>--volume</span><span class=p>=</span><span class=err>/</span><span class=nx>srv</span><span class=err>/</span><span class=nx>hass</span><span class=err>/</span><span class=nx>esphome</span><span class=err>:/</span><span class=nx>hass-config</span><span class=err>/</span><span class=nx>esphome</span><span class=err>:</span><span class=nx>z</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>-p</span> <span class=mi>3218</span><span class=err>:</span><span class=mi>3218</span> <span class=err>\</span>
</span></span><span class=line><span class=cl>                          <span class=nx>docker</span><span class=p>.</span><span class=nx>io</span><span class=err>/</span><span class=nx>causticlab</span><span class=err>/</span><span class=nx>hass-configurator-docker</span><span class=err>:</span><span class=nx>latest</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStop</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>stop</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>ExecStopPost</span><span class=p>=</span><span class=err>/</span><span class=nx>usr</span><span class=err>/</span><span class=nx>bin</span><span class=err>/</span><span class=nx>podman</span> <span class=nx>rm</span> <span class=nx>-f</span> <span class=nx>--ignore</span> <span class=nx>--cidfile</span><span class=p>=</span><span class=err>%</span><span class=nx>t</span><span class=err>/%</span><span class=nx>n</span><span class=p>.</span><span class=nx>ctr-id</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>notify</span>
</span></span><span class=line><span class=cl><span class=nx>NotifyAccess</span><span class=p>=</span><span class=nx>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>default</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><p>Note that we&rsquo;re mounting the config folders from our Home Assistant and ESPHome containers.
Make sure you marked these volumes as shared (<code>:z</code>) in their respective configurations.</p><p>We also want set our &ldquo;working directory&rdquo; in HASS Configurator to our Home Assistant config folder.</p><p><code>/srv/hass/hassconf/settings.conf</code> (you will need to create the directory first)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;BASEPATH&#34;</span><span class=p>:</span> <span class=s2>&#34;/hass-config&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;ENFORCE_BASEPATH&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;DIRSFIRST&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Enable the service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl --user <span class=nb>enable</span> --now container-hassconf.service
</span></span><span class=line><span class=cl>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-hassconf.service → /var/home/hass/.config/systemd/user/container-hassconf.service.
</span></span></code></pre></div><h2 id=sidebar>Sidebar <a href=#sidebar>¶</a></h2><p>Time to repeat ourselves <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/#manage-portainer-from-within-home-assistant title="Home Assistant sidebar">yet again</a> and setup our sidebar.</p><p>The config below needs to end up in the <code>configuration.yaml</code> inside the Home Assistant config folder (<code>/srv/hass/hass</code>).
You can do this through our freshly launched HASS Configurator or over SSH.</p><p><code>/srv/hass/hass/configuration.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>panel_iframe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configurator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>Configurator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>mdi:wrench</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://&lt;ip.of.your.system&gt;:3218</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>require_admin</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>esphome</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>ESPHome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>mdi:chip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://&lt;ip.of.your.system&gt;:6052</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>require_admin</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zigbee2mqtt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>Zigbee2MQTT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>mdi:zigbee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://&lt;ip.of.your.system&gt;:8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>require_admin</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Note that you need to use the address you would use to visit these containers directly from your desktop/laptop since this uses iframes.
You can&rsquo;t use the podman-internal addresses (like <code>10.0.2.2</code>).
However, you could setup nginx as a reverse proxy for these as well, even give them a(n internal) domain name and a SSL certificate, and then reference that address in this config.</p><p>Confirm using the DevTools that we didn&rsquo;t make a typo and restart Home Assistant to apply the config.</p><figure class=center><img src=devtools_restart.png alt="DevTools check configuration"><figcaption class=center>No errors</figcaption></figure><h2 id=backups>Backups <a href=#backups>¶</a></h2><p>The process for backing your config is fairly easy as everything is located at <code>/srv/hass</code> and <code>~/.config/systemd/user/container-*.service</code>.
You can setup a cronjob doing an <a href=https://linuxconfig.org/how-to-create-incremental-backups-using-rsync-on-linux title="How to create incremental backups using rsync on Linux" target=_blank rel=noopener>rsync backup</a> that archives and copies these files to a NAS, for example.
you&rsquo;ll need to do this as a root user so you don&rsquo;t run into permission issues with the container volumes.</p><blockquote><p>There is however one notable exception: if you want to avoid the possibility of backing up <code>home-assistant_v2.db</code> when it&rsquo;s in a not-settled state (possibly leading to corruption and losing your state history), you should periodically run something like</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;vacuum into &#34;/src/hass/backup/home-assistant_v2-bak.db&#34;&#39;</span> <span class=p>|</span> sqlite3 /srv/hass/hass/home-assistant_v2.db
</span></span></code></pre></div><h3 id=backup-to-nas-over-nfs>Backup to NAS over NFS <a href=#backup-to-nas-over-nfs>¶</a></h3><p>Below are my configurations for backing up my Podman containers to my NAS over NFS.</p><h4 id=mount-backup-folder>Mount backup folder <a href=#mount-backup-folder>¶</a></h4><p>Setup a share on your NAS and grant NFS permissions to the IP of your Podman system.</p><p>Then create the following systemd mount config.
The filename must match your local mount path (<code>Where</code>) using hyphens instead of slashes.</p><p><strong>Note</strong> <code>/mnt</code> is symlinked to <code>/var/mnt</code> on my Fedora CoreOS system and I needed to uses that path.
Otherwise I got symbolic link errors.</p><p><code>/etc/systemd/system/var-mnt-backup.mount</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>Unit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Description</span><span class=p>=</span><span class=nx>HomeAssistant</span> <span class=nx>Backup</span>
</span></span><span class=line><span class=cl><span class=nx>After</span><span class=p>=</span><span class=nx>network</span><span class=p>.</span><span class=nx>target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Mount</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>What</span><span class=p>=</span><span class=err>&lt;</span><span class=nx>ip</span><span class=p>.</span><span class=nx>of</span><span class=p>.</span><span class=nx>my</span><span class=p>.</span><span class=nx>nas</span><span class=err>&gt;:/</span><span class=nx>volume1</span><span class=err>/</span><span class=nx>backup</span>
</span></span><span class=line><span class=cl><span class=nx>Where</span><span class=p>=</span><span class=err>/</span><span class=nx>var</span><span class=err>/</span><span class=nx>mnt</span><span class=err>/</span><span class=nx>backup</span>
</span></span><span class=line><span class=cl><span class=nx>Type</span><span class=p>=</span><span class=nx>nfs</span>
</span></span><span class=line><span class=cl><span class=nx>Options</span><span class=p>=</span><span class=nx>_netdev</span><span class=p>,</span><span class=nx>auto</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Install</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>WantedBy</span><span class=p>=</span><span class=nx>multi-user</span><span class=p>.</span><span class=nx>target</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl start var-mnt-backup.mount
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> var-mnt-backup.mount
</span></span><span class=line><span class=cl>Created symlink /etc/systemd/system/multi-user.target.wants/var-mnt-backup.mount → /etc/systemd/system/var-mnt-backup.mount.
</span></span></code></pre></div><h4 id=backup-script>Backup script <a href=#backup-script>¶</a></h4><p>The following script will use <code>rsync</code> to create an incremental backup.
I also added the <code>vacuum</code> command mentioned above to &ldquo;copy&rdquo; the database. That&rsquo;s why I&rsquo;m ignoring the database in the rsync command.</p><p><code>/var/home/core/backup-podman.sh</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># A script to perform incremental backups using rsync</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -o errexit
</span></span><span class=line><span class=cl><span class=nb>set</span> -o nounset
</span></span><span class=line><span class=cl><span class=nb>set</span> -o pipefail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>SOURCE_DIR</span><span class=o>=</span><span class=s2>&#34;/srv/hass&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>BACKUP_DIR</span><span class=o>=</span><span class=s2>&#34;/var/mnt/backup&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>DATETIME</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>date <span class=s1>&#39;+%Y-%m-%d_%H:%M&#39;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>BACKUP_PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>BACKUP_DIR</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>DATETIME</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>LATEST_LINK</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>BACKUP_DIR</span><span class=si>}</span><span class=s2>/latest&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;----- BACKUP STARTED -----&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BACKUP_DIR</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rsync -av --delete <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SOURCE_DIR</span><span class=si>}</span><span class=s2>/&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --link-dest <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LATEST_LINK</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exclude<span class=o>=</span><span class=s2>&#34;home-assistant_v2.db&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exclude<span class=o>=</span><span class=s2>&#34;.cache&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exclude<span class=o>=</span><span class=s2>&#34;log&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exclude<span class=o>=</span><span class=s2>&#34;*.log&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --exclude<span class=o>=</span><span class=s2>&#34;.esphome&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BACKUP_PATH</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Recreating link&#34;</span>
</span></span><span class=line><span class=cl>rm -rf <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LATEST_LINK</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>ln -rs <span class=s2>&#34;</span><span class=si>${</span><span class=nv>BACKUP_PATH</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LATEST_LINK</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Copy database</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Copying database&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;vacuum into \&#34;</span><span class=si>${</span><span class=nv>BACKUP_PATH</span><span class=si>}</span><span class=s2>/hass/home-assistant_v2.db\&#34;&#34;</span> <span class=p>|</span> sqlite3 <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SOURCE_DIR</span><span class=si>}</span><span class=s2>/hass/home-assistant_v2.db&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;----- BACKUP DONE -----&#34;</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to make this script executable and test it out.
Run as root so you don&rsquo;t get permission errors.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod u+x /var/home/core/backup-podman.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo /var/home/core/backup-podman.sh
</span></span></code></pre></div><h4 id=crontab>Crontab <a href=#crontab>¶</a></h4><p>Now we&rsquo;ll create a cronjob that will automatically call the back-up script on a weekly basis.
This will ensure we have weekly back-ups of our config.</p><p>But first we need to install the <code>cronie</code> package which will provide us with <code>cron</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo rpm-ostree install cronie
</span></span><span class=line><span class=cl>sudo rpm-ostree apply-live
</span></span></code></pre></div><p>Then we can write our cronjob.</p><p><code>/etc/crontab</code></p><pre tabindex=0><code>SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=core

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# | .------------- hour (0 - 23)
# | | .---------- day of month (1 - 31)
# | | | .------- month (1 - 12) OR jan,feb,mar,apr ...
# | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# | | | | |
# * * * * * user-name command to be executed
0 22 * * 6 root /var/home/core/backup-podman.sh &gt; /dev/null
</code></pre><p>This will execute the <code>backup-podman.sh</code> script as root every Saturday at 22:00 (before the auto-update reboot window).
<code>stdout</code> output will be ignored, only error output (<code>stderr</code>) will be mailed to the <code>core</code> user.</p><h2 id=troubleshooting>Troubleshooting <a href=#troubleshooting>¶</a></h2><h3 id=i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service. <a href=#i-made-changes-to-a-service-file-after-starting-a-service>¶</a></h3><p>Run <code>systemctl --user daemon-reload</code> to load your changes.
Then run <code>systemctl --user restart &lt;SERVICE>.service</code> to restart the service using the new config.</p><h3 id=i-cant-modify-container-files>I can&rsquo;t modify container files <a href=#i-cant-modify-container-files>¶</a></h3><p>Containers will be running using their own user inside the container.
The UserID of that user may not match the UserID of your user.
Rootless containers don&rsquo;t map the user account to e.g. root.</p><p>So if you want to change a file in one of the container&rsquo;s volumes and can&rsquo;t or don&rsquo;t want to do it via the terminal/console of the container,
you&rsquo;ll need to SSH into your sudo user (e.g. <code>core</code>) and use root privileges to change the files.
If you&rsquo;re creating new files using the root account (via sudo), their permissions will be mapped to root.
So don&rsquo;t forget to <code>chown</code> these files to the correct userID (check the permissions of the folder or other files within the folder using <code>ls -l</code>).</p><h3 id=error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY <a href=#error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>¶</a></h3><p>Podman doesn&rsquo;t have a default container registry configured.
So if you use the short name of a container, like <code>eclipse/mosquitto</code>, it doesn&rsquo;t know which registry you want to pull it from.</p><p>Either use the full link to the container, such as <code>docker.io/eclipse/mosquitto</code>, or add your preferred registry/registries to your Podman <code>registries.conf</code>.
The user config is located at <code>$HOME/.config/containers/registries.conf</code> and the system config is located at <code>/etc/containers/registries.conf</code>.</p><p>Edit or add the following line to suit your needs:<br><code>unqualified-search-registries = ['docker.io', 'registry.fedoraproject.org', 'registry.access.redhat.com', 'registry.centos.org', 'quay.io', 'ghcr.io']</code></p><h3 id=checkmodule-command-not-found>checkmodule: command not found <a href=#checkmodule-command-not-found>¶</a></h3><p>Your linux installation may not come with this tool installed.
To get the <code>checkmodule</code> tool, install the <code>checkpolicy</code> package using your distro&rsquo;s package manager.</p><p>Fedora CoreOS seems to be built a bit different and doesn&rsquo;t have the <code>yum</code> or <code>dnf</code> package managers installed.
Instead it uses <code>RPM-OStree</code>.
Package installations are more like a pull request in the system config where you need to get the new code and apply it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rpm-ostree install <span class=nv>checkpolicy</span>
</span></span><span class=line><span class=cl><span class=o>====</span> AUTHENTICATING FOR org.projectatomic.rpmostree1.install-uninstall-packages <span class=o>====</span>
</span></span><span class=line><span class=cl>Authentication is required to install and remove software
</span></span><span class=line><span class=cl>Authenticating as: CoreOS Admin <span class=o>(</span>core<span class=o>)</span>
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl><span class=o>====</span> AUTHENTICATION <span class=nv>COMPLETE</span> <span class=o>====</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl>Added:
</span></span><span class=line><span class=cl>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span class=line><span class=cl>Changes queued <span class=k>for</span> next boot. Run <span class=s2>&#34;systemctl reboot&#34;</span> to start a reboot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo rpm-ostree apply-live
</span></span><span class=line><span class=cl>Computing /etc diff to preserve... <span class=k>done</span>
</span></span><span class=line><span class=cl>Updating /usr... <span class=k>done</span>
</span></span><span class=line><span class=cl>Updating /etc... <span class=k>done</span>
</span></span><span class=line><span class=cl>Running systemd-tmpfiles <span class=k>for</span> /run and /var... <span class=k>done</span>
</span></span><span class=line><span class=cl>Added:
</span></span><span class=line><span class=cl>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span class=line><span class=cl>Successfully updated running filesystem tree.
</span></span></code></pre></div><h3 id=selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts <a href=#selinux-permission-issues-with-device-mounts>¶</a></h3><p>If you run into permissions issues when you&rsquo;re trying to mount devices like a Zigbee controller, there are 2 solutions which may fix the issue.
Note that these open up the permissions on your system and thus will reduce the security of your system somewhat.</p><ol><li>Allow all containers to access all devices:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo semanage boolean -m --on container_use_devices
</span></span></code></pre></div><ol start=2><li>The drastic solution of disabling SELinux:</li></ol><p>To disable SELinux intil the next reboot, execute the following command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo setenforce <span class=m>0</span>
</span></span></code></pre></div><p>Permanently disabeling SELinux can be done by modifying <code>/etc/selinux/config</code> and changing <code>SELINUX=enforcing</code> to <code>SELINUX=permissive</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/=enforcing/=permissive/&#39;</span> /etc/selinux/config
</span></span></code></pre></div><h2 id=changelog>Changelog <a href=#changelog>¶</a></h2><p><strong>2022-12-03</strong></p><ul><li>Added explanation on permanently disabeling SELinux</li></ul></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sequr.be/tags/home-automation/>Home Automation</a></span>
<span class=tag><a href=https://sequr.be/tags/home-assistant/>Home Assistant</a></span>
<span class=tag><a href=https://sequr.be/tags/container/>Container</a></span>
<span class=tag><a href=https://sequr.be/tags/docker/>Docker</a></span>
<span class=tag><a href=https://sequr.be/tags/podman/>Podman</a></span>
<span class=tag><a href=https://sequr.be/tags/fedora/>Fedora</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://sequr.be/categories/home-automation/>Home Automation</a></span>
<span class=tag><a href=https://sequr.be/categories/ha-container/>HA Container</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>5309 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-12-02
(Last updated: 2022-12-03)</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f&resubmit=true&title=Home%20Assistant%20Container%20Part%2012%3a%20Migrating%20to%20Podman" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Home%20Assistant%20Container%20Part%2012%3a%20Migrating%20to%20Podman%20https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_blank rel=noopener aria-label title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"/></svg></div></div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/><span class=button__icon>←</span>
<span class=button__text>Flashing NSPanel with Tasmota and NSPanel Lovelace UI</span></a></span>
<span class="button next"><a href=https://sequr.be/blog/2022/11/home-assistant-container-part-11-bluetooth-support/><span class=button__text>Home Assistant Container Part 11: Bluetooth support</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2019-2023</span>
<span><a href=https://sequr.be>DezeStijn</a></span>
<span><a href=https://sequr.be/blog/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><small><span>Powered by <a href='\"http://gohugo.io\"'>Hugo</a>.</span>
<span>Made with &#10084; by <a href='\"https://github.com/rhazdon\"'>Djordje Atlialp</a></span><br><span>Deployed using <a href=https://github.com/TheGroundZero/TheGroundZero.github.io/ title=TheGroundZero/TheGroundZero.github.io>GitHub Pages</a></span></small></div></div></footer></div><script type=text/javascript src=https://sequr.be/bundle.min.bb2c6bc3ed452ca4759660e4020811f248bc2320081559e8a32d8b0092773852941133639d35e8370d03d3ddaa750b1edd6b343c5bd22a55d5bdeae8f648f49b.js integrity="sha512-uyxrw+1FLKR1lmDkAggR8ki8IyAIFVnooy2LAJJ3OFKUETNjnTXoNw0D092qdQse3Ws0PFvSKlXVvero9kj0mw=="></script></body></html>