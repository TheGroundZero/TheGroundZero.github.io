<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="DezeStijn"><meta name=description content="We&rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta name=keywords content="Sequr,blog,writeup,CTF,challenge,machine,infosec,IT security,hacking,pentesting,cybersecurity,Home Automation,Home Assistant,Container,Docker,Podman,Fedora"><meta name=robots content="noodp"><meta name=theme-color content="#252627"><link rel=canonical href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/><title>Home Assistant Container Part 12: Migrating to Podman :: Sequr
</title><link rel=stylesheet href=https://sequr.be/main.min.244183cde1a38e0b08f82c11791181288f9aac1cc9618cd6f4e9e7710c5768ba.css integrity="sha256-JEGDzeGjjgsI+CwReRGBKI+arBzJYYzW9OnncQxXaLo=" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://sequr.be/css/table.css><link rel=stylesheet type=text/css href=https://sequr.be/css/menu.css><link rel=stylesheet type=text/css href=https://sequr.be/css/background.css><link rel=apple-touch-icon sizes=180x180 href=https://sequr.be/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sequr.be/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sequr.be/favicon-16x16.png><link rel=manifest href=https://sequr.be/site.webmanifest><link rel=mask-icon href=https://sequr.be/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://sequr.be/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Home Assistant Container Part 12: Migrating to Podman"><meta itemprop=description content="We’re restarting from the beginning using Podman instead of Docker (Compose)"><meta itemprop=datePublished content="2022-12-02T00:00:00+00:00"><meta itemprop=dateModified content="2024-09-05T00:00:00+00:00"><meta itemprop=wordCount content="5372"><meta itemprop=image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Container,Docker,Podman,Fedora"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta name=twitter:title content="Home Assistant Container Part 12: Migrating to Podman"><meta name=twitter:description content="We’re restarting from the beginning using Podman instead of Docker (Compose)"><meta property="article:section" content="Home Automation"><meta property="article:section" content="HA Container"><meta property="article:published_time" content="2022-12-02 00:00:00 +0000 UTC"><link rel=webmention href=https://webmention.io/sequr.be/webmention></head><body><div class=container><header class=header><span class=header__inner><a href=https://sequr.be/ style=text-decoration:none><div class=logo><span class=logo__mark>$</span>
<span class=logo__text>lynx sequr.be</span>
<span class=logo__cursor style=background-color:#e68101></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sequr.be/about/>About</a></li><li><a href=https://sequr.be/blog/>Blog</a></li><li><a href=https://sequr.be/privacy/>Privacy</a></li><li><a href=https://sequr.be/shoppinglist/>Shopping</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class="post h-entry"><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
26 minutes</p></div><article><h1 class="post-title p-name"><a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ class=u-url>Home Assistant Container Part 12: Migrating to Podman</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#fedora-core-os>Fedora Core OS</a><ul><li><a href=#preparing-live-usb>Preparing Live USB</a></li><li><a href=#preparing-ignition-configuration>Preparing Ignition configuration</a></li><li><a href=#installing-fedora-coreos>Installing Fedora CoreOS</a></li><li><a href=#finishing-touches>Finishing touches</a><ul><li><a href=#linger>Linger</a></li><li><a href=#directory-structure>Directory structure</a></li></ul></li></ul></li><li><a href=#podman-setup>Podman setup</a><ul><li><a href=#podman-autoupdate>Podman Autoupdate</a></li></ul></li><li><a href=#podman-containers>Podman containers</a><ul><li><a href=#certbot-and-letsencrypt>Certbot and LetsEncrypt</a></li><li><a href=#nginx-reverse-proxy>Nginx reverse proxy</a><ul><li><a href=#firewall-config>Firewall config</a></li></ul></li><li><a href=#home-assistant>Home Assistant</a></li><li><a href=#mosquitto-mqtt-broker>Mosquitto MQTT Broker</a></li><li><a href=#zigbee2mqtt>Zigbee2MQTT</a><ul><li><a href=#container-permissions-and-selinux>Container permissions and SELinux</a></li><li><a href=#config>Config</a></li></ul></li><li><a href=#zwave2mqtt>ZWave2MQTT</a></li><li><a href=#esphome>ESPHome</a></li><li><a href=#hass-configurator>HASS Configurator</a></li></ul></li><li><a href=#sidebar>Sidebar</a></li><li><a href=#backups>Backups</a><ul><li><a href=#backup-to-nas-over-nfs>Backup to NAS over NFS</a><ul><li><a href=#mount-backup-folder>Mount backup folder</a></li><li><a href=#backup-script>Backup script</a></li><li><a href=#crontab>Crontab</a></li></ul></li></ul></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service</a></li><li><a href=#i-cant-modify-container-files>I can&rsquo;t modify container files</a></li><li><a href=#error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY</a></li><li><a href=#checkmodule-command-not-found>checkmodule: command not found</a></li><li><a href=#selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts</a></li></ul></li><li><a href=#changelog>Changelog</a></li></ul></nav></aside><hr><div class="post-content e-content"><h2 id=intro>Intro <a href=#intro>¶</a></h2><p>From the <a href=https://docs.podman.io/en/latest/ title="Podman documentation" target=_blank rel=noopener>Podman documentation</a>:</p><blockquote><p>Podman is a daemonless, open source, Linux native tool designed to make it easy to find, run, build, share and deploy applications using Open Containers Initiative (OCI) Containers and Container Images.
Podman provides a command line interface (CLI) familiar to anyone who has used the Docker Container Engine. Most users can simply alias Docker to Podman <em>(alias docker=podman)</em> without any problems.
Similar to other common Container Engines (Docker, CRI-O, containerd), Podman relies on an OCI compliant Container Runtime (runc, crun, runv, etc) to interface with the operating system and create the running containers.
This makes the running containers created by Podman nearly indistinguishable from those created by any other common container engine.</p></blockquote><p>In a timespan of 2 or 3 days my no-brand M.2 SSD crapped itself, destroying my HA Container setup with it, and we had a discussion at work re. Docker licenses and open-source alternatives, Podman being one of them.
These events made me decide to start over with a new Podman-based setup of Home Assistant Container as soon as my newly ordered Crucial SATA SSD had arrived.
Sadly I didn&rsquo;t have the chance to document my the changes I did to my Docker setup using macvlan&rsquo;s. I would have loved to share that as well.</p><p>This blog post will be kind of a logbook of the steps I&rsquo;ve taken to set everything up.
Most &ndash; if not all &ndash; will be based on a topic in the HA forums: <a href=https://community.home-assistant.io/t/work-in-progress-configuration-for-running-a-home-assistant-in-containers-with-systemd-and-podman-on-fedora-iot title="Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT" target=_blank rel=noopener>Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT</a>.</p><p>Note that this does not negate anything we did so far in the <a href=https://sequr.be/categories/ha-container/ title="HA Container series">Home Assistant Container series</a> so far and you&rsquo;re still free to use Docker Compose to do your setup.</p><h2 id=fedora-core-os>Fedora Core OS <a href=#fedora-core-os>¶</a></h2><figure class=center><img src=fedora-coreos-logo.png alt="Fedora CoreOS logo"><figcaption class=center>Fedora CoreOS</figcaption></figure><p>I&rsquo;m no linux/unix expert and so far I&rsquo;ve been running mainly Debian and Ubuntu VMs.
But as I&rsquo;m already making things complicated for myself by starting from scratch and learning to work with a new container manager as I go, I decided to make it extra hard on myself and learn how to work with <a href=https://getfedora.org/en/coreos title="Fedora CoreOS" target=_blank rel=noopener>Fedora CoreOS</a> as well.</p><blockquote><p>Fedora CoreOS is an automatically-updating, minimal operating system for running containerized workloads securely and at scale.
It is currently available on multiple platforms, with more coming soon.</p></blockquote><p>Fedora CoreOS also comes with Docker and Podman installed by default.</p><p>I installed Fedora CoreOS bare-metal on my <a href=https://s.click.aliexpress.com/e/_DkZ6gPh title="Beelink Mini S with Intel 11th Gen N5095 CPU" target=_blank rel=noopener>Beelink</a> (after installing a new SSD) using the Live USB image.</p><h3 id=preparing-live-usb>Preparing Live USB <a href=#preparing-live-usb>¶</a></h3><ol><li><a href="https://getfedora.org/en/coreos/download?tab=metal_virtualized&amp;stream=stable&amp;arch=x86_64" title="Download Fedora CoreOS" target=_blank rel=noopener>Download</a> the Fedora Core OS Bare Metal ISO.<br>I recommend getting it from the Stable stream.</li><li>Follow the steps to verify your download.<br>Download the checksum file and signature, import Fedora&rsquo;s GPG key, verify the validity of the signature, and verify the checksum matches.<br>This way, you&rsquo;re certain your downloaded ISO isn&rsquo;t corrupted or altered along the way.</li><li>If you&rsquo;re on Linux or Mac, write the ISO image to your USB drive using <code>dd</code>.<br>Make sure you fully understand what you&rsquo;re doing here!<br><code>sudo dd bs=4M if=fedora-coreos-36.20221030.3.0-live.x86_64.iso of=/dev/sdb conv=fdatasync status=progress</code>
If you&rsquo;re on Windows, use a tool like balenaEtcher.</li></ol><p>Once the writing process is done, you can (safely) eject your USB drive from your computer and plug it in your target system.</p><h3 id=preparing-ignition-configuration>Preparing Ignition configuration <a href=#preparing-ignition-configuration>¶</a></h3><p>Fedora doesn&rsquo;t come with default credentials.
So later, when we install Fedora CoreOS on our system, we won&rsquo;t be able to login on the console or over SSH.</p><p>To solve this, we&rsquo;ll create an Ignition configuration which will be read by the setup process and which we&rsquo;ll use to setup our account.</p><blockquote><p>Ignition is a provisioning utility that reads a configuration file (in JSON format) and provisions a Fedora CoreOS system based on that configuration.</p></blockquote><p>We start of by creating a Butane configuration file.
In this configuration file, we create 2 accounts <code>core</code> and <code>hass</code> with <a href=https://sequr.be/blog/2020/09/upgrade-your-ssh-keys-to-ed25519/#upgrade-to-ed25519-keys title="Generate ED25 SSH keys">SSH keys</a>.
The <code>core</code> user is added to the <code>wheel</code> group so it gets sudo rights and the <code>hass</code> user is added to the <code>dialout</code> group.</p><p>We also add a systemd config that will download and launch <code>etcd</code> at boot.</p><blockquote><p><a href=https://etcd.io/ title="A distributed, reliable key-value store for the most critical data of a distributed system" target=_blank rel=noopener>etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.
It gracefully handles leader elections during network partitions and can tolerate machine failure, even in the leader node.</p></blockquote><p>And we also setup auto-updates to not be too eager on updating and to only allow reboots in a specific timeslot.</p><p><code>fedoracore.be</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>variant</span>: <span style=color:#ae81ff>fcos</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.4.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>passwd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>users</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>core</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ssh_authorized_keys</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>ssh-ed25519 AA...</span> <span style=color:#75715e># UPDATE THIS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>wheel</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ssh_authorized_keys</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>ssh-ed25519 AA...</span> <span style=color:#75715e># UPDATE THIS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>dialout</span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/hostname</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0644</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline: fedoracore  # Optional</span>: <span style=color:#ae81ff>change this</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># OPTIONAL - Wariness to updates</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://docs.fedoraproject.org/en-US/fedora-coreos/auto-updates/#_wariness_to_updates</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/zincati/config.d/51-rollout-wariness.toml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [identity]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          rollout_wariness = 0.75</span>          
</span></span><span style=display:flex><span>      <span style=color:#75715e># OPTIONAL - Update Strategy</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://coreos.github.io/zincati/usage/updates-strategy/</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/zincati/config.d/55-updates-strategy.toml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [updates]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          strategy = &#34;periodic&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [[updates.periodic.window]]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          days = [ &#34;Sat&#34;, &#34;Sun&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          start_time = &#34;22:45&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          length_minutes = 60</span>          
</span></span><span style=display:flex><span><span style=color:#f92672>systemd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>units</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>etcd-member.service</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Description=Run a single node etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        After=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Wants=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=mkdir -p /var/lib/etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman kill etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman rm etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman pull quay.io/coreos/etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStart=/bin/podman run --name etcd --net=host \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    --volume /var/lib/etcd:/etcd-data:z  \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    quay.io/coreos/etcd:latest /usr/local/bin/etcd              \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --data-dir /etcd-data --name node1                  \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --initial-advertise-peer-urls http://127.0.0.1:2380 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --listen-peer-urls http://127.0.0.1:2380            \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --advertise-client-urls http://127.0.0.1:2379       \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --listen-client-urls http://127.0.0.1:2379          \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --initial-cluster node1=http://127.0.0.1:2380
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStop=/bin/podman stop etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WantedBy=multi-user.target</span>        
</span></span></code></pre></div><p>To convert this Butane configuration file into an Ignition config, we need the Butane tool.
There are multiple methods to get Butane, like using a Podman <a href=https://quay.io/repository/coreos/butane title=coreos/butane target=_blank rel=noopener>container</a> or by using a distribution-provided package, but I opted for the <a href=https://github.com/coreos/butane/releases title="Butane releases" target=_blank rel=noopener>standalone</a> executable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://getfedora.org/static/fedora.gpg | gpg --import
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check latest version at https://github.com/coreos/butane/releases</span>
</span></span><span style=display:flex><span>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu
</span></span><span style=display:flex><span>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu.asc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gpg --verify butane-x86_64-unknown-linux-gnu.asc
</span></span></code></pre></div><p>Finally to convert the configuration file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>chmod u+x butane-x86_64-unknown-linux-gnu
</span></span><span style=display:flex><span>./butane-x86_64-unknown-linux-gnu --pretty --strict fedoracore.be | tee fedoracore.ign
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;ignition&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;3.3.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;passwd&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;users&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;groups&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;wheel&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sshAuthorizedKeys&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;groups&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;dialout&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;hass&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sshAuthorizedKeys&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;storage&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;files&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/etc/hostname&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;contents&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;compression&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;data:,fedoracore&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#ae81ff>420</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;systemd&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;units&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;contents&#34;</span>: <span style=color:#e6db74>&#34;[Unit]\nDescription=Run a single node etcd\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStartPre=mkdir -p /var/lib/etcd\nExecStartPre=-/bin/podman kill etcd\nExecStartPre=-/bin/podman rm etcd\nExecStartPre=-/bin/podman pull quay.io/coreos/etcd\nExecStart=/bin/podman run --name etcd --net=host \\\n            --volume /var/lib/etcd:/etcd-data:z  \\\n            quay.io/coreos/etcd:latest /usr/local/bin/etcd              \\\n                    --data-dir /etcd-data --name node1                  \\\n                    --initial-advertise-peer-urls http://127.0.0.1:2380 \\\n                    --listen-peer-urls http://127.0.0.1:2380            \\\n                    --advertise-client-urls http://127.0.0.1:2379       \\\n                    --listen-client-urls http://127.0.0.1:2379          \\\n                    --initial-cluster node1=http://127.0.0.1:2380\nExecStop=/bin/podman stop etcd\n\n[Install]\nWantedBy=multi-user.target\n&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;enabled&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;etcd-member.service&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We will need to make this configuration file available to our system over the network.
Either by hosting it locally on a (temporary) webserver or by hosting it online.</p><p>I opted to use a temporary file host service named tmpfiles.org.
This is not an endorsement of this service.
Always be cautious when sharing/uploading configurations with potentially sensitive information (like SSH pubkeys) with an unknown 3rd party!</p><h3 id=installing-fedora-coreos>Installing Fedora CoreOS <a href=#installing-fedora-coreos>¶</a></h3><p>Now we&rsquo;re ready to install Fedora on our system via the Live USB.</p><ol><li>Plug the USB in the target system.</li><li>Power up the system and spam the <code>ESC</code> button on your keyboard.</li><li>Make sure you boot from USB.</li><li>Confirm the path of the system&rsquo;s hard drive (probably <code>/dev/sda</code>).<br><code>sudo fdisk -l</code></li><li>Run the following command in the terminal to launch the installer.<br>Don&rsquo;t forget to modify the url to your Ignition config.<br><code>sudo coreos-installer install /dev/sda --ignition-url https://example.com/example.ign</code></li><li>Once the installer has finished, reboot the system and unplug the USB.<br><code>sudo reboot</code></li></ol><h3 id=finishing-touches>Finishing touches <a href=#finishing-touches>¶</a></h3><p>Now you can SSH into Fedora system from your own computer.</p><p><code>ssh -i ~/.ssh/id_fc_core core@IP.OF.YOUR.BOX</code></p><h4 id=linger>Linger <a href=#linger>¶</a></h4><p>We&rsquo;ll be setting up our containers using systemd.
To keep systemd from stopping all of your containers when you log out, we enable <em>linger</em> on the <code>hass</code> account.</p><p><code>sudo loginctl enable-linger hass</code></p><h4 id=directory-structure>Directory structure <a href=#directory-structure>¶</a></h4><p>Local config will be stored in <code>/srv/hass/</code>.
Grouping everything in one folder makes backing up also a lot easier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir /srv/hass
</span></span><span style=display:flex><span>sudo chown -R hass:hass /srv/hass
</span></span></code></pre></div><h2 id=podman-setup>Podman setup <a href=#podman-setup>¶</a></h2><figure class=center><img src=podman-logo.svg alt="Podman logo"><figcaption class=center>Podman</figcaption></figure><p>All Podman config will be done as the <code>hass</code> user.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -i ~/.ssh/id_ed25519_fc_hass hass@&lt;ip.of.your.systen&gt;
</span></span></code></pre></div><p>Still following the guide from the HA Forum, we&rsquo;ll be setting up multiple containers.</p><p>This includes a Certbot and Nginx reverse proxy container to provide external access to your Home Assistance instance.
If you prefer to setup remote access via the Nabu Casa cloud, you won&rsquo;t need these.</p><h3 id=podman-autoupdate>Podman Autoupdate <a href=#podman-autoupdate>¶</a></h3><p>Podman has an auto-update feature which is triggered via a timer.
We&rsquo;ll enable this in our user session as that&rsquo;s where we&rsquo;ll be running our rootless containers in.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now podman-auto-update.timer
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/podman-auto-update.timer → /usr/lib/systemd/user/podman-auto-update.timer.
</span></span></code></pre></div><h2 id=podman-containers>Podman containers <a href=#podman-containers>¶</a></h2><h3 id=certbot-and-letsencrypt>Certbot and LetsEncrypt <a href=#certbot-and-letsencrypt>¶</a></h3><p>If you want valid SSL certificates (also required for the Companion app), you&rsquo;ll need your own domain name.
I advise using a registrar that supports the DNS challenge type for the certbot.
That way you don&rsquo;t need to expose any systems to request certificates.
You can even get a wildcard <code>*.yourdomain.tld</code> certificate so you don&rsquo;t even need to setup public domain names for your systems.
Another advantage is that you don&rsquo;t run into issues with a changing public IP for doing the web challenge, which requires setting up Dynamic DNS as a fix.</p><p>We&rsquo;ll create a file to store our secrets (keys for the challenge) and a directory for the certbot container to store its files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /srv/hass/certbot
</span></span><span style=display:flex><span>mkdir -p /srv/hass/secret
</span></span></code></pre></div><p><code>/srv/hass/secret/certbot-creds</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>dns_ovh_endpoint = ovh-eu
</span></span><span style=display:flex><span>dns_ovh_application_key = MDAwMDAwMDAwMDAw
</span></span><span style=display:flex><span>dns_ovh_application_secret = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
</span></span><span style=display:flex><span>dns_ovh_consumer_key = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
</span></span></code></pre></div><p>The exact config for Certbot will depend on your registrar and your own domain name.<br>In my case, I&rsquo;m using OVH.
I might add a blog post on how to get the necessary keys and tokens for the OVH DNS challenge.</p><p><code>~/.config/systemd/user/container-certbot.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>CertBot</span> <span style=color:#a6e22e>container</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>renew</span> <span style=color:#a6e22e>Let</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>Encrypt</span> <span style=color:#a6e22e>certificates</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-abnormal</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStartSec</span>=<span style=color:#ae81ff>10800</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>certbot-creds</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-a</span> <span style=color:#a6e22e>stdout</span> <span style=color:#a6e22e>-a</span> <span style=color:#a6e22e>stderr</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>certbot</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>letsencrypt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>certbot-creds</span>,<span style=color:#a6e22e>mode</span>=<span style=color:#ae81ff>0400</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dns-ovh</span> <span style=color:#a6e22e>-n</span> <span style=color:#a6e22e>renew</span> <span style=color:#a6e22e>--dns-ovh</span> <span style=color:#a6e22e>--dns-ovh-credentials</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>run</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secrets</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>live</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>fullchain</span>.<span style=color:#a6e22e>pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>live</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>privkey</span>.<span style=color:#a6e22e>pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Notice how this service config uses <code>podman secret create</code> to pass our certbot credentials to the container.
It also removes this secret when the service is stopped.</p><p>Because the order of actions, specifically the pre and post, matters <code>Type=oneshot</code> is used here.</p><p><code>~/.config/systemd/user/container-certbot.timer</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Renews</span> <span style=color:#a6e22e>any</span> <span style=color:#a6e22e>certificates</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>need</span> <span style=color:#a6e22e>them</span> <span style=color:#a6e22e>renewed</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Timer</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Unit</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>OnCalendar</span>=<span style=color:#a6e22e>weekly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>timers</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Then enable the timer service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-certbot.timer
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/container-certbot.timer → /var/home/hass/.config/systemd/user/container-certbot.timer.
</span></span></code></pre></div><p>We do need to manually run the certbot tool once to get our certificates, which the renew service will keep up-to-date.
We&rsquo;ll also accept the Terms of Service of LetsEncrypt and we give them an email address to remind us of expiring certs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/bin/podman secret create certbot-creds /srv/hass/secret/certbot-creds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/bin/podman run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--cgroups<span style=color:#f92672>=</span>no-conmon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--sdnotify<span style=color:#f92672>=</span>conmon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-a stdout -a stderr <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--name certbot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--volume<span style=color:#f92672>=</span>/srv/hass/certbot:/etc/letsencrypt:z <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--secret<span style=color:#f92672>=</span>certbot-creds,mode<span style=color:#f92672>=</span><span style=color:#ae81ff>0400</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	docker.io/certbot/dns-ovh certonly <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-n --agree-tos --email certbot@example.org <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--dns-ovh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--dns-ovh-credentials /run/secrets/certbot-creds <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-d *.example.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Saving debug log to /var/log/letsencrypt/letsencrypt.log
</span></span><span style=display:flex><span>Account registered.
</span></span><span style=display:flex><span>Requesting a certificate <span style=color:#66d9ef>for</span> *.example.org
</span></span><span style=display:flex><span>Waiting <span style=color:#ae81ff>120</span> seconds <span style=color:#66d9ef>for</span> DNS changes to propagate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Successfully received certificate.
</span></span><span style=display:flex><span>Certificate is saved at: /etc/letsencrypt/live/example.org/fullchain.pem
</span></span><span style=display:flex><span>Key is saved at:         /etc/letsencrypt/live/example.org/privkey.pem
</span></span><span style=display:flex><span>This certificate expires on 2023-02-23.
</span></span><span style=display:flex><span>These files will be updated when the certificate renews.
</span></span><span style=display:flex><span>NEXT STEPS:
</span></span><span style=display:flex><span>- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to enable that functionality. See https://certbot.org/renewal-setup <span style=color:#66d9ef>for</span> instructions.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span style=display:flex><span>If you like Certbot, please consider supporting our work by:
</span></span><span style=display:flex><span> * Donating to ISRG / Let<span style=color:#960050;background-color:#1e0010>&#39;</span>s Encrypt:   https://letsencrypt.org/donate
</span></span><span style=display:flex><span> * Donating to EFF:                    https://eff.org/donate-le
</span></span><span style=display:flex><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span></code></pre></div><p>Running the renew service once after this, will also ensure our certs are stored as Podman secrets.
These secrets will hold the SSL cert and private key and will be shared with the Nginx reverse proxy container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user start container-certbot.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>podman secret ls
</span></span><span style=display:flex><span>ID                         NAME              DRIVER      CREATED         UPDATED
</span></span><span style=display:flex><span>219a7a4790c900f313e0fd44f  example.org.key   file        <span style=color:#ae81ff>15</span> minutes ago  <span style=color:#ae81ff>15</span> minutes ago
</span></span><span style=display:flex><span>62ff3f2b637f31917f4fc0234  certbot-creds     file        <span style=color:#ae81ff>45</span> minutes ago  <span style=color:#ae81ff>45</span> minutes ago
</span></span><span style=display:flex><span>f8a3cafb519fc30df6e24b8b9  example.org.cert  file        <span style=color:#ae81ff>15</span> minutes ago  <span style=color:#ae81ff>15</span> minutes ago
</span></span></code></pre></div><h3 id=nginx-reverse-proxy>Nginx reverse proxy <a href=#nginx-reverse-proxy>¶</a></h3><p>The Nginx reverse proxy will be the bridge between the internet and Home Assistant.</p><p>The <em>exposed</em> port of the Nginx container is deliberately set to a so-called non-privileged port (>1024) so we can keep our container rootless.
Using port forwarding on our router, we can open ports 80/tcp (HTTP) and 443/tcp (HTTPS) on the router while referring to ports 9080/tcp and 9443/tcp respectively on the container.
The proxy will then, based on the hostname, forward the connection to our Home Assistant instance using the IP of our podman&rsquo;s virtual network gateway <code>10.0.2.2</code> (see <code>proxy_pass</code>).</p><p>Let&rsquo;s start of with the config for the proxy.
Don&rsquo;t forget to update the following:</p><ul><li>Name of the SSL certificate and private key.</li><li><code>server_name</code> to match your Home Assistant hostname.<br>A <code>server_name</code> of <code>_</code> will match any domain name. We use this to forward HTTP to HTTPS but I&rsquo;d advise NOT to redirect any random hostname to your Home Assistant instance.</li></ul><p><code>/srv/hass/nginx/nginx.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>worker_processes</span> <span style=color:#960050;background-color:#1e0010>auto;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>error_log</span> <span style=color:#960050;background-color:#1e0010>/dev/stdout</span> <span style=color:#960050;background-color:#1e0010>info;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>pid</span> <span style=color:#960050;background-color:#1e0010>/run/nginx.pid;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>include</span> <span style=color:#960050;background-color:#1e0010>/usr/share/nginx/modules/mod-stream.conf;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>worker_connections</span> <span style=color:#960050;background-color:#1e0010>1024;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>map</span> <span style=color:#960050;background-color:#1e0010>$http_upgrade</span> <span style=color:#960050;background-color:#1e0010>$connection_upgrade</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>default</span> <span style=color:#960050;background-color:#1e0010>upgrade;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>&#39;&#39;</span> <span style=color:#960050;background-color:#1e0010>close;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate</span> <span style=color:#e6db74>&#34;/run/secrets/example.org.cert&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate_key</span> <span style=color:#e6db74>&#34;/run/secrets/example.org.key&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>9080;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>[::]:9080;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>server_name</span>  <span style=color:#960050;background-color:#1e0010>_;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>301</span> <span style=color:#960050;background-color:#1e0010>https:</span><span style=color:#75715e>//$host$request_uri;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>9443</span> <span style=color:#960050;background-color:#1e0010>ssl</span> <span style=color:#960050;background-color:#1e0010>http2;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>[::]:9443</span> <span style=color:#960050;background-color:#1e0010>ssl</span> <span style=color:#960050;background-color:#1e0010>http2;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>server_name</span>  <span style=color:#960050;background-color:#1e0010>homeassistant.example.org;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_session_cache</span> <span style=color:#960050;background-color:#1e0010>shared:SSL:1m;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_session_timeout</span>  <span style=color:#960050;background-color:#1e0010>10m;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_ciphers</span> <span style=color:#960050;background-color:#1e0010>PROFILE=SYSTEM;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_prefer_server_ciphers</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_buffering</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>location</span> <span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_pass</span> <span style=color:#960050;background-color:#1e0010>http:</span><span style=color:#75715e>//10.0.2.2:8123;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Host</span> <span style=color:#960050;background-color:#1e0010>$host;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_http_version</span> <span style=color:#960050;background-color:#1e0010>1.1;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>X-Forwarded-For</span> <span style=color:#960050;background-color:#1e0010>$proxy_add_x_forwarded_for;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Upgrade</span> <span style=color:#960050;background-color:#1e0010>$http_upgrade;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Connection</span> <span style=color:#960050;background-color:#1e0010>$connection_upgrade;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p>Next is the config for the Nginx container.</p><p>Don&rsquo;t forget to modify the name of the secrets to match your config.</p><p><code>~/.config/systemd/user/container-nginx.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Nginx</span> <span style=color:#a6e22e>Reverse</span> <span style=color:#a6e22e>Proxy</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Documentation</span>=<span style=color:#a6e22e>man</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>podman-generate-systemd</span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>nginx</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--net</span> <span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>9080</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>9080</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>9443</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>9443</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>access</span>.<span style=color:#a6e22e>redhat</span>.<span style=color:#a6e22e>com</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>ubi8</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx-120</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span> <span style=color:#a6e22e>nginx</span> <span style=color:#a6e22e>-g</span> <span style=color:#e6db74>&#34;daemon off;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>We can now launch the container, even though the redirect won&rsquo;t function yet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-nginx.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-nginx.service → /var/home/hass/.config/systemd/user/container-nginx.service.
</span></span></code></pre></div><h4 id=firewall-config>Firewall config <a href=#firewall-config>¶</a></h4><p>Now set up your firewall/router to port forward ports 80/tcp and 443/tcp on your WAN (internet) side to ports 9080/tcp and 9443/tcp on your Fedora system respectively.</p><h3 id=home-assistant>Home Assistant <a href=#home-assistant>¶</a></h3><p>This Home Assistant container has got a few <em>features</em>.</p><p>First of all, it <em>wants</em> (but doesn&rsquo;t <em>require</em>) the Z-Wave and Zigbee containers to be alive but won&rsquo;t shutdown if they&rsquo;re not.
You can comment these lines out if you won&rsquo;t have these running anyway.
I&rsquo;ll comment out the Z-Wave lines as I don&rsquo;t use it in my Home Assistant setup.</p><p>Secondly, there&rsquo;s a custom <a href=https://github.com/brianegge/home-assistant-sdnotify title=brianegge/home-assistant-sdnotify target=_blank rel=noopener>watchdog</a> service that will ensure the container restarts if Home Assistant ends up in a error state without exiting.
Since we first need to setup HA before we can install the watchdog, we&rsquo;ll comment out the its config for now.
I&rsquo;m keeping it in the config below for future reference.</p><p>Also, like with the Certbot container setup, we need to make sure the folder for the HA config exists.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/hass
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-homeassistant.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Home</span> <span style=color:#a6e22e>Assistant</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wants=container-zwave.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>container-zigbee</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#75715e># After=container-zwave.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-zigbee</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span> <span style=color:#a6e22e>WATCHDOG_USEC</span>=<span style=color:#ae81ff>5000000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note: this is using https://github.com/brianegge/home-assistant-sdnotify.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Once installed, uncomment the `WatchdogSec` line below</span>
</span></span><span style=display:flex><span><span style=color:#75715e># and change `--sdnotify=conmon` to `--sdnotify=container`.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># WatchdogSec=60</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>homeassistant</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>host</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>ghcr</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>home-assistant</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>home-assistant</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>stable</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Now, again, we start the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-homeassistant.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-homeassistant.service → /var/home/hass/.config/systemd/user/container-homeassistant.service.
</span></span></code></pre></div><p>Give it some time and you should finally be able to see a glimpse of Home Assistant appearing at <code>http://ip.of.your.system:8123</code>.</p><figure class=center><img src=home_assistant-welcome.png alt="Home Assistant first setup screen"><figcaption class=center>It&rsquo;s alive!</figcaption></figure><h3 id=mosquitto-mqtt-broker>Mosquitto MQTT Broker <a href=#mosquitto-mqtt-broker>¶</a></h3><p>We will need the Mosquitto MQTT broker when we&rsquo;re setting up the Zigbee2MQTT container.
But a lot of devices and applications can make use of MQTT as message protocol, so I always recomment installing Mosquitto.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /srv/hass/mosquitto/config
</span></span><span style=display:flex><span>mkdir /srv/hass/mosquitto/data
</span></span><span style=display:flex><span>mkdir /srv/hass/mosquitto/log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch /srv/hass/mosquitto/config/mqttuser
</span></span></code></pre></div><p>The Mosquitto config needs to be present before we start the container.
We can copy our config for Mosquitto from <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/ title="Part 4: Mosquitto Docker Container">our Docker setup</a>.</p><p><code>/srv/hass/mosquitto/config/mosquitto.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span># Listen on port 1883
</span></span><span style=display:flex><span>listener 1883
</span></span><span style=display:flex><span>socket_domain ipv4
</span></span><span style=display:flex><span># save the in-memory database to disk
</span></span><span style=display:flex><span>persistence true
</span></span><span style=display:flex><span>persistence_location /mosquitto/data/
</span></span><span style=display:flex><span># Log to stderr and logfile
</span></span><span style=display:flex><span>log_dest stderr
</span></span><span style=display:flex><span>log_dest file /mosquitto/log/mosquitto.log
</span></span><span style=display:flex><span># Require authentication
</span></span><span style=display:flex><span>allow_anonymous false
</span></span><span style=display:flex><span>password_file /mosquitto/config/mqttuser
</span></span></code></pre></div><p>And yet another service file to autostart out container.</p><p><code>~/.config/systemd/user/container-mosquitto.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Mosquitto</span> <span style=color:#a6e22e>MQTT</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>mosquitto</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>1883</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>1883</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>eclipse-mosquitto</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>And start the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-mosquitto.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-mosquitto.service → /var/home/hass/.config/systemd/user/container-mosquitto.service.
</span></span></code></pre></div><p>We can now create accounts for the services we&rsquo;ll be using later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd -c /mosquitto/config/mqttuser mqtt_ha
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>Reenter password:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Drop the -c this time or it will wipe out the previous account!</span>
</span></span><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser mqtt_z2m
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>Reenter password:
</span></span></code></pre></div><p>You can see these being added:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat /srv/hass/mosquitto/config/mqttuser
</span></span><span style=display:flex><span>mqtt_ha:$7$101$Dh*****rM$3Y********************<span style=color:#f92672>==</span>
</span></span><span style=display:flex><span>mqtt_z2m:$7$101$3t*****L7$Ir********************<span style=color:#f92672>==</span>
</span></span></code></pre></div><h3 id=zigbee2mqtt>Zigbee2MQTT <a href=#zigbee2mqtt>¶</a></h3><p>You only need this container if you&rsquo;re using Z2M as Zigbee coordinator.
There&rsquo;s also Zigbee Home Automation (ZHA) that&rsquo;s built-in in Home Assistant and deCONZ by dresden elektronik.</p><h4 id=container-permissions-and-selinux>Container permissions and SELinux <a href=#container-permissions-and-selinux>¶</a></h4><p>Since we&rsquo;re using a Zigbee controller connected over USB, we need to provide permissions to the container to do so,
otherwise SELinux will block the container from doing so.</p><p>Here&rsquo;re I&rsquo;ll also follow the setup by Matthew as I don&rsquo;t have experience with SELinux.
Their setup involves using a custom SELinux module that allows containers to access USB serial devices.</p><p>We&rsquo;ll need sudo rights, so you may need to switch back to our sudo user <code>core</code> for these next steps.</p><p><code>~/container-usbtty.te</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>module</span> <span style=color:#960050;background-color:#1e0010>container-usbtty</span> <span style=color:#ae81ff>1.0</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>require</span> {
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>container_t;</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>usbtty_device_t;</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>class</span> <span style=color:#960050;background-color:#1e0010>chr_file</span> <span style=color:#960050;background-color:#1e0010>{</span> <span style=color:#960050;background-color:#1e0010>getattr</span> <span style=color:#960050;background-color:#1e0010>ioctl</span> <span style=color:#960050;background-color:#1e0010>lock</span> <span style=color:#960050;background-color:#1e0010>open</span> <span style=color:#960050;background-color:#1e0010>read</span> <span style=color:#960050;background-color:#1e0010>write</span> }<span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#=============</span> <span style=color:#960050;background-color:#1e0010>container_t</span> <span style=color:#960050;background-color:#1e0010>==============</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>allow</span> <span style=color:#960050;background-color:#1e0010>container_t</span> <span style=color:#960050;background-color:#1e0010>usbtty_device_t:chr_file</span> { <span style=color:#960050;background-color:#1e0010>getattr</span> <span style=color:#960050;background-color:#1e0010>ioctl</span> <span style=color:#960050;background-color:#1e0010>lock</span> <span style=color:#960050;background-color:#1e0010>open</span> <span style=color:#960050;background-color:#1e0010>read</span> <span style=color:#960050;background-color:#1e0010>write</span> }<span style=color:#960050;background-color:#1e0010>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>checkmodule -M -m -o container-usbtty.mod container-usbtty.te
</span></span><span style=display:flex><span>semodule_package -o container-usbtty.pp -m container-usbtty.mod
</span></span><span style=display:flex><span>sudo semodule -i container-usbtty.pp
</span></span></code></pre></div><p>Running into issues with permissions? Check the <a href=#troubleshooting title=Troubleshooting>Troubleshooting</a> section.</p><h4 id=config>Config <a href=#config>¶</a></h4><p>As with the Mosquitto container, we need to provide a config for the Zigbee2MQTT application before starting it up.
And again we can have a look at our <a href=https://sequr.be/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">Docker setup</a> for this.</p><p>Since Nginx is using port 8080, which is the default port for the Zigbee2MQTT dashboard, we tell Z2M to use a different port.</p><p><code>/srv/hass/zigbee/configuration.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Adapter settings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>serial</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>/dev/zigbee</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MQTT</span>
</span></span><span style=display:flex><span><span style=color:#f92672>mqtt</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>base_topic</span>: <span style=color:#ae81ff>zigbee2mqtt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>: <span style=color:#e6db74>&#39;!secret server&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>user</span>: <span style=color:#e6db74>&#39;!secret user&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#39;!secret password&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>client_id</span>: <span style=color:#ae81ff>zigbee</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Zigbee network</span>
</span></span><span style=display:flex><span><span style=color:#f92672>permit_join</span>: <span style=color:#66d9ef>false</span> <span style=color:#75715e># Do not allow random devices to connect automatically</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Webserver</span>
</span></span><span style=display:flex><span><span style=color:#f92672>frontend</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#39;http://10.0.2.2:8081&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Devices and groups</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extract config to separate files</span>
</span></span><span style=display:flex><span><span style=color:#f92672>devices</span>: <span style=color:#ae81ff>devices.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>groups</span>: <span style=color:#ae81ff>groups.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Home Assistant integration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>homeassistant</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>advanced</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Zigbee network - auto-generate new keys</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pan_id</span>: <span style=color:#ae81ff>GENERATE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>network_key</span>: <span style=color:#ae81ff>GENERATE</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Zigbee network - set channel to avoid interference with 2.4GHz WiFi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>channel</span>: <span style=color:#ae81ff>24</span>
</span></span></code></pre></div><p>I haven&rsquo;t found a method to store the secrets mentioned in the config above as a Podman secret.
The issue is that secrets are mounted at <code>/run/secrets/secretname</code> and Z2M expects the file to be named <code>secret.yaml</code> and be stored in the same folder as <code>configuration.yaml</code>.
So for the moment, I store the secrets file next to the configuration file in the config folder.</p><p>I hope a change to <a href=https://github.com/Koenkk/zigbee2mqtt/issues/15226 title="Github issue @ Z2M - [Feature request]: Allow defining location of secret.yaml #15226" target=_blank rel=noopener>Zigbee2MQTT</a> or <a href=https://github.com/containers/podman/issues/16649 title="Github issue @ podman - [FEATURE REQUEST] Mount secret at different location #16649" target=_blank rel=noopener>Podman</a> can help fix this.</p><p><code>/srv/hass/zigbee/secret.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>: <span style=color:#e6db74>&#39;mqtt://10.0.2.2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>user</span>: <span style=color:#e6db74>&#39;mqtt_z2m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>password</span>: <span style=color:#e6db74>&#39;MySuperSecretPa$$w0rd&#39;</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to change the <code>device</code> path in the config below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /dev/serial/by-id/
</span></span><span style=display:flex><span>usb-ITead_Sonoff_Zigbee_3.0_USB_Dongle_Plus_eexxx52-if00-port0 -&gt; ../../ttyUSB0
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zigbee.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Zigbee2MQTT</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>z2m-creds</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>z2m-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>zigbee</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--device</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>serial</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>by-id</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usb-ITead_Sonoff_Zigbee_3</span>.<span style=color:#ae81ff>0</span><span style=color:#a6e22e>_USB_Dongle_Plus_ee6789cf0260ec11ba5a345f25bfaa52-if00-port0</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>rw</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>z2m-creds</span>,<span style=color:#a6e22e>target</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>yaml</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>8081</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8081</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>koenkk</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee2mqtt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>z2m-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>We pass our credentials via the <code>--secret</code> and give it a path, and tell the service it needs to wait for the Mosquitto service to have started.</p><p>Then again, start the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-zigbee.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-zigbee.service → /var/home/hass/.config/systemd/user/container-zigbee.service.
</span></span></code></pre></div><p>Don&rsquo;t forget to check out the <a href=https://sequr.be/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">previous blog post on Zigbee2MQTT</a> for the automations and dashboard config to make the most out of Z2M.</p><h3 id=zwave2mqtt>ZWave2MQTT <a href=#zwave2mqtt>¶</a></h3><p>I&rsquo;m copying this from Matthew&rsquo;s forum post as I don&rsquo;t use Z-Wave myself.</p><p>See also the notes on <em>Container permissions and SELinux</em> in the Zigbee2MQTT section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/zwave
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zwave.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>ZWave2MQTT</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>zwave</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--device</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>serial</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>by-id</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usb-Silicon_Labs_Zooz_ZST10</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#a6e22e>u00A0700_Z-Wave_Stick_0001-if00-port0</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwave</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>rw</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwave</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>store</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>8091</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8091</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>3000</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>3000</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwavejs</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwavejs2mqtt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Start the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-zigbee.service
</span></span></code></pre></div><h3 id=esphome>ESPHome <a href=#esphome>¶</a></h3><p>Here&rsquo;re we&rsquo;re leaving Matthew&rsquo;s forum post as he didn&rsquo;t discuss setting up ESPHome.
Luckily, we already did the heavy lifting <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-9-esphome/ title="Part 9: ESPHome">before</a>.</p><p><code>~/.config/systemd/user/container-esphome.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>ESPHome</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>esphome</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>host</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Create the directory for the esphome config and enable the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/esphome
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl --user enable --now container-esphome.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-esphome.service → /var/home/hass/.config/systemd/user/container-esphome.service.
</span></span></code></pre></div><p>Now you can access the ESPHome Dashboard at <code>http://&lt;ip.of.your.system>:6052</code>.</p><p>In my case, it even discovered (and allowed me to adopt) a bluetooth proxy I still had on my network from before my system crash.</p><figure class=center><img src=esphome_dashboard.png alt="ESPHome Dashboard"><figcaption class=center>ESPHome Dashboard</figcaption></figure><h3 id=hass-configurator>HASS Configurator <a href=#hass-configurator>¶</a></h3><p>Editing configuration files from within the browser is a lot more user friendly than having to SSH into our system each time, so lets set up <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-6-editing-configuration.yaml-from-within-home-assistant/ title="Part 6: Editing configuration.yaml from within Home Assistant">HASS Configurator</a> again.</p><p><code>~/.config/systemd/user/container-hassconf.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>HASSConfigurator</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>hassconf</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hassconf</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>hass-config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>hass-config</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>3218</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>3218</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>causticlab</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass-configurator-docker</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we&rsquo;re mounting the config folders from our Home Assistant and ESPHome containers.
Make sure you marked these volumes as shared (<code>:z</code>) in their respective configurations.</p><p>We also want set our &ldquo;working directory&rdquo; in HASS Configurator to our Home Assistant config folder.</p><p><code>/srv/hass/hassconf/settings.conf</code> (you will need to create the directory first)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;BASEPATH&#34;</span>: <span style=color:#e6db74>&#34;/hass-config&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;ENFORCE_BASEPATH&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;DIRSFIRST&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Enable the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-hassconf.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-hassconf.service → /var/home/hass/.config/systemd/user/container-hassconf.service.
</span></span></code></pre></div><h2 id=sidebar>Sidebar <a href=#sidebar>¶</a></h2><p>Time to repeat ourselves <a href=https://sequr.be/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/#manage-portainer-from-within-home-assistant title="Home Assistant sidebar">yet again</a> and setup our sidebar.</p><p><strong>Note:</strong> This has changed since <a href=https://www.home-assistant.io/blog/2024/04/03/release-20244/#webpage-dashboard title="2024.4 release notes - webpage dashboard" target=_blank rel=noopener>Home Assistant 2024.4</a>.
You can now use a <a href=https://www.home-assistant.io/dashboards/dashboards/#webpage-dashboard title="Webpage dashboard" target=_blank rel=noopener>Webpage Dashboard</a> to embed a webpage in your dashboard.</p><p><del>The config below needs to end up in the <code>configuration.yaml</code> inside the Home Assistant config folder (<code>/srv/hass/hass</code>).</del>
<del>You can do this through our freshly launched HASS Configurator or over SSH.</del></p><p><code>/srv/hass/hass/configuration.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Outdated, use web dashboard</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>panel_iframe</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>configurator</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Configurator</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:wrench</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:3218</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>ESPHome</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:chip</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:6052</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>zigbee2mqtt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Zigbee2MQTT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:zigbee</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:8081</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Note that you need to use the address you would use to visit these containers directly from your desktop/laptop since this uses iframes.
You can&rsquo;t use the podman-internal addresses (like <code>10.0.2.2</code>).
However, you could setup nginx as a reverse proxy for these as well, even give them a(n internal) domain name and a SSL certificate, and then reference that address in this config.</p><p>Confirm using the DevTools that we didn&rsquo;t make a typo and restart Home Assistant to apply the config.</p><figure class=center><img src=devtools_restart.png alt="DevTools check configuration"><figcaption class=center>No errors</figcaption></figure><h2 id=backups>Backups <a href=#backups>¶</a></h2><p>The process for backing your config is fairly easy as everything is located at <code>/srv/hass</code> and <code>~/.config/systemd/user/container-*.service</code>.
You can setup a cronjob doing an <a href=https://linuxconfig.org/how-to-create-incremental-backups-using-rsync-on-linux title="How to create incremental backups using rsync on Linux" target=_blank rel=noopener>rsync backup</a> that archives and copies these files to a NAS, for example.
you&rsquo;ll need to do this as a root user so you don&rsquo;t run into permission issues with the container volumes.</p><blockquote><p>There is however one notable exception: if you want to avoid the possibility of backing up <code>home-assistant_v2.db</code> when it&rsquo;s in a not-settled state (possibly leading to corruption and losing your state history), you should periodically run something like</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;vacuum into &#34;/src/hass/backup/home-assistant_v2-bak.db&#34;&#39;</span> | sqlite3 /srv/hass/hass/home-assistant_v2.db
</span></span></code></pre></div><h3 id=backup-to-nas-over-nfs>Backup to NAS over NFS <a href=#backup-to-nas-over-nfs>¶</a></h3><p>Below are my configurations for backing up my Podman containers to my NAS over NFS.</p><h4 id=mount-backup-folder>Mount backup folder <a href=#mount-backup-folder>¶</a></h4><p>Setup a share on your NAS and grant NFS permissions to the IP of your Podman system.</p><p>Then create the following systemd mount config.
The filename must match your local mount path (<code>Where</code>) using hyphens instead of slashes.</p><p><strong>Note</strong> <code>/mnt</code> is symlinked to <code>/var/mnt</code> on my Fedora CoreOS system and I needed to uses that path.
Otherwise I got symbolic link errors.</p><p><code>/etc/systemd/system/var-mnt-backup.mount</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>HomeAssistant</span> <span style=color:#a6e22e>Backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Mount</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>What</span>=<span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>of</span>.<span style=color:#a6e22e>my</span>.<span style=color:#a6e22e>nas</span><span style=color:#960050;background-color:#1e0010>&gt;:/</span><span style=color:#a6e22e>volume1</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Where</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>var</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mnt</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>nfs</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Options</span>=<span style=color:#a6e22e>_netdev</span>,<span style=color:#a6e22e>auto</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>multi-user</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start var-mnt-backup.mount
</span></span><span style=display:flex><span>sudo systemctl enable var-mnt-backup.mount
</span></span><span style=display:flex><span>Created symlink /etc/systemd/system/multi-user.target.wants/var-mnt-backup.mount → /etc/systemd/system/var-mnt-backup.mount.
</span></span></code></pre></div><h4 id=backup-script>Backup script <a href=#backup-script>¶</a></h4><p>The following script will use <code>rsync</code> to create an incremental backup.
I also added the <code>vacuum</code> command mentioned above to &ldquo;copy&rdquo; the database. That&rsquo;s why I&rsquo;m ignoring the database in the rsync command.</p><p><code>/var/home/core/backup-podman.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># A script to perform incremental backups using rsync</span>
</span></span><span style=display:flex><span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>readonly SOURCE_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/srv/hass&#34;</span>
</span></span><span style=display:flex><span>readonly BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/mnt/backup&#34;</span>
</span></span><span style=display:flex><span>readonly DATETIME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d_%H:%M&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>readonly BACKUP_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>DATETIME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>readonly LATEST_LINK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/latest&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;----- BACKUP STARTED -----&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -av --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SOURCE_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --link-dest <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;home-assistant_v2.db&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.cache&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;log&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*.log&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.esphome&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Recreating link&#34;</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ln -rs <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy database</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Copying database&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;vacuum into \&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>/hass/home-assistant_v2.db\&#34;&#34;</span> | sqlite3 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SOURCE_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/hass/home-assistant_v2.db&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;----- BACKUP DONE -----&#34;</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to make this script executable and test it out.
Run as root so you don&rsquo;t get permission errors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>chmod u+x /var/home/core/backup-podman.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo /var/home/core/backup-podman.sh
</span></span></code></pre></div><h4 id=crontab>Crontab <a href=#crontab>¶</a></h4><p>Now we&rsquo;ll create a cronjob that will automatically call the back-up script on a weekly basis.
This will ensure we have weekly back-ups of our config.</p><p>But first we need to install the <code>cronie</code> package which will provide us with <code>cron</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rpm-ostree install cronie
</span></span><span style=display:flex><span>sudo rpm-ostree apply-live
</span></span></code></pre></div><p>Then we can write our cronjob.</p><p><code>/etc/crontab</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>SHELL=/bin/bash
</span></span><span style=display:flex><span>PATH=/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style=display:flex><span>MAILTO=core
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># For details see man 4 crontabs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Example of job definition:
</span></span><span style=display:flex><span># .---------------- minute (0 - 59)
</span></span><span style=display:flex><span># | .------------- hour (0 - 23)
</span></span><span style=display:flex><span># | | .---------- day of month (1 - 31)
</span></span><span style=display:flex><span># | | | .------- month (1 - 12) OR jan,feb,mar,apr ...
</span></span><span style=display:flex><span># | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
</span></span><span style=display:flex><span># | | | | |
</span></span><span style=display:flex><span># * * * * * user-name command to be executed
</span></span><span style=display:flex><span>0 22 * * 6 root /var/home/core/backup-podman.sh &gt; /dev/null
</span></span></code></pre></div><p>This will execute the <code>backup-podman.sh</code> script as root every Saturday at 22:00 (before the auto-update reboot window).
<code>stdout</code> output will be ignored, only error output (<code>stderr</code>) will be mailed to the <code>core</code> user.</p><h2 id=troubleshooting>Troubleshooting <a href=#troubleshooting>¶</a></h2><h3 id=i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service <a href=#i-made-changes-to-a-service-file-after-starting-a-service>¶</a></h3><p>Run <code>systemctl --user daemon-reload</code> to load your changes.
Then run <code>systemctl --user restart &lt;SERVICE>.service</code> to restart the service using the new config.</p><h3 id=i-cant-modify-container-files>I can&rsquo;t modify container files <a href=#i-cant-modify-container-files>¶</a></h3><p>Containers will be running using their own user inside the container.
The UserID of that user may not match the UserID of your user.
Rootless containers don&rsquo;t map the user account to e.g. root.</p><p>So if you want to change a file in one of the container&rsquo;s volumes and can&rsquo;t or don&rsquo;t want to do it via the terminal/console of the container,
you&rsquo;ll need to SSH into your sudo user (e.g. <code>core</code>) and use root privileges to change the files.
If you&rsquo;re creating new files using the root account (via sudo), their permissions will be mapped to root.
So don&rsquo;t forget to <code>chown</code> these files to the correct userID (check the permissions of the folder or other files within the folder using <code>ls -l</code>).</p><h3 id=error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY <a href=#error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>¶</a></h3><p>Podman doesn&rsquo;t have a default container registry configured.
So if you use the short name of a container, like <code>eclipse/mosquitto</code>, it doesn&rsquo;t know which registry you want to pull it from.</p><p>Either use the full link to the container, such as <code>docker.io/eclipse/mosquitto</code>, or add your preferred registry/registries to your Podman <code>registries.conf</code>.
The user config is located at <code>$HOME/.config/containers/registries.conf</code> and the system config is located at <code>/etc/containers/registries.conf</code>.</p><p>Edit or add the following line to suit your needs:<br><code>unqualified-search-registries = ['docker.io', 'registry.fedoraproject.org', 'registry.access.redhat.com', 'registry.centos.org', 'quay.io', 'ghcr.io']</code></p><h3 id=checkmodule-command-not-found>checkmodule: command not found <a href=#checkmodule-command-not-found>¶</a></h3><p>Your linux installation may not come with this tool installed.
To get the <code>checkmodule</code> tool, install the <code>checkpolicy</code> package using your distro&rsquo;s package manager.</p><p>Fedora CoreOS seems to be built a bit different and doesn&rsquo;t have the <code>yum</code> or <code>dnf</code> package managers installed.
Instead it uses <code>RPM-OStree</code>.
Package installations are more like a pull request in the system config where you need to get the new code and apply it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ rpm-ostree install checkpolicy
</span></span><span style=display:flex><span><span style=color:#f92672>====</span> AUTHENTICATING FOR org.projectatomic.rpmostree1.install-uninstall-packages <span style=color:#f92672>====</span>
</span></span><span style=display:flex><span>Authentication is required to install and remove software
</span></span><span style=display:flex><span>Authenticating as: CoreOS Admin <span style=color:#f92672>(</span>core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span><span style=color:#f92672>====</span> AUTHENTICATION COMPLETE <span style=color:#f92672>====</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>Added:
</span></span><span style=display:flex><span>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span style=display:flex><span>Changes queued <span style=color:#66d9ef>for</span> next boot. Run <span style=color:#e6db74>&#34;systemctl reboot&#34;</span> to start a reboot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo rpm-ostree apply-live
</span></span><span style=display:flex><span>Computing /etc diff to preserve... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Updating /usr... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Updating /etc... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Running systemd-tmpfiles <span style=color:#66d9ef>for</span> /run and /var... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Added:
</span></span><span style=display:flex><span>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span style=display:flex><span>Successfully updated running filesystem tree.
</span></span></code></pre></div><h3 id=selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts <a href=#selinux-permission-issues-with-device-mounts>¶</a></h3><p>If you run into permissions issues when you&rsquo;re trying to mount devices like a Zigbee controller, there are 2 solutions which may fix the issue.
Note that these open up the permissions on your system and thus will reduce the security of your system somewhat.</p><ol><li><p>Allow all containers to access all devices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo semanage boolean -m --on container_use_devices
</span></span></code></pre></div></li><li><p>The drastic solution of disabling SELinux:<br>To disable SELinux intil the next reboot, execute the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo setenforce <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Permanently disabeling SELinux can be done by modifying <code>/etc/selinux/config</code> and changing <code>SELINUX=enforcing</code> to <code>SELINUX=permissive</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sed -i <span style=color:#e6db74>&#39;s/=enforcing/=permissive/&#39;</span> /etc/selinux/config
</span></span></code></pre></div></li></ol><h2 id=changelog>Changelog <a href=#changelog>¶</a></h2><ul><li><strong>2022-12-03</strong><ul><li>Added explanation on permanently disabeling SELinux</li></ul></li><li><strong>2023-04-05</strong><ul><li>Fix <code>sudo semodule -i container-usbtty.pp</code> instead of <code>container-usbtty.pp</code></li></ul></li><li><strong>2023-04-17</strong><ul><li>Remove <code>certbot-creds</code> in <code>ExecStopPost</code> otherwise you get errors/warning about a secret already existing</li></ul></li><li><strong>2024-09-05</strong><ul><li>Reference Webpage dashboard replacing <code>iframe_panel</code> since 2024.04</li></ul></li></ul></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-automation/>Home Automation</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/home-assistant/>Home Assistant</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/container/>Container</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/docker/>Docker</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/podman/>Podman</a></span>
<span rel=tag class="tag p-category"><a href=https://sequr.be/tags/fedora/>Fedora</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a class=p-category href=https://sequr.be/categories/home-automation/>Home Automation</a></span>
<span class=tag><a class=p-category href=https://sequr.be/categories/ha-container/>HA Container</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
5372 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<time class=dt-published datetime=2022-12-02T01:00:00+01:00>2022-12-02
</time>(Last updated: <time class=dt-updated datetime=2024-09-05T02:00:00+02:00>2024-09-05</time>)</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
<span rel=author class="p-author h-card">DezeStijn</span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
<span rel=bookmark class=u-url><a href=https://sequr.be/1758082616>https://sequr.be/1758082616</a></span></p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href=https://ko-fi.com/s4squatch target=_blank rel=noopener aria-label title="Buy me a coffee"><div class="resp-sharing-button resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f&amp;resubmit=true&amp;title=Home%20Assistant%20Container%20Part%2012%3a%20Migrating%20to%20Podman" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Home%20Assistant%20Container%20Part%2012%3a%20Migrating%20to%20Podman&amp;body=https%3a%2f%2fsequr.be%2fblog%2f2022%2f12%2fhome-assistant-container-part-12-migrating-to-podman%2f" target=_self rel=noopener aria-label title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div></div></a></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/><span class=button__icon>←</span>
<span class=button__text>Flashing NSPanel with Tasmota and NSPanel Lovelace UI</span>
</a></span><span class="button next"><a href=https://sequr.be/blog/2022/11/home-assistant-container-part-11-bluetooth-support/><span class=button__text>Home Assistant Container Part 11: Bluetooth support</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class="footer h-card"><div class=footer__inner><div class=footer__content><span>&copy; 2019</span>
<span><a class="p-name u-url" rel=me href=https://sequr.be/>DezeStijn</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>CC BY-NC-SA 4.0</a></span>
<span><a href=https://sequr.be/blog/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div></footer></div><script type=text/javascript src=https://sequr.be/bundle.min.e89fda0f29b95d33f6f4224dd9e5cf69d84aff3818be2b0d73e731689cc374261b016d17d46f8381962fb4a1577ba3017b1f23509d894f6e66431f988c00889e.js integrity="sha512-6J/aDym5XTP29CJN2eXPadhK/zgYvisNc+cxaJzDdCYbAW0X1G+DgZYvtKFXe6MBex8jUJ2JT25mQx+YjACIng=="></script></body></html>